#!/usr/bin/env python3
"""
Channel Forwarder –∑ polling (–æ–ø–∏—Ç—É–≤–∞–Ω–Ω—è)
–ü–µ—Ä–µ–≤—ñ—Ä—è—î –∫–∞–Ω–∞–ª–∏ –∫–æ–∂–Ω—ñ 30 —Å–µ–∫—É–Ω–¥
–û–ø—Ç–∏–º—ñ–∑–æ–≤–∞–Ω–æ –¥–ª—è Render.com
"""

import asyncio
import logging
import re
import aiohttp
import time
from telethon import TelegramClient
from telethon.sessions import StringSession
import os
import sys

logging.basicConfig(
    format='[%(levelname)s/%(asctime)s] %(message)s',
    level=logging.INFO
)
logger = logging.getLogger(__name__)

# –ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è –∑ environment variables
API_ID = os.getenv('TELEGRAM_API_ID')
API_HASH = os.getenv('TELEGRAM_API_HASH')
STRING_SESSION = os.getenv('TELEGRAM_SESSION')

SOURCE_CHANNELS = os.getenv('SOURCE_CHANNELS', 'UkraineAlarmSignal,war_monitor,napramok,ukrainsiypposhnik,radarzagrozi,povitryanatrivogaaa').split(',')
TARGET_CHANNEL = os.getenv('TARGET_CHANNEL', 'mapstransler')

# –°–ø–µ—Ü—ñ–∞–ª—å–Ω–∏–π –∫–∞–Ω–∞–ª –¥–ª—è –•–∞—Ä–∫—ñ–≤—â–∏–Ω–∏ (–æ–∫—Ä–µ–º–∏–π –ø–∞—Ä—Å–µ—Ä)
KHARKIV_CHANNEL = 'monitor1654'

# –Ü–Ω—Ç–µ—Ä–≤–∞–ª –æ–ø–∏—Ç—É–≤–∞–Ω–Ω—è (—Å–µ–∫—É–Ω–¥–∏)
POLL_INTERVAL = int(os.getenv('POLL_INTERVAL', '30'))

# –Ü–Ω—Ç–µ—Ä–≤–∞–ª –¥–µ–¥—É–ø–ª—ñ–∫–∞—Ü—ñ—ó (—Å–µ–∫—É–Ω–¥–∏) - 5 —Ö–≤–∏–ª–∏–Ω
DEDUP_INTERVAL = int(os.getenv('DEDUP_INTERVAL', '300'))

# –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –æ–±–æ–≤'—è–∑–∫–æ–≤–∏—Ö –∑–º—ñ–Ω–Ω–∏—Ö
if not API_ID or not API_HASH:
    logger.error("‚ùå TELEGRAM_API_ID —Ç–∞ TELEGRAM_API_HASH –æ–±–æ–≤'—è–∑–∫–æ–≤—ñ!")
    sys.exit(1)

if not STRING_SESSION:
    logger.error("‚ùå TELEGRAM_SESSION –æ–±–æ–≤'—è–∑–∫–æ–≤–∞!")
    sys.exit(1)

try:
    API_ID = int(API_ID)
except ValueError:
    logger.error("‚ùå TELEGRAM_API_ID –º–∞—î –±—É—Ç–∏ —á–∏—Å–ª–æ–º!")
    sys.exit(1)

# –°–ª–æ–≤–Ω–∏–∫ –¥–ª—è –∑–±–µ—Ä—ñ–≥–∞–Ω–Ω—è ID –æ—Å—Ç–∞–Ω–Ω—ñ—Ö –ø–µ—Ä–µ—Å–ª–∞–Ω—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å
last_message_ids = {}

# –ö–µ—à –¥–ª—è –¥–µ–¥—É–ø–ª—ñ–∫–∞—Ü—ñ—ó –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å (–º—ñ—Å—Ç–æ -> timestamp)
sent_locations_cache = {}

# –ö–ª—ñ—î–Ω—Ç –∑ StringSession –¥–ª—è Render
client = TelegramClient(StringSession(STRING_SESSION), API_ID, API_HASH)


def normalize_location(message):
    """
    –í–∏—Ç—è–≥—É—î –∫–ª—é—á –ª–æ–∫–∞—Ü—ñ—ó –∑ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –¥–ª—è –¥–µ–¥—É–ø–ª—ñ–∫–∞—Ü—ñ—ó.
    –ù–∞–ø—Ä–∏–∫–ª–∞–¥: "–ë–ü–õ–ê –•–∞—Ä–∫—ñ–≤ (–•–∞—Ä–∫—ñ–≤—Å—å–∫–∞ –æ–±–ª.) –ó–∞–≥—Ä–æ–∑–∞..." -> "—Ö–∞—Ä–∫—ñ–≤_—Ö–∞—Ä–∫—ñ–≤—Å—å–∫–∞ –æ–±–ª."
    """
    # –®—É–∫–∞—î–º–æ –ø–∞—Ç—Ç–µ—Ä–Ω "–ú—ñ—Å—Ç–æ (–û–±–ª–∞—Å—Ç—å)"
    match = re.search(r'(?:–ë–ü–õ–ê\s+)?([^(]+)\s*\(([^)]+)\)', message)
    if match:
        city = match.group(1).strip().lower()
        region = match.group(2).strip().lower()
        # –í–∏–¥–∞–ª—è—î–º–æ –∑–∞–π–≤—ñ —Å–ª–æ–≤–∞
        city = re.sub(r'^\d+—Ö\s+', '', city)  # –í–∏–¥–∞–ª—è—î–º–æ "3—Ö " –Ω–∞ –ø–æ—á–∞—Ç–∫—É
        city = re.sub(r'^–±–ø–ª–∞\s+', '', city)  # –í–∏–¥–∞–ª—è—î–º–æ "–±–ø–ª–∞ " –Ω–∞ –ø–æ—á–∞—Ç–∫—É
        city = re.sub(r'\s+—Ä–∞–π–æ–Ω$', '', city)  # –í–∏–¥–∞–ª—è—î–º–æ " —Ä–∞–π–æ–Ω" –≤ –∫—ñ–Ω—Ü—ñ
        return f"{city}_{region}"
    return None


def is_duplicate(message):
    """
    –ü–µ—Ä–µ–≤—ñ—Ä—è—î —á–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è —î –¥—É–±–ª—ñ–∫–∞—Ç–æ–º (–≤–∂–µ –≤—ñ–¥–ø—Ä–∞–≤–ª—è–ª–æ—Å—å –∑–∞ –æ—Å—Ç–∞–Ω–Ω—ñ DEDUP_INTERVAL —Å–µ–∫—É–Ω–¥)
    """
    location_key = normalize_location(message)
    if not location_key:
        return False
    
    current_time = time.time()
    
    # –û—á–∏—â–∞—î–º–æ —Å—Ç–∞—Ä—ñ –∑–∞–ø–∏—Å–∏ –∑ –∫–µ—à—É
    keys_to_remove = [k for k, v in sent_locations_cache.items() if current_time - v > DEDUP_INTERVAL]
    for k in keys_to_remove:
        del sent_locations_cache[k]
    
    # –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ —î –≤ –∫–µ—à—ñ
    if location_key in sent_locations_cache:
        time_diff = current_time - sent_locations_cache[location_key]
        logger.info(f"‚è≠Ô∏è –ü—Ä–æ–ø—É—Å–∫ –¥—É–±–ª—ñ–∫–∞—Ç–∞: {location_key} (–±—É–ª–æ {int(time_diff)} —Å–µ–∫ —Ç–æ–º—É)")
        return True
    
    return False


def mark_as_sent(message):
    """
    –ü–æ–∑–Ω–∞—á–∞—î –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è —è–∫ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–µ
    """
    location_key = normalize_location(message)
    if location_key:
        sent_locations_cache[location_key] = time.time()
        logger.info(f"üìù –ó–±–µ—Ä–µ–∂–µ–Ω–æ –≤ –∫–µ—à: {location_key}")


# ==================== –ü–ê–†–°–ï–† –î–õ–Ø @monitor1654 (–•–∞—Ä–∫—ñ–≤—â–∏–Ω–∞) ====================

# –°–ª–æ–≤–Ω–∏–∫ –º—ñ—Å—Ç –•–∞—Ä–∫—ñ–≤—â–∏–Ω–∏ –¥–ª—è –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è –≤—ñ–¥–º—ñ–Ω–∫—ñ–≤
KHARKIV_CITIES = {
    '—Ö–∞—Ä–∫–æ–≤–∞': '–•–∞—Ä–∫—ñ–≤',
    '—Ö–∞—Ä–∫—ñ–≤': '–•–∞—Ä–∫—ñ–≤',
    '—ñ–∑—é–º–∞': '–Ü–∑—é–º',
    '—ñ–∑—é–º': '–Ü–∑—é–º',
    '–∫—É–ø\'—è–Ω—Å—å–∫–∞': '–ö—É–ø\'—è–Ω—Å—å–∫',
    '–∫—É–ø\'—è–Ω—Å—å–∫': '–ö—É–ø\'—è–Ω—Å—å–∫',
    '–ª–æ–∑–æ–≤–æ—ó': '–õ–æ–∑–æ–≤–∞',
    '–ª–æ–∑–æ–≤–∞': '–õ–æ–∑–æ–≤–∞',
    '—á—É–≥—É—î–≤–∞': '–ß—É–≥—É—ó–≤',
    '—á—É–≥—É—ó–≤': '–ß—É–≥—É—ó–≤',
    '–±–∞–ª–∞–∫–ª—ñ—ó': '–ë–∞–ª–∞–∫–ª—ñ—è',
    '–±–∞–ª–∞–∫–ª—ñ—è': '–ë–∞–ª–∞–∫–ª—ñ—è',
    '–≤–æ–≤—á–∞–Ω—Å—å–∫–∞': '–í–æ–≤—á–∞–Ω—Å—å–∫',
    '–≤–æ–≤—á–∞–Ω—Å—å–∫': '–í–æ–≤—á–∞–Ω—Å—å–∫',
    '–ø–µ—Ä–≤–æ–º–∞–π—Å—å–∫–æ–≥–æ': '–ü–µ—Ä–≤–æ–º–∞–π—Å—å–∫–∏–π',
    '–ø–µ—Ä–≤–æ–º–∞–π—Å—å–∫–∏–π': '–ü–µ—Ä–≤–æ–º–∞–π—Å—å–∫–∏–π',
    '–±–∞—Ä–≤—ñ–Ω–∫–æ–≤–æ–≥–æ': '–ë–∞—Ä–≤—ñ–Ω–∫–æ–≤–µ',
    '–±–∞—Ä–≤—ñ–Ω–∫–æ–≤–µ': '–ë–∞—Ä–≤—ñ–Ω–∫–æ–≤–µ',
    '–±–æ–≥–æ–¥—É—Ö–æ–≤–∞': '–ë–æ–≥–æ–¥—É—Ö—ñ–≤',
    '–±–æ–≥–æ–¥—É—Ö—ñ–≤': '–ë–æ–≥–æ–¥—É—Ö—ñ–≤',
    '–≤–µ–ª–∏–∫–æ–≥–æ –±—É—Ä–ª—É–∫–∞': '–í–µ–ª–∏–∫–∏–π –ë—É—Ä–ª—É–∫',
    '–≤–µ–ª–∏–∫–∏–π –±—É—Ä–ª—É–∫': '–í–µ–ª–∏–∫–∏–π –ë—É—Ä–ª—É–∫',
    '–¥–µ—Ä–≥–∞—á—ñ–≤': '–î–µ—Ä–≥–∞—á—ñ',
    '–¥–µ—Ä–≥–∞—á—ñ': '–î–µ—Ä–≥–∞—á—ñ',
    '–∑–º—ñ—ó–≤–∞': '–ó–º—ñ—ó–≤',
    '–∑–º—ñ—ó–≤': '–ó–º—ñ—ó–≤',
    '–∫—Ä–∞—Å–Ω–æ–≥—Ä–∞–¥–∞': '–ö—Ä–∞—Å–Ω–æ–≥—Ä–∞–¥',
    '–∫—Ä–∞—Å–Ω–æ–≥—Ä–∞–¥': '–ö—Ä–∞—Å–Ω–æ–≥—Ä–∞–¥',
    '–º–µ—Ä–µ—Ñ–∏': '–ú–µ—Ä–µ—Ñ–∞',
    '–º–µ—Ä–µ—Ñ–∞': '–ú–µ—Ä–µ—Ñ–∞',
    '–ª—é–±–æ—Ç–∏–Ω–∞': '–õ—é–±–æ—Ç–∏–Ω',
    '–ª—é–±–æ—Ç–∏–Ω': '–õ—é–±–æ—Ç–∏–Ω',
    '–ø\'—è—Ç–∏—Ö–∞—Ç–æ–∫': '–ü\'—è—Ç–∏—Ö–∞—Ç–∫–∏',
    '–ø\'—è—Ç–∏—Ö–∞—Ç–∫–∏': '–ü\'—è—Ç–∏—Ö–∞—Ç–∫–∏',
    '—Å–∞—Ö–Ω–æ–≤—â–∏–Ω–∏': '–°–∞—Ö–Ω–æ–≤—â–∏–Ω–∞',
    '—Å–∞—Ö–Ω–æ–≤—â–∏–Ω–∞': '–°–∞—Ö–Ω–æ–≤—â–∏–Ω–∞',
    '—à–µ–≤—á–µ–Ω–∫–æ–≤–æ–≥–æ': '–®–µ–≤—á–µ–Ω–∫–æ–≤–µ',
    '—à–µ–≤—á–µ–Ω–∫–æ–≤–µ': '–®–µ–≤—á–µ–Ω–∫–æ–≤–µ',
    '–∑–æ–ª–æ—á–µ–≤–∞': '–ó–æ–ª–æ—á—ñ–≤',
    '–∑–æ–ª–æ—á—ñ–≤': '–ó–æ–ª–æ—á—ñ–≤',
    '–ø–µ—á–µ–Ω—ñ–≥': '–ü–µ—á–µ–Ω—ñ–≥–∏',
    '–ø–µ—á–µ–Ω—ñ–≥–∏': '–ü–µ—á–µ–Ω—ñ–≥–∏',
    # –î–æ–¥–∞—Ç–∫–æ–≤—ñ –º—ñ—Å—Ç–∞/—Ä–∞–π–æ–Ω–∏
    '–≤—ñ–ª—å—Ö—ñ–≤–∫—É': '–í—ñ–ª—å—Ö—ñ–≤–∫–∞',
    '–≤—ñ–ª—å—Ö—ñ–≤–∫–∏': '–í—ñ–ª—å—Ö—ñ–≤–∫–∞',
    '–≤—ñ–ª—å—Ö—ñ–≤–∫–∞': '–í—ñ–ª—å—Ö—ñ–≤–∫–∞',
    '–±–∞–±–∞—ó': '–ë–∞–±–∞—ó',
    '–±–∞–±–∞—ó–≤': '–ë–∞–±–∞—ó',
    '—Ö–æ—Ä–æ—à–µ–≤–µ': '–•–æ—Ä–æ—à–µ–≤–µ',
    '—Ö–æ—Ä–æ—à–µ–≤–æ–≥–æ': '–•–æ—Ä–æ—à–µ–≤–µ',
    '–º–∞–ª—É —Ä–æ–≥–∞–Ω—å': '–ú–∞–ª–∞ –†–æ–≥–∞–Ω—å',
    '–º–∞–ª–æ—ó —Ä–æ–≥–∞–Ω—ñ': '–ú–∞–ª–∞ –†–æ–≥–∞–Ω—å',
    '–º–∞–ª–∞ —Ä–æ–≥–∞–Ω—å': '–ú–∞–ª–∞ –†–æ–≥–∞–Ω—å',
    '—Ä–æ–≥–∞–Ω—å': '–†–æ–≥–∞–Ω—å',
    '—Ä–æ–≥–∞–Ω—ñ': '–†–æ–≥–∞–Ω—å',
    '—Å–æ–ª–æ–Ω–∏—Ü—ñ–≤–∫—É': '–°–æ–ª–æ–Ω–∏—Ü—ñ–≤–∫–∞',
    '—Å–æ–ª–æ–Ω–∏—Ü—ñ–≤–∫–∏': '–°–æ–ª–æ–Ω–∏—Ü—ñ–≤–∫–∞',
    '—Å–æ–ª–æ–Ω–∏—Ü—ñ–≤–∫–∞': '–°–æ–ª–æ–Ω–∏—Ü—ñ–≤–∫–∞',
    '–ø—ñ—Å–æ—á–∏–Ω–∞': '–ü—ñ—Å–æ—á–∏–Ω',
    '–ø—ñ—Å–æ—á–∏–Ω': '–ü—ñ—Å–æ—á–∏–Ω',
    '–±–µ–∑–ª—é–¥—ñ–≤–∫—É': '–ë–µ–∑–ª—é–¥—ñ–≤–∫–∞',
    '–±–µ–∑–ª—é–¥—ñ–≤–∫–∏': '–ë–µ–∑–ª—é–¥—ñ–≤–∫–∞',
    '–±–µ–∑–ª—é–¥—ñ–≤–∫–∞': '–ë–µ–∑–ª—é–¥—ñ–≤–∫–∞',
    '—Ü–∏—Ä–∫—É–Ω–∏': '–¶–∏—Ä–∫—É–Ω–∏',
    '—Ü–∏—Ä–∫—É–Ω—ñ–≤': '–¶–∏—Ä–∫—É–Ω–∏',
    '—á–µ—Ä–∫–∞—Å—å–∫—É –ª–æ–∑–æ–≤—É': '–ß–µ—Ä–∫–∞—Å—å–∫–∞ –õ–æ–∑–æ–≤–∞',
    '—á–µ—Ä–∫–∞—Å—å–∫–∞ –ª–æ–∑–æ–≤–∞': '–ß–µ—Ä–∫–∞—Å—å–∫–∞ –õ–æ–∑–æ–≤–∞',
    '–ª–∏–ø—Ü—ñ': '–õ–∏–ø—Ü—ñ',
    '–ª–∏–ø—Ü—ñ–≤': '–õ–∏–ø—Ü—ñ',
    '–≤—ñ–ª—å—á–∞': '–í—ñ–ª—å—á–∞',
    '–≤—ñ–ª—å—á—É': '–í—ñ–ª—å—á–∞',
    # –ù–æ–≤—ñ –º—ñ—Å—Ç–∞ –∑ @monitor1654
    '—Ç–µ—Ä–Ω–æ–≤–æ—ó': '–¢–µ—Ä–Ω–æ–≤–∞',
    '—Ç–µ—Ä–Ω–æ–≤—É': '–¢–µ—Ä–Ω–æ–≤–∞',
    '—Ç–µ—Ä–Ω–æ–≤–∞': '–¢–µ—Ä–Ω–æ–≤–∞',
    '—Ö—Ç–∑': '–•–¢–ó',
    '–ø–µ—Ç—Ä—ñ–≤–∫—É': '–ü–µ—Ç—Ä—ñ–≤–∫–∞',
    '–ø–µ—Ç—Ä—ñ–≤–∫–∏': '–ü–µ—Ç—Ä—ñ–≤–∫–∞',
    '–ø–µ—Ç—Ä—ñ–≤–∫–∞': '–ü–µ—Ç—Ä—ñ–≤–∫–∞',
    '—Å—Ç–∞—Ä–æ–≥–æ —Å–∞–ª—Ç–æ–≤–∞': '–°—Ç–∞—Ä–∏–π –°–∞–ª—Ç—ñ–≤',
    '—Å—Ç–∞—Ä–∏–π —Å–∞–ª—Ç—ñ–≤': '–°—Ç–∞—Ä–∏–π –°–∞–ª—Ç—ñ–≤',
    '–≤—ñ–ª—å—à–∞–Ω–∏': '–í—ñ–ª—å—à–∞–Ω–∏',
    '–≤—ñ–ª—å—à–∞–Ω': '–í—ñ–ª—å—à–∞–Ω–∏',
    '–ø–µ—Ä–µ—Å—ñ—á–Ω–µ': '–ü–µ—Ä–µ—Å—ñ—á–Ω–µ',
    '–ø–µ—Ä–µ—Å—ñ—á–Ω–æ–≥–æ': '–ü–µ—Ä–µ—Å—ñ—á–Ω–µ',
    '–∞–Ω–¥—Ä—ñ—ó–≤–∫—É': '–ê–Ω–¥—Ä—ñ—ó–≤–∫–∞',
    '–∞–Ω–¥—Ä—ñ—ó–≤–∫–∏': '–ê–Ω–¥—Ä—ñ—ó–≤–∫–∞',
    '–∞–Ω–¥—Ä—ñ—ó–≤–∫–∞': '–ê–Ω–¥—Ä—ñ—ó–≤–∫–∞',
    '–¥–æ–Ω–µ—Ü—å': '–î–æ–Ω–µ—Ü—å',
    '–¥–æ–Ω—Ü—è': '–î–æ–Ω–µ—Ü—å',
    '–∫–æ—Ä–æ—Ç–∏—á': '–ö–æ—Ä–æ—Ç–∏—á',
    '–∫–æ—Ä–æ—Ç–∏—á–∞': '–ö–æ—Ä–æ—Ç–∏—á',
    '–¥–æ–≤–∂–∏–∫': '–î–æ–≤–∂–∏–∫',
    '–¥–æ–≤–∂–∏–∫–∞': '–î–æ–≤–∂–∏–∫',
    '–≤–∏—Å–æ–∫–∏–π': '–í–∏—Å–æ–∫–∏–π',
    '–≤–∏—Å–æ–∫–æ–≥–æ': '–í–∏—Å–æ–∫–∏–π',
    '–ø—ñ–≤–Ω—ñ—á–Ω—É —Å–∞–ª—Ç—ñ–≤–∫—É': '–ü—ñ–≤–Ω—ñ—á–Ω–∞ –°–∞–ª—Ç—ñ–≤–∫–∞',
    '–ø—ñ–≤–Ω—ñ—á–Ω–æ—ó —Å–∞–ª—Ç—ñ–≤–∫–∏': '–ü—ñ–≤–Ω—ñ—á–Ω–∞ –°–∞–ª—Ç—ñ–≤–∫–∞',
    '–ø—ñ–≤–Ω—ñ—á–Ω–∞ —Å–∞–ª—Ç—ñ–≤–∫–∞': '–ü—ñ–≤–Ω—ñ—á–Ω–∞ –°–∞–ª—Ç—ñ–≤–∫–∞',
    '—Å–∞–ª—Ç—ñ–≤–∫—É': '–°–∞–ª—Ç—ñ–≤–∫–∞',
    '—Å–∞–ª—Ç—ñ–≤–∫–∏': '–°–∞–ª—Ç—ñ–≤–∫–∞',
    '—Å–∞–ª—Ç—ñ–≤–∫–∞': '–°–∞–ª—Ç—ñ–≤–∫–∞',
    '–¥–≤—É—Ä–µ—á–Ω—É': '–î–≤—É—Ä–µ—á–Ω–∞',
    '–¥–≤—É—Ä–µ—á–Ω–æ—ó': '–î–≤—É—Ä–µ—á–Ω–∞',
    '–¥–≤—É—Ä–µ—á–Ω–∞': '–î–≤—É—Ä–µ—á–Ω–∞',
    '–≤–µ–ª–∏–∫—ñ –ø—Ä–æ—Ö–æ–¥–∏': '–í–µ–ª–∏–∫—ñ –ü—Ä–æ—Ö–æ–¥–∏',
    '–≤–µ–ª–∏–∫–∏—Ö –ø—Ä–æ—Ö–æ–¥—ñ–≤': '–í–µ–ª–∏–∫—ñ –ü—Ä–æ—Ö–æ–¥–∏',
    '–º–∞—Ä—Ç–æ–≤–µ': '–ú–∞—Ä—Ç–æ–≤–µ',
    '–º–∞—Ä—Ç–æ–≤–æ–≥–æ': '–ú–∞—Ä—Ç–æ–≤–µ',
    '–±–æ—Ä—ñ–≤—Å—å–∫–∞': '–ë–æ—Ä—ñ–≤—Å—å–∫–∞',
    '–±–æ—Ä—ñ–≤—Å—å–∫–æ—ó': '–ë–æ—Ä—ñ–≤—Å—å–∫–∞',
    '—Å—Ç–∞–Ω—Ü—ñ—é –±–æ—Ä—ñ–≤—Å—å–∫–∞': '–°—Ç–∞–Ω—Ü—ñ—è –ë–æ—Ä—ñ–≤—Å—å–∫–∞',
    '–∞–∫–∞–¥–µ–º—ñ–∫–∞ –±–∞—Ä–∞–±–∞—à–æ–≤–∞': '—Å—Ç.–º. –ê–∫–∞–¥–µ–º—ñ–∫–∞ –ë–∞—Ä–∞–±–∞—à–æ–≤–∞',
    '—Å—Ç.–º. –∞–∫–∞–¥–µ–º—ñ–∫–∞ –±–∞—Ä–∞–±–∞—à–æ–≤–∞': '—Å—Ç.–º. –ê–∫–∞–¥–µ–º—ñ–∫–∞ –ë–∞—Ä–∞–±–∞—à–æ–≤–∞',
    '—Å–æ–±–æ—Ä–Ω–æ—Å—Ç—ñ —É–∫—Ä–∞—ó–Ω–∏': '–≤—É–ª. –°–æ–±–æ—Ä–Ω–æ—Å—Ç—ñ –£–∫—Ä–∞—ó–Ω–∏',
    '–≤—É–ª. —Å–æ–±–æ—Ä–Ω–æ—Å—Ç—ñ —É–∫—Ä–∞—ó–Ω–∏': '–≤—É–ª. –°–æ–±–æ—Ä–Ω–æ—Å—Ç—ñ –£–∫—Ä–∞—ó–Ω–∏',
    '–∞–∫–∞–¥–µ–º—ñ–∫–∞ –ø–∞–≤–ª–æ–≤–∞': '–≤—É–ª. –ê–∫–∞–¥–µ–º—ñ–∫–∞ –ü–∞–≤–ª–æ–≤–∞',
    '–≤—É–ª. –∞–∫–∞–¥–µ–º—ñ–∫–∞ –ø–∞–≤–ª–æ–≤–∞': '–≤—É–ª. –ê–∫–∞–¥–µ–º—ñ–∫–∞ –ü–∞–≤–ª–æ–≤–∞',
    '—Ç—é—Ä–∏–Ω–∫–∞': '–¢—é—Ä–∏–Ω–∫–∞',
    '—Ç—é—Ä–∏–Ω–∫–∏': '–¢—é—Ä–∏–Ω–∫–∞',
    '604-–π –º—ñ–∫—Ä–æ—Ä–∞–π–æ–Ω': '604-–π –º—ñ–∫—Ä–æ—Ä–∞–π–æ–Ω',
    '604-–≥–æ –º—ñ–∫—Ä–æ—Ä–∞–π–æ–Ω—É': '604-–π –º—ñ–∫—Ä–æ—Ä–∞–π–æ–Ω',
    '—Ö–æ–ª–æ–¥–Ω—É –≥–æ—Ä—É': '–•–æ–ª–æ–¥–Ω–∞ –ì–æ—Ä–∞',
    '—Ö–æ–ª–æ–¥–Ω–æ—ó –≥–æ—Ä–∏': '–•–æ–ª–æ–¥–Ω–∞ –ì–æ—Ä–∞',
    '—Ö–æ–ª–æ–¥–Ω–∞ –≥–æ—Ä–∞': '–•–æ–ª–æ–¥–Ω–∞ –ì–æ—Ä–∞',
    '–æ–ª–µ–∫—Å—ñ—ó–≤–∫—É': '–û–ª–µ–∫—Å—ñ—ó–≤–∫–∞',
    '–æ–ª–µ–∫—Å—ñ—ó–≤–∫–∏': '–û–ª–µ–∫—Å—ñ—ó–≤–∫–∞',
    '–æ–ª–µ–∫—Å—ñ—ó–≤–∫–∞': '–û–ª–µ–∫—Å—ñ—ó–≤–∫–∞',
    '–ø–∞–≤–ª–æ–≤–µ –ø–æ–ª–µ': '–ü–∞–≤–ª–æ–≤–µ –ü–æ–ª–µ',
    '–ø–∞–≤–ª–æ–≤–æ–≥–æ –ø–æ–ª—è': '–ü–∞–≤–ª–æ–≤–µ –ü–æ–ª–µ',
    '–Ω–æ–≤—É –±–∞–≤–∞—Ä—ñ—é': '–ù–æ–≤–∞ –ë–∞–≤–∞—Ä—ñ—è',
    '–Ω–æ–≤—ñ–π –±–∞–≤–∞—Ä—ñ—ó': '–ù–æ–≤–∞ –ë–∞–≤–∞—Ä—ñ—è',
    '–Ω–æ–≤–∞ –±–∞–≤–∞—Ä—ñ—è': '–ù–æ–≤–∞ –ë–∞–≤–∞—Ä—ñ—è',
    '–Ω–æ–≤–æ—Å–µ–ª—ñ–≤–∫—É': '–ù–æ–≤–æ—Å–µ–ª—ñ–≤–∫–∞',
    '–Ω–æ–≤–æ—Å–µ–ª—ñ–≤–∫–∏': '–ù–æ–≤–æ—Å–µ–ª—ñ–≤–∫–∞',
    '–Ω–æ–≤–æ—Å–µ–ª—ñ–≤–∫–∞': '–ù–æ–≤–æ—Å–µ–ª—ñ–≤–∫–∞',
    '–æ—Å–Ω–æ–≤—É': '–û—Å–Ω–æ–≤–∞',
    '–æ—Å–Ω–æ–≤–∏': '–û—Å–Ω–æ–≤–∞',
    '–æ—Å–Ω–æ–≤–∞': '–û—Å–Ω–æ–≤–∞',
    '–∂–∏—Ö–æ—Ä': '–ñ–∏—Ö–æ—Ä',
    '–∂–∏—Ö–æ—Ä–∞': '–ñ–∏—Ö–æ—Ä',
}


def fix_kharkiv_city_case(city):
    """
    –í–∏–ø—Ä–∞–≤–ª—è—î –≤—ñ–¥–º—ñ–Ω–æ–∫ –Ω–∞–∑–≤–∏ –º—ñ—Å—Ç–∞ –•–∞—Ä–∫—ñ–≤—â–∏–Ω–∏ –Ω–∞ –Ω–∞–∑–∏–≤–Ω–∏–π
    """
    if not city:
        return city
    
    city_lower = city.lower().strip()
    if city_lower in KHARKIV_CITIES:
        return KHARKIV_CITIES[city_lower]
    
    # –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–µ –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è –≤—ñ–¥–º—ñ–Ω–∫—ñ–≤
    return fix_city_case(city)


async def parse_kharkiv_message(text):
    """
    –ü–∞—Ä—Å–∏—Ç—å –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∑ –∫–∞–Ω–∞–ª—É @monitor1654 (–•–∞—Ä–∫—ñ–≤—â–∏–Ω–∞)
    –ü–æ–≤–µ—Ä—Ç–∞—î —Å–ø–∏—Å–æ–∫ –≤—ñ–¥—Ñ–æ—Ä–º–∞—Ç–æ–≤–∞–Ω–∏—Ö –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å
    """
    if not text:
        return []
    
    text = clean_text(text)
    messages = []
    
    # –ü—Ä–æ–ø—É—Å–∫–∞—î–º–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø—Ä–æ —Ç—Ä–∏–≤–æ–≥–∏ —Ç–∞ –≤—ñ–¥–±–æ—ó
    if re.search(r'–ø–æ–≤—ñ—Ç—Ä—è–Ω–∞\s+—Ç—Ä–∏–≤–æ–≥–∞|–ø—Ä—è–º—É–π—Ç–µ\s+–≤\s+—É–∫—Ä–∏—Ç—Ç—è|–±—É–¥—å—Ç–µ\s+–æ–±–µ—Ä–µ–∂–Ω—ñ', text, re.IGNORECASE):
        return []
    
    # –ü—Ä–æ–ø—É—Å–∫–∞—î–º–æ –≤—ñ–¥–±—ñ–π –∑–∞–≥—Ä–æ–∑–∏
    if re.search(r'–≤—ñ–¥–±—ñ–π\s+–∑–∞–≥—Ä–æ–∑–∏', text, re.IGNORECASE):
        return []
    
    # –ü—Ä–æ–ø—É—Å–∫–∞—î–º–æ —Ä–µ–∫–ª–∞–º–Ω—ñ/—ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ–π–Ω—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
    if re.search(r'–ø—ñ–¥–ø–∏—Å–∞—Ç–∏—Å—è|–ø—ñ–¥—Ç—Ä–∏–º–∞—Ç–∏\s+–∫–∞–Ω–∞–ª|—Ä–µ–∫–ª–∞–º–∞|–¥–æ–Ω–∞—Ç|–∑–≤ º—è–∂—ñ—Ç—å—Å—è|@Monitor1654_bot', text, re.IGNORECASE):
        return []
    
    lines = text.strip().split('\n')
    
    for line in lines:
        line = line.strip()
        if not line:
            continue
        
        # –ü—Ä–æ–ø—É—Å–∫–∞—î–º–æ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ–π–Ω—ñ/—Å—Ç–∞—Ç—É—Å–Ω—ñ —Ä—è–¥–∫–∏
        if re.search(r'–ª–æ–∫–∞—Ü—ñ–π–Ω–æ\s+–Ω–µ\s+—Ñ—ñ–∫—Å—É—î—Ç—å—Å—è|–∑–∞–≥—Ä–æ–∑–∞\s+–∑–±–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è|–±—ñ–ª—å—à–µ\s+–Ω–µ\s+—Ñ—ñ–∫—Å—É—î—Ç—å—Å—è|–Ω–µ\s+—Ñ—ñ–∫—Å—É—î—Ç—å—Å—è|–≤–ø–∞–≤|–∞–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å\s+—Ç–∞–∫—Ç–∏—á–Ω–æ—ó|–Ω–∞\s+–¥–∞–Ω–∏–π\s+—á–∞—Å', line, re.IGNORECASE):
            continue
        
        # –ü—Ä–æ–ø—É—Å–∫–∞—î–º–æ —Ä—è–¥–∫–∏ –∑—ñ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ—é (üôè 123, ü§¨ 456 —Ç–æ—â–æ)
        if re.match(r'^[üôèü§¨üò°‚ù§üî•üò≠üëç‚ö°üïäüíîüëèü•∞üíØ\s\d]+$', line):
            continue
        
        # –ü—Ä–æ–ø—É—Å–∫–∞—î–º–æ views
        if re.search(r'\d+\.?\d*[Kk–ú–º]?views', line):
            continue
        
        # –ü—Ä–æ–ø—É—Å–∫–∞—î–º–æ —á–∞—Å–æ–≤—ñ –º—ñ—Ç–∫–∏
        if re.match(r'^\d{1,2}:\d{2}$', line):
            continue
        
        # –ü—Ä–æ–ø—É—Å–∫–∞—î–º–æ –Ω–∞–∑–≤—É –∫–∞–Ω–∞–ª—É
        if 'monitor 1654' in line.lower() or '—Ö–∞—Ä–∫—ñ–≤' in line.lower() and len(line) < 30:
            continue
        
        # –§–æ—Ä–º–∞—Ç: "–¶—ñ–ª—å –Ω–∞ –¢–µ—Ä–Ω–æ–≤—É" –∞–±–æ "–¶—ñ–ª—å –Ω–∞ –º—ñ—Å—Ç–æ"
        tsil_na_match = re.match(r'^[‚ùóÔ∏è‚ÄºÔ∏è‚ö†Ô∏è\s]*[–¶—Ü]—ñ–ª—å\s+–Ω–∞\s+(.+?)[‚ùóÔ∏è‚ÄºÔ∏è!\.]*$', line)
        if tsil_na_match:
            city = tsil_na_match.group(1).strip()
            if city.lower() == '–º—ñ—Å—Ç–æ':
                city = '–•–∞—Ä–∫—ñ–≤'
            else:
                city = fix_kharkiv_city_case(city)
            city = city[0].upper() + city[1:] if city else city
            msg = f"–ë–ü–õ–ê {city} (–•–∞—Ä–∫—ñ–≤—Å—å–∫–∞ –æ–±–ª.)"
            messages.append(msg)
            continue
        
        # –§–æ—Ä–º–∞—Ç: "–ù–∞ –•–¢–ó" –∞–±–æ "–ù–∞ –ü–µ—Ç—Ä—ñ–≤–∫—É" –∞–±–æ "–ù–∞ –º—ñ—Å—Ç–æ"
        na_city_match = re.match(r'^[‚ùóÔ∏è‚ÄºÔ∏è‚ö†Ô∏è\s]*[–ù–Ω]–∞\s+(.+?)[‚ùóÔ∏è‚ÄºÔ∏è!\.]*$', line)
        if na_city_match:
            city = na_city_match.group(1).strip()
            if city.lower() == '–º—ñ—Å—Ç–æ':
                city = '–•–∞—Ä–∫—ñ–≤'
            else:
                city = fix_kharkiv_city_case(city)
            city = city[0].upper() + city[1:] if city else city
            msg = f"–ë–ü–õ–ê {city} (–•–∞—Ä–∫—ñ–≤—Å—å–∫–∞ –æ–±–ª.)"
            messages.append(msg)
            continue
        
        # –§–æ—Ä–º–∞—Ç: "–î–∞–ª—ñ –Ω–∞ —Å—Ç.–º. –ê–∫–∞–¥–µ–º—ñ–∫–∞ –ë–∞—Ä–∞–±–∞—à–æ–≤–∞" –∞–±–æ "–î–∞–ª—ñ –Ω–∞ –•–æ—Ä–æ—à–µ–≤–µ" –∞–±–æ "–î–∞–ª—ñ –Ω–∞ –º—ñ—Å—Ç–æ"
        dali_na_match = re.match(r'^[‚ùóÔ∏è‚ÄºÔ∏è‚ö†Ô∏è\s]*[–î–¥]–∞–ª—ñ\s+–Ω–∞\s+(?:—Å—Ç\.–º\.?\s*|–≤—É–ª\.?\s*)?(.+?)[‚ùóÔ∏è‚ÄºÔ∏è!\.]*$', line)
        if dali_na_match:
            city = dali_na_match.group(1).strip()
            if city.lower() == '–º—ñ—Å—Ç–æ':
                city = '–•–∞—Ä–∫—ñ–≤'
            # –û–±—Ä–æ–±–∫–∞ –º–Ω–æ–∂–∏–Ω–Ω–∏—Ö –ª–æ–∫–∞—Ü—ñ–π —á–µ—Ä–µ–∑ /
            if '/' in city:
                cities = [c.strip() for c in city.split('/')]
                for c in cities:
                    c = fix_kharkiv_city_case(c)
                    c = c[0].upper() + c[1:] if c else c
                    msg = f"–ë–ü–õ–ê {c} (–•–∞—Ä–∫—ñ–≤—Å—å–∫–∞ –æ–±–ª.)"
                    messages.append(msg)
                continue
            city = fix_kharkiv_city_case(city)
            city = city[0].upper() + city[1:] if city else city
            msg = f"–ë–ü–õ–ê {city} (–•–∞—Ä–∫—ñ–≤—Å—å–∫–∞ –æ–±–ª.)"
            messages.append(msg)
            continue
        
        # –§–æ—Ä–º–∞—Ç: "–ö–ê–ë –Ω–∞ –¢–µ—Ä–Ω–æ–≤—É" –∞–±–æ "–ö–ê–ë –Ω–∞ –ö—É–ø'—è–Ω—Å—å–∫" –∞–±–æ "–ü–æ–≤—Ç–æ—Ä–Ω—ñ –ø—É—Å–∫–∏ –ö–ê–ë –Ω–∞ –¢–µ—Ä–Ω–æ–≤—É"
        kab_match = re.match(r'^[‚ùóÔ∏è‚ÄºÔ∏è‚ö†Ô∏è\s]*(?:–ü–æ–≤—Ç–æ—Ä–Ω—ñ\s+–ø—É—Å–∫–∏\s+)?–ö–ê–ë\s+–Ω–∞\s+(.+?)[‚ùóÔ∏è‚ÄºÔ∏è!\.]*$', line, re.IGNORECASE)
        if kab_match:
            city = kab_match.group(1).strip()
            city = fix_kharkiv_city_case(city)
            city = city[0].upper() + city[1:] if city else city
            msg = f"–ö–ê–ë {city} (–•–∞—Ä–∫—ñ–≤—Å—å–∫–∞ –æ–±–ª.)"
            messages.append(msg)
            continue
        
        # –§–æ—Ä–º–∞—Ç: "–ó–º—ñ–Ω–∏–ª–∞ –∫—É—Ä—Å –Ω–∞ –í–µ–ª–∏–∫–∏–π –ë—É—Ä–ª—É–∫" –∞–±–æ "–ó–º—ñ–Ω–∏–≤ –∫—É—Ä—Å –Ω–∞ –°—Ç–∞—Ä–∏–π –°–∞–ª—Ç—ñ–≤"
        zminyla_match = re.match(r'^[‚ùóÔ∏è‚ÄºÔ∏è‚ö†Ô∏è\s]*[–ó–∑]–º—ñ–Ω–∏–ª[–∞–æ–≤]?\s+–∫—É—Ä—Å\s+–Ω–∞\s+(.+?)[‚ùóÔ∏è‚ÄºÔ∏è!\.]*$', line)
        if zminyla_match:
            city = zminyla_match.group(1).strip()
            city = fix_kharkiv_city_case(city)
            city = city[0].upper() + city[1:] if city else city
            msg = f"–ë–ü–õ–ê {city} (–•–∞—Ä–∫—ñ–≤—Å—å–∫–∞ –æ–±–ª.)"
            messages.append(msg)
            continue
        
        # –§–æ—Ä–º–∞—Ç: "–ó–Ω–æ–≤—É —Ñ—ñ–∫—Å—É—î—Ç—å—Å—è –∫—É—Ä—Å–æ–º –Ω–∞ –ë–∞–±–∞—ó"
        znovu_match = re.match(r'^[‚ùóÔ∏è‚ÄºÔ∏è‚ö†Ô∏è\s]*[–ó–∑]–Ω–æ–≤—É\s+—Ñ—ñ–∫—Å—É—î—Ç—å—Å—è\s+–∫—É—Ä—Å–æ–º\s+–Ω–∞\s+(.+?)[‚ùóÔ∏è‚ÄºÔ∏è!\.]*$', line)
        if znovu_match:
            city = znovu_match.group(1).strip()
            city = fix_kharkiv_city_case(city)
            city = city[0].upper() + city[1:] if city else city
            msg = f"–ë–ü–õ–ê {city} (–•–∞—Ä–∫—ñ–≤—Å—å–∫–∞ –æ–±–ª.)"
            messages.append(msg)
            continue
        
        # –§–æ—Ä–º–∞—Ç: "–ë–ü–õ–ê —Ç–∏–ø—É "–®–∞—Ö–µ–¥" –∫—É—Ä—Å–æ–º –Ω–∞ –ë–æ–≥–æ–¥—É—Ö—ñ–≤" –∞–±–æ "+ 1 –ë–ü–õ–ê —Ç–∏–ø—É "–ú–æ–ª–Ω—ñ—è" –∫—É—Ä—Å–æ–º –Ω–∞ –í—ñ–ª—å—Ö—ñ–≤–∫—É"
        bpla_typu_match = re.match(r'^[+‚ùóÔ∏è‚ÄºÔ∏è‚ö†Ô∏è\s]*(\d+)?\s*(?:–ë–ü–õ–ê|–ë–ø–õ–ê)\s+—Ç–∏–ø—É\s*["\¬´]?([^"¬ª]+)["\¬ª]?\s*(?:–∫—É—Ä—Å–æ–º\s+–Ω–∞|–ø—Ä–æ–¥–æ–≤–∂—É—î\s+—Ä—É—Ö\s+–Ω–∞)\s+(.+?)[‚ùóÔ∏è‚ÄºÔ∏è!\.]*$', line, re.IGNORECASE)
        if bpla_typu_match:
            city = bpla_typu_match.group(3).strip()
            city = fix_kharkiv_city_case(city)
            city = city[0].upper() + city[1:] if city else city
            msg = f"–ë–ü–õ–ê {city} (–•–∞—Ä–∫—ñ–≤—Å—å–∫–∞ –æ–±–ª.)"
            messages.append(msg)
            continue
        
        # –§–æ—Ä–º–∞—Ç: "–ë–ü–õ–ê –Ω–µ–≤–∏–∑–Ω–∞—á–µ–Ω–æ–≥–æ —Ç–∏–ø—É –∫—É—Ä—Å–æ–º –Ω–∞ –†–æ–≥–∞–Ω—å" –∞–±–æ "–ë–ü–õ–ê –Ω–µ–≤–∏–∑–Ω–∞—á–µ–Ω–æ–≥–æ —Ç–∏–ø—É, –π–º–æ–≤—ñ—Ä–Ω–æ, —É–¥–∞—Ä–Ω–∏–π, –∫—É—Ä—Å–æ–º –Ω–∞ –®–µ–≤—á–µ–Ω–∫–æ–≤–µ"
        bpla_nevyzn_match = re.match(r'^[‚ùóÔ∏è‚ÄºÔ∏è‚ö†Ô∏è\s]*(?:–ë–ü–õ–ê|–ë–ø–õ–ê)\s+–Ω–µ–≤–∏–∑–Ω–∞—á–µ–Ω–æ–≥–æ\s+—Ç–∏–ø—É[^–∫]*–∫—É—Ä—Å–æ–º\s+–Ω–∞\s+(.+?)[‚ùóÔ∏è‚ÄºÔ∏è!\.]*$', line, re.IGNORECASE)
        if bpla_nevyzn_match:
            city = bpla_nevyzn_match.group(1).strip()
            city = fix_kharkiv_city_case(city)
            city = city[0].upper() + city[1:] if city else city
            msg = f"–ë–ü–õ–ê {city} (–•–∞—Ä–∫—ñ–≤—Å—å–∫–∞ –æ–±–ª.)"
            messages.append(msg)
            continue
        
        # –§–æ—Ä–º–∞—Ç: "‚ñ™Ô∏è1 –Ω–∞ –ü–µ—Ä–µ—Å—ñ—á–Ω–µ/–°–æ–ª–æ–Ω–∏—Ü—ñ–≤–∫—É" - bullet points
        bullet_match = re.match(r'^[‚ñ™Ô∏è‚Ä¢\s]*\d*\s*–Ω–∞\s+(.+?)[‚ùóÔ∏è‚ÄºÔ∏è!\.]*$', line, re.IGNORECASE)
        if bullet_match:
            city = bullet_match.group(1).strip()
            # –û–±—Ä–æ–±–∫–∞ –º–Ω–æ–∂–∏–Ω–Ω–∏—Ö –ª–æ–∫–∞—Ü—ñ–π —á–µ—Ä–µ–∑ /
            if '/' in city:
                cities = [c.strip() for c in city.split('/')]
                for c in cities:
                    c = fix_kharkiv_city_case(c)
                    c = c[0].upper() + c[1:] if c else c
                    msg = f"–ë–ü–õ–ê {c} (–•–∞—Ä–∫—ñ–≤—Å—å–∫–∞ –æ–±–ª.)"
                    messages.append(msg)
                continue
            city = fix_kharkiv_city_case(city)
            city = city[0].upper() + city[1:] if city else city
            msg = f"–ë–ü–õ–ê {city} (–•–∞—Ä–∫—ñ–≤—Å—å–∫–∞ –æ–±–ª.)"
            messages.append(msg)
            continue
        
        # –§–æ—Ä–º–∞—Ç: "–ó–∞–≥—Ä–æ–∑–∞ –¥–ª—è –ö–∏—ó–≤—Å—å–∫–æ–≥–æ/–°–∞–ª—Ç—ñ–≤—Å—å–∫–æ–≥–æ —Ä-–≤ –º—ñ—Å—Ç–∞"
        zagroza_rayoniv_match = re.match(r'^[‚ùóÔ∏è‚ÄºÔ∏è‚ö†Ô∏è\s]*[–ó–∑]–∞–≥—Ä–æ–∑–∞\s+–¥–ª—è\s+(.+?)\s+—Ä-–≤\s+–º—ñ—Å—Ç–∞[‚ùóÔ∏è‚ÄºÔ∏è!\.]*$', line)
        if zagroza_rayoniv_match:
            msg = f"–ë–ü–õ–ê –•–∞—Ä–∫—ñ–≤ (–•–∞—Ä–∫—ñ–≤—Å—å–∫–∞ –æ–±–ª.)"
            messages.append(msg)
            continue
        
        # –§–æ—Ä–º–∞—Ç: "–ë–ü–õ–ê –Ω–∞ –ú—ñ—Å—Ç–æ" –∞–±–æ "N—Ö –ë–ü–õ–ê –Ω–∞ –ú—ñ—Å—Ç–æ"
        bpla_na_match = re.match(r'^[üõ∏üõµ‚ö†Ô∏è‚ùóÔ∏èüî¥\s]*(\d+)?\s*—Ö?\s*(?:–ë–ü–õ–ê|–ë–ø–õ–ê|–±–ø–ª–∞)\s+(?:–Ω–∞|–≤\s+–Ω–∞–ø—Ä—è–º–∫—É|–∫—É—Ä—Å–æ–º\s+–Ω–∞)\s+(.+?)[‚ùóÔ∏è‚ÄºÔ∏è!\.]*$', line, re.IGNORECASE)
        if bpla_na_match:
            city = bpla_na_match.group(2).strip()
            city = fix_kharkiv_city_case(city)
            city = city[0].upper() + city[1:] if city else city
            msg = f"–ë–ü–õ–ê {city} (–•–∞—Ä–∫—ñ–≤—Å—å–∫–∞ –æ–±–ª.)"
            messages.append(msg)
            continue
    
    return messages


# ID –æ—Å—Ç–∞–Ω–Ω—å–æ–≥–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –¥–ª—è –∫–∞–Ω–∞–ª—É –•–∞—Ä–∫—ñ–≤—â–∏–Ω–∏
last_kharkiv_message_id = None


async def check_kharkiv_channel(target):
    """
    –ü–µ—Ä–µ–≤—ñ—Ä—è—î –∫–∞–Ω–∞–ª @monitor1654 –Ω–∞ –Ω–æ–≤—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
    """
    global last_kharkiv_message_id
    
    try:
        channel = await client.get_entity(KHARKIV_CHANNEL)
        
        # –û—Ç—Ä–∏–º—É—î–º–æ –æ—Å—Ç–∞–Ω–Ω—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
        messages = await client.get_messages(channel, limit=5)
        
        if not messages:
            return
        
        # –°–æ—Ä—Ç—É—î–º–æ –ø–æ ID (–≤—ñ–¥ —Å—Ç–∞—Ä–∏—Ö –¥–æ –Ω–æ–≤–∏—Ö)
        messages = sorted(messages, key=lambda m: m.id)
        
        for msg in messages:
            # –ü—Ä–æ–ø—É—Å–∫–∞—î–º–æ –≤–∂–µ –æ–±—Ä–æ–±–ª–µ–Ω—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
            if last_kharkiv_message_id and msg.id <= last_kharkiv_message_id:
                continue
            
            if not msg.text:
                last_kharkiv_message_id = msg.id
                continue
            
            logger.info(f"üì® [@{KHARKIV_CHANNEL}]: {msg.text[:100]}...")
            
            # –ü–∞—Ä—Å–∏–º–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è —Å–ø–µ—Ü—ñ–∞–ª—å–Ω–∏–º –ø–∞—Ä—Å–µ—Ä–æ–º
            parsed_messages = await parse_kharkiv_message(msg.text)
            
            for parsed_msg in parsed_messages:
                # –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –Ω–∞ –¥—É–±–ª—ñ–∫–∞—Ç
                if is_duplicate(parsed_msg):
                    continue
                
                try:
                    await client.send_message(target, parsed_msg)
                    mark_as_sent(parsed_msg)
                    logger.info(f"‚úÖ [@{KHARKIV_CHANNEL}] –í—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ: {parsed_msg}")
                except Exception as e:
                    logger.error(f"‚ùå –ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–ø—Ä–∞–≤–∫–∏: {e}")
            
            # –û–Ω–æ–≤–ª—é—î–º–æ ID –æ—Å—Ç–∞–Ω–Ω—å–æ–≥–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
            last_kharkiv_message_id = msg.id
            
    except Exception as e:
        logger.error(f"‚ùå –ü–æ–º–∏–ª–∫–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ @{KHARKIV_CHANNEL}: {e}")


# ==================== –ö–Ü–ù–ï–¶–¨ –ü–ê–†–°–ï–†–ê –î–õ–Ø @monitor1654 ====================


# –ú–∞–ø—ñ–Ω–≥ —Ä–µ–≥—ñ–æ–Ω—ñ–≤ –Ω–∞ —É–∫—Ä–∞—ó–Ω—Å—å–∫—É –º–æ–≤—É
REGION_MAP = {
    '–°—É–º—â–∏–Ω–∞': '–°—É–º—Å—å–∫–∞ –æ–±–ª.',
    '–°—É–º—â–∏–Ω–∏': '–°—É–º—Å—å–∫–∞ –æ–±–ª.',
    '–°—É–º—â–∏–Ω—É': '–°—É–º—Å—å–∫–∞ –æ–±–ª.',
    '–ß–µ—Ä–Ω—ñ–≥—ñ–≤—â–∏–Ω–∞': '–ß–µ—Ä–Ω—ñ–≥—ñ–≤—Å—å–∫–∞ –æ–±–ª.',
    '–ß–µ—Ä–Ω—ñ–≥—ñ–≤—â–∏–Ω–∏': '–ß–µ—Ä–Ω—ñ–≥—ñ–≤—Å—å–∫–∞ –æ–±–ª.',
    '–ß–µ—Ä–Ω—ñ–≥—ñ–≤—â–∏–Ω—É': '–ß–µ—Ä–Ω—ñ–≥—ñ–≤—Å—å–∫–∞ –æ–±–ª.',
    '–ü–æ–ª—Ç–∞–≤—â–∏–Ω–∞': '–ü–æ–ª—Ç–∞–≤—Å—å–∫–∞ –æ–±–ª.',
    '–ü–æ–ª—Ç–∞–≤—â–∏–Ω–∏': '–ü–æ–ª—Ç–∞–≤—Å—å–∫–∞ –æ–±–ª.',
    '–ü–æ–ª—Ç–∞–≤—â–∏–Ω—É': '–ü–æ–ª—Ç–∞–≤—Å—å–∫–∞ –æ–±–ª.',
    '–ß–µ—Ä–∫–∞—â–∏–Ω–∞': '–ß–µ—Ä–∫–∞—Å—å–∫–∞ –æ–±–ª.',
    '–ß–µ—Ä–∫–∞—â–∏–Ω–∏': '–ß–µ—Ä–∫–∞—Å—å–∫–∞ –æ–±–ª.',
    '–ß–µ—Ä–∫–∞—â–∏–Ω—É': '–ß–µ—Ä–∫–∞—Å—å–∫–∞ –æ–±–ª.',
    '–ö–∏—ó–≤—â–∏–Ω–∞': '–ö–∏—ó–≤—Å—å–∫–∞ –æ–±–ª.',
    '–ö–∏—ó–≤—â–∏–Ω–∏': '–ö–∏—ó–≤—Å—å–∫–∞ –æ–±–ª.',
    '–ö–∏—ó–≤—â–∏–Ω—É': '–ö–∏—ó–≤—Å—å–∫–∞ –æ–±–ª.',
    '–•–∞—Ä–∫—ñ–≤—â–∏–Ω–∞': '–•–∞—Ä–∫—ñ–≤—Å—å–∫–∞ –æ–±–ª.',
    '–•–∞—Ä–∫—ñ–≤—â–∏–Ω–∏': '–•–∞—Ä–∫—ñ–≤—Å—å–∫–∞ –æ–±–ª.',
    '–•–∞—Ä–∫—ñ–≤—â–∏–Ω—É': '–•–∞—Ä–∫—ñ–≤—Å—å–∫–∞ –æ–±–ª.',
    '–î–Ω—ñ–ø—Ä–æ–ø–µ—Ç—Ä–æ–≤—â–∏–Ω–∞': '–î–Ω—ñ–ø—Ä–æ–ø–µ—Ç—Ä–æ–≤—Å—å–∫–∞ –æ–±–ª.',
    '–î–Ω—ñ–ø—Ä–æ–ø–µ—Ç—Ä–æ–≤—â–∏–Ω–∏': '–î–Ω—ñ–ø—Ä–æ–ø–µ—Ç—Ä–æ–≤—Å—å–∫–∞ –æ–±–ª.',
    '–î–Ω—ñ–ø—Ä–æ–ø–µ—Ç—Ä–æ–≤—â–∏–Ω—É': '–î–Ω—ñ–ø—Ä–æ–ø–µ—Ç—Ä–æ–≤—Å—å–∫–∞ –æ–±–ª.',
    '–ú–∏–∫–æ–ª–∞—ó–≤—â–∏–Ω–∞': '–ú–∏–∫–æ–ª–∞—ó–≤—Å—å–∫–∞ –æ–±–ª.',
    '–ú–∏–∫–æ–ª–∞—ó–≤—â–∏–Ω–∏': '–ú–∏–∫–æ–ª–∞—ó–≤—Å—å–∫–∞ –æ–±–ª.',
    '–ú–∏–∫–æ–ª–∞—ó–≤—â–∏–Ω—É': '–ú–∏–∫–æ–ª–∞—ó–≤—Å—å–∫–∞ –æ–±–ª.',
    '–û–¥–µ—â–∏–Ω–∞': '–û–¥–µ—Å—å–∫–∞ –æ–±–ª.',
    '–û–¥–µ—â–∏–Ω–∏': '–û–¥–µ—Å—å–∫–∞ –æ–±–ª.',
    '–û–¥–µ—â–∏–Ω—É': '–û–¥–µ—Å—å–∫–∞ –æ–±–ª.',
    '–•–µ—Ä—Å–æ–Ω—â–∏–Ω–∞': '–•–µ—Ä—Å–æ–Ω—Å—å–∫–∞ –æ–±–ª.',
    '–•–µ—Ä—Å–æ–Ω—â–∏–Ω–∏': '–•–µ—Ä—Å–æ–Ω—Å—å–∫–∞ –æ–±–ª.',
    '–•–µ—Ä—Å–æ–Ω—â–∏–Ω—É': '–•–µ—Ä—Å–æ–Ω—Å—å–∫–∞ –æ–±–ª.',
    '–ó–∞–ø–æ—Ä—ñ–∑—å–∫–∞': '–ó–∞–ø–æ—Ä—ñ–∑—å–∫–∞ –æ–±–ª.',
    '–ó–∞–ø–æ—Ä—ñ–∂–∂—è': '–ó–∞–ø–æ—Ä—ñ–∑—å–∫–∞ –æ–±–ª.',
    '–î–æ–Ω–µ—á—á–∏–Ω–∞': '–î–æ–Ω–µ—Ü—å–∫–∞ –æ–±–ª.',
    '–î–æ–Ω–µ—á—á–∏–Ω–∏': '–î–æ–Ω–µ—Ü—å–∫–∞ –æ–±–ª.',
    '–î–æ–Ω–µ—á—á–∏–Ω—É': '–î–æ–Ω–µ—Ü—å–∫–∞ –æ–±–ª.',
    '–õ—É–≥–∞–Ω—â–∏–Ω–∞': '–õ—É–≥–∞–Ω—Å—å–∫–∞ –æ–±–ª.',
    '–õ—É–≥–∞–Ω—â–∏–Ω–∏': '–õ—É–≥–∞–Ω—Å—å–∫–∞ –æ–±–ª.',
    '–õ—É–≥–∞–Ω—â–∏–Ω—É': '–õ—É–≥–∞–Ω—Å—å–∫–∞ –æ–±–ª.',
    '–ñ–∏—Ç–æ–º–∏—Ä—â–∏–Ω–∞': '–ñ–∏—Ç–æ–º–∏—Ä—Å—å–∫–∞ –æ–±–ª.',
    '–ñ–∏—Ç–æ–º–∏—Ä—â–∏–Ω–∏': '–ñ–∏—Ç–æ–º–∏—Ä—Å—å–∫–∞ –æ–±–ª.',
    '–ñ–∏—Ç–æ–º–∏—Ä—â–∏–Ω—É': '–ñ–∏—Ç–æ–º–∏—Ä—Å—å–∫–∞ –æ–±–ª.',
    '–í—ñ–Ω–Ω–∏—á—á–∏–Ω–∞': '–í—ñ–Ω–Ω–∏—Ü—å–∫–∞ –æ–±–ª.',
    '–í—ñ–Ω–Ω–∏—á—á–∏–Ω–∏': '–í—ñ–Ω–Ω–∏—Ü—å–∫–∞ –æ–±–ª.',
    '–í—ñ–Ω–Ω–∏—á—á–∏–Ω—É': '–í—ñ–Ω–Ω–∏—Ü—å–∫–∞ –æ–±–ª.',
    '–•–º–µ–ª—å–Ω–∏—á—á–∏–Ω–∞': '–•–º–µ–ª—å–Ω–∏—Ü—å–∫–∞ –æ–±–ª.',
    '–•–º–µ–ª—å–Ω–∏—á—á–∏–Ω–∏': '–•–º–µ–ª—å–Ω–∏—Ü—å–∫–∞ –æ–±–ª.',
    '–•–º–µ–ª—å–Ω–∏—á—á–∏–Ω—É': '–•–º–µ–ª—å–Ω–∏—Ü—å–∫–∞ –æ–±–ª.',
    '–†—ñ–≤–Ω–µ–Ω—â–∏–Ω–∞': '–†—ñ–≤–Ω–µ–Ω—Å—å–∫–∞ –æ–±–ª.',
    '–†—ñ–≤–Ω–µ–Ω—â–∏–Ω–∏': '–†—ñ–≤–Ω–µ–Ω—Å—å–∫–∞ –æ–±–ª.',
    '–†—ñ–≤–Ω–µ–Ω—â–∏–Ω—É': '–†—ñ–≤–Ω–µ–Ω—Å—å–∫–∞ –æ–±–ª.',
    '–í–æ–ª–∏–Ω—å': '–í–æ–ª–∏–Ω—Å—å–∫–∞ –æ–±–ª.',
    '–í–æ–ª–∏–Ω—ñ': '–í–æ–ª–∏–Ω—Å—å–∫–∞ –æ–±–ª.',
    '–õ—å–≤—ñ–≤—â–∏–Ω–∞': '–õ—å–≤—ñ–≤—Å—å–∫–∞ –æ–±–ª.',
    '–õ—å–≤—ñ–≤—â–∏–Ω–∏': '–õ—å–≤—ñ–≤—Å—å–∫–∞ –æ–±–ª.',
    '–õ—å–≤—ñ–≤—â–∏–Ω—É': '–õ—å–≤—ñ–≤—Å—å–∫–∞ –æ–±–ª.',
    '–¢–µ—Ä–Ω–æ–ø—ñ–ª—å—â–∏–Ω–∞': '–¢–µ—Ä–Ω–æ–ø—ñ–ª—å—Å—å–∫–∞ –æ–±–ª.',
    '–¢–µ—Ä–Ω–æ–ø—ñ–ª—å—â–∏–Ω–∏': '–¢–µ—Ä–Ω–æ–ø—ñ–ª—å—Å—å–∫–∞ –æ–±–ª.',
    '–¢–µ—Ä–Ω–æ–ø—ñ–ª—å—â–∏–Ω—É': '–¢–µ—Ä–Ω–æ–ø—ñ–ª—å—Å—å–∫–∞ –æ–±–ª.',
    '–Ü–≤–∞–Ω–æ-–§—Ä–∞–Ω–∫—ñ–≤—â–∏–Ω–∞': '–Ü–≤–∞–Ω–æ-–§—Ä–∞–Ω–∫—ñ–≤—Å—å–∫–∞ –æ–±–ª.',
    '–Ü–≤–∞–Ω–æ-–§—Ä–∞–Ω–∫—ñ–≤—â–∏–Ω–∏': '–Ü–≤–∞–Ω–æ-–§—Ä–∞–Ω–∫—ñ–≤—Å—å–∫–∞ –æ–±–ª.',
    '–Ü–≤–∞–Ω–æ-–§—Ä–∞–Ω–∫—ñ–≤—â–∏–Ω—É': '–Ü–≤–∞–Ω–æ-–§—Ä–∞–Ω–∫—ñ–≤—Å—å–∫–∞ –æ–±–ª.',
    '–ó–∞–∫–∞—Ä–ø–∞—Ç—Ç—è': '–ó–∞–∫–∞—Ä–ø–∞—Ç—Å—å–∫–∞ –æ–±–ª.',
    '–ó–∞–∫–∞—Ä–ø–∞—Ç—Ç—é': '–ó–∞–∫–∞—Ä–ø–∞—Ç—Å—å–∫–∞ –æ–±–ª.',
    '–ö—ñ—Ä–æ–≤–æ–≥—Ä–∞–¥—â–∏–Ω–∞': '–ö—ñ—Ä–æ–≤–æ–≥—Ä–∞–¥—Å—å–∫–∞ –æ–±–ª.',
    '–ö—ñ—Ä–æ–≤–æ–≥—Ä–∞–¥—â–∏–Ω–∏': '–ö—ñ—Ä–æ–≤–æ–≥—Ä–∞–¥—Å—å–∫–∞ –æ–±–ª.',
    '–ö—ñ—Ä–æ–≤–æ–≥—Ä–∞–¥—â–∏–Ω—É': '–ö—ñ—Ä–æ–≤–æ–≥—Ä–∞–¥—Å—å–∫–∞ –æ–±–ª.'
}

# –ú–∞–ø—ñ–Ω–≥ –º—ñ—Å—Ç –Ω–∞ –æ–±–ª–∞—Å—Ç—ñ (–æ–±–ª–∞—Å–Ω—ñ —Ü–µ–Ω—Ç—Ä–∏ —Ç–∞ –≤–µ–ª–∏–∫—ñ –º—ñ—Å—Ç–∞)
CITY_TO_REGION = {
    # –û–±–ª–∞—Å–Ω—ñ —Ü–µ–Ω—Ç—Ä–∏
    '–ö–∏—ó–≤': '–ö–∏—ó–≤—Å—å–∫–∞ –æ–±–ª.',
    '–•–∞—Ä–∫—ñ–≤': '–•–∞—Ä–∫—ñ–≤—Å—å–∫–∞ –æ–±–ª.',
    '–û–¥–µ—Å–∞': '–û–¥–µ—Å—å–∫–∞ –æ–±–ª.',
    '–î–Ω—ñ–ø—Ä–æ': '–î–Ω—ñ–ø—Ä–æ–ø–µ—Ç—Ä–æ–≤—Å—å–∫–∞ –æ–±–ª.',
    '–î–æ–Ω–µ—Ü—å–∫': '–î–æ–Ω–µ—Ü—å–∫–∞ –æ–±–ª.',
    '–ó–∞–ø–æ—Ä—ñ–∂–∂—è': '–ó–∞–ø–æ—Ä—ñ–∑—å–∫–∞ –æ–±–ª.',
    '–õ—å–≤—ñ–≤': '–õ—å–≤—ñ–≤—Å—å–∫–∞ –æ–±–ª.',
    '–ö—Ä–∏–≤–∏–π –†—ñ–≥': '–î–Ω—ñ–ø—Ä–æ–ø–µ—Ç—Ä–æ–≤—Å—å–∫–∞ –æ–±–ª.',
    '–ú–∏–∫–æ–ª–∞—ó–≤': '–ú–∏–∫–æ–ª–∞—ó–≤—Å—å–∫–∞ –æ–±–ª.',
    '–ú–∞—Ä—ñ—É–ø–æ–ª—å': '–î–æ–Ω–µ—Ü—å–∫–∞ –æ–±–ª.',
    '–õ—É–≥–∞–Ω—Å—å–∫': '–õ—É–≥–∞–Ω—Å—å–∫–∞ –æ–±–ª.',
    '–í—ñ–Ω–Ω–∏—Ü—è': '–í—ñ–Ω–Ω–∏—Ü—å–∫–∞ –æ–±–ª.',
    '–•–µ—Ä—Å–æ–Ω': '–•–µ—Ä—Å–æ–Ω—Å—å–∫–∞ –æ–±–ª.',
    '–ü–æ–ª—Ç–∞–≤–∞': '–ü–æ–ª—Ç–∞–≤—Å—å–∫–∞ –æ–±–ª.',
    '–ß–µ—Ä–Ω—ñ–≥—ñ–≤': '–ß–µ—Ä–Ω—ñ–≥—ñ–≤—Å—å–∫–∞ –æ–±–ª.',
    '–ß–µ—Ä–∫–∞—Å–∏': '–ß–µ—Ä–∫–∞—Å—å–∫–∞ –æ–±–ª.',
    '–ñ–∏—Ç–æ–º–∏—Ä': '–ñ–∏—Ç–æ–º–∏—Ä—Å—å–∫–∞ –æ–±–ª.',
    '–°—É–º–∏': '–°—É–º—Å—å–∫–∞ –æ–±–ª.',
    '–•–º–µ–ª—å–Ω–∏—Ü—å–∫–∏–π': '–•–º–µ–ª—å–Ω–∏—Ü—å–∫–∞ –æ–±–ª.',
    '–†—ñ–≤–Ω–µ': '–†—ñ–≤–Ω–µ–Ω—Å—å–∫–∞ –æ–±–ª.',
    '–Ü–≤–∞–Ω–æ-–§—Ä–∞–Ω–∫—ñ–≤—Å—å–∫': '–Ü–≤–∞–Ω–æ-–§—Ä–∞–Ω–∫—ñ–≤—Å—å–∫–∞ –æ–±–ª.',
    '–¢–µ—Ä–Ω–æ–ø—ñ–ª—å': '–¢–µ—Ä–Ω–æ–ø—ñ–ª—å—Å—å–∫–∞ –æ–±–ª.',
    '–õ—É—Ü—å–∫': '–í–æ–ª–∏–Ω—Å—å–∫–∞ –æ–±–ª.',
    '–£–∂–≥–æ—Ä–æ–¥': '–ó–∞–∫–∞—Ä–ø–∞—Ç—Å—å–∫–∞ –æ–±–ª.',
    '–ö—Ä–æ–ø–∏–≤–Ω–∏—Ü—å–∫–∏–π': '–ö—ñ—Ä–æ–≤–æ–≥—Ä–∞–¥—Å—å–∫–∞ –æ–±–ª.',
    # –Ü–Ω—à—ñ –≤–µ–ª–∏–∫—ñ –º—ñ—Å—Ç–∞
    '–û—Ö—Ç–∏—Ä–∫–∞': '–°—É–º—Å—å–∫–∞ –æ–±–ª.',
    '–ö–æ–Ω–æ—Ç–æ–ø': '–°—É–º—Å—å–∫–∞ –æ–±–ª.',
    '–®–æ—Å—Ç–∫–∞': '–°—É–º—Å—å–∫–∞ –æ–±–ª.',
    '–†–æ–º–Ω–∏': '–°—É–º—Å—å–∫–∞ –æ–±–ª.',
    '–ù—ñ–∂–∏–Ω': '–ß–µ—Ä–Ω—ñ–≥—ñ–≤—Å—å–∫–∞ –æ–±–ª.',
    '–ü—Ä–∏–ª—É–∫–∏': '–ß–µ—Ä–Ω—ñ–≥—ñ–≤—Å—å–∫–∞ –æ–±–ª.',
    '–ö—Ä–µ–º–µ–Ω—á—É–∫': '–ü–æ–ª—Ç–∞–≤—Å—å–∫–∞ –æ–±–ª.',
    '–ü–∞–≤–ª–æ–≥—Ä–∞–¥': '–î–Ω—ñ–ø—Ä–æ–ø–µ—Ç—Ä–æ–≤—Å—å–∫–∞ –æ–±–ª.',
    '–ù—ñ–∫–æ–ø–æ–ª—å': '–î–Ω—ñ–ø—Ä–æ–ø–µ—Ç—Ä–æ–≤—Å—å–∫–∞ –æ–±–ª.',
    '–ú–∞—Ä–≥–∞–Ω–µ—Ü—å': '–î–Ω—ñ–ø—Ä–æ–ø–µ—Ç—Ä–æ–≤—Å—å–∫–∞ –æ–±–ª.',
    '–ö–∞–º\'—è–Ω—Å—å–∫–µ': '–î–Ω—ñ–ø—Ä–æ–ø–µ—Ç—Ä–æ–≤—Å—å–∫–∞ –æ–±–ª.',
    '–ë–µ—Ä–¥—è–Ω—Å—å–∫': '–ó–∞–ø–æ—Ä—ñ–∑—å–∫–∞ –æ–±–ª.',
    '–ú–µ–ª—ñ—Ç–æ–ø–æ–ª—å': '–ó–∞–ø–æ—Ä—ñ–∑—å–∫–∞ –æ–±–ª.',
    '–Ü–∑—é–º': '–•–∞—Ä–∫—ñ–≤—Å—å–∫–∞ –æ–±–ª.',
    '–ö—É–ø\'—è–Ω—Å—å–∫': '–•–∞—Ä–∫—ñ–≤—Å—å–∫–∞ –æ–±–ª.',
    '–õ–æ–∑–æ–≤–∞': '–•–∞—Ä–∫—ñ–≤—Å—å–∫–∞ –æ–±–ª.',
    '–ë—ñ–ª–∞ –¶–µ—Ä–∫–≤–∞': '–ö–∏—ó–≤—Å—å–∫–∞ –æ–±–ª.',
    '–ë—Ä–æ–≤–∞—Ä–∏': '–ö–∏—ó–≤—Å—å–∫–∞ –æ–±–ª.',
    '–ë–æ—Ä–∏—Å–ø—ñ–ª—å': '–ö–∏—ó–≤—Å—å–∫–∞ –æ–±–ª.',
    '–Ü—Ä–ø—ñ–Ω—å': '–ö–∏—ó–≤—Å—å–∫–∞ –æ–±–ª.',
    '–§–∞—Å—Ç—ñ–≤': '–ö–∏—ó–≤—Å—å–∫–∞ –æ–±–ª.',
    '–í–∞—Å–∏–ª—å–∫—ñ–≤': '–ö–∏—ó–≤—Å—å–∫–∞ –æ–±–ª.',
    '–£–º–∞–Ω—å': '–ß–µ—Ä–∫–∞—Å—å–∫–∞ –æ–±–ª.',
    '–°–º—ñ–ª–∞': '–ß–µ—Ä–∫–∞—Å—å–∫–∞ –æ–±–ª.',
    '–ö–æ—Ä–æ—Å—Ç–µ–Ω—å': '–ñ–∏—Ç–æ–º–∏—Ä—Å—å–∫–∞ –æ–±–ª.',
    '–ë–µ—Ä–¥–∏—á—ñ–≤': '–ñ–∏—Ç–æ–º–∏—Ä—Å—å–∫–∞ –æ–±–ª.',
    # –•–∞—Ä–∫—ñ–≤—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å
    '–ë–æ–≥–æ–¥—É—Ö—ñ–≤': '–•–∞—Ä–∫—ñ–≤—Å—å–∫–∞ –æ–±–ª.',
    '–ß—É–≥—É—ó–≤': '–•–∞—Ä–∫—ñ–≤—Å—å–∫–∞ –æ–±–ª.',
    '–ù–æ–≤–∞ –í–æ–¥–æ–ª–∞–≥–∞': '–•–∞—Ä–∫—ñ–≤—Å—å–∫–∞ –æ–±–ª.',
    '–°–ª–æ–±–æ–∂–∞–Ω—Å—å–∫–µ': '–•–∞—Ä–∫—ñ–≤—Å—å–∫–∞ –æ–±–ª.',
    '–ö—Ä–∞—Å–Ω–æ–ø–∞–≤–ª—ñ–≤–∫–∞': '–•–∞—Ä–∫—ñ–≤—Å—å–∫–∞ –æ–±–ª.',
    '–ë–∞—Ä–≤—ñ–Ω–∫–æ–≤–µ': '–•–∞—Ä–∫—ñ–≤—Å—å–∫–∞ –æ–±–ª.',
    '–ë–∞–ª–∞–∫–ª—ñ—è': '–•–∞—Ä–∫—ñ–≤—Å—å–∫–∞ –æ–±–ª.',
    '–ê–Ω–¥—Ä—ñ—ó–≤–∫–∞': '–•–∞—Ä–∫—ñ–≤—Å—å–∫–∞ –æ–±–ª.',
    '–ü–µ—á–µ–Ω—ñ–≥–∏': '–•–∞—Ä–∫—ñ–≤—Å—å–∫–∞ –æ–±–ª.',
    '–í–µ–ª–∏–∫–∏–π –ë—É—Ä–ª—É–∫': '–•–∞—Ä–∫—ñ–≤—Å—å–∫–∞ –æ–±–ª.',
    # –î–Ω—ñ–ø—Ä–æ–ø–µ—Ç—Ä–æ–≤—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å
    '–°–∏–Ω–µ–ª—å–Ω–∏–∫–æ–≤–µ': '–î–Ω—ñ–ø—Ä–æ–ø–µ—Ç—Ä–æ–≤—Å—å–∫–∞ –æ–±–ª.',
    '–°–ª–∞–≤–≥–æ—Ä–æ–¥': '–î–Ω—ñ–ø—Ä–æ–ø–µ—Ç—Ä–æ–≤—Å—å–∫–∞ –æ–±–ª.',
    # –ú–∏–∫–æ–ª–∞—ó–≤—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å
    '–ó–µ–ª–µ–Ω–æ–¥–æ–ª—å—Å—å–∫': '–ú–∏–∫–æ–ª–∞—ó–≤—Å—å–∫–∞ –æ–±–ª.',
    '–û—á–∞–∫—ñ–≤': '–ú–∏–∫–æ–ª–∞—ó–≤—Å—å–∫–∞ –æ–±–ª.',
    '–°–Ω—ñ–≥—É—Ä—ñ–≤–∫–∞': '–ú–∏–∫–æ–ª–∞—ó–≤—Å—å–∫–∞ –æ–±–ª.',
    # –î–Ω—ñ–ø—Ä–æ–ø–µ—Ç—Ä–æ–≤—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å
    '–ü\'—è—Ç–∏—Ö–∞—Ç–∫–∏': '–î–Ω—ñ–ø—Ä–æ–ø–µ—Ç—Ä–æ–≤—Å—å–∫–∞ –æ–±–ª.',
    '–ü º—è—Ç–∏—Ö–∞—Ç–∫–∏': '–î–Ω—ñ–ø—Ä–æ–ø–µ—Ç—Ä–æ–≤—Å—å–∫–∞ –æ–±–ª.',
    # –ó–∞–ø–æ—Ä—ñ–∑—å–∫–∞ –æ–±–ª–∞—Å—Ç—å
    '–ö–æ–º–∏—à—É–≤–∞—Ö–∞': '–ó–∞–ø–æ—Ä—ñ–∑—å–∫–∞ –æ–±–ª.',
    # –ß–µ—Ä–Ω—ñ–≥—ñ–≤—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å
    '–ù—ñ–∂–∏–Ω': '–ß–µ—Ä–Ω—ñ–≥—ñ–≤—Å—å–∫–∞ –æ–±–ª.',
    '–ë–æ—Ä–∑–Ω–∞': '–ß–µ—Ä–Ω—ñ–≥—ñ–≤—Å—å–∫–∞ –æ–±–ª.',
    '–ë–µ—Ä–µ–∑–Ω–∞': '–ß–µ—Ä–Ω—ñ–≥—ñ–≤—Å—å–∫–∞ –æ–±–ª.',
    '–°–Ω–æ–≤—Å—å–∫': '–ß–µ—Ä–Ω—ñ–≥—ñ–≤—Å—å–∫–∞ –æ–±–ª.',
    '–°–µ–¥–Ω—ñ–≤': '–ß–µ—Ä–Ω—ñ–≥—ñ–≤—Å—å–∫–∞ –æ–±–ª.',
    '–ù–æ—Å—ñ–≤–∫–∞': '–ß–µ—Ä–Ω—ñ–≥—ñ–≤—Å—å–∫–∞ –æ–±–ª.',
    '–ì–æ—Ä–æ–¥–Ω—è': '–ß–µ—Ä–Ω—ñ–≥—ñ–≤—Å—å–∫–∞ –æ–±–ª.',
    '–†—ñ–ø–∫–∏': '–ß–µ—Ä–Ω—ñ–≥—ñ–≤—Å—å–∫–∞ –æ–±–ª.',
    '–ö—É–ª–∏–∫—ñ–≤–∫–∞': '–ß–µ—Ä–Ω—ñ–≥—ñ–≤—Å—å–∫–∞ –æ–±–ª.',
    '–ö—ñ–ø—Ç—ñ': '–ß–µ—Ä–Ω—ñ–≥—ñ–≤—Å—å–∫–∞ –æ–±–ª.',
    # –ñ–∏—Ç–æ–º–∏—Ä—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å
    '–ù–∞—Ä–æ–¥–∏—á—ñ': '–ñ–∏—Ç–æ–º–∏—Ä—Å—å–∫–∞ –æ–±–ª.',
    '–û–≤—Ä—É—á': '–ñ–∏—Ç–æ–º–∏—Ä—Å—å–∫–∞ –æ–±–ª.',
    '–ë—Ä—É—Å–∏–ª—ñ–≤': '–ñ–∏—Ç–æ–º–∏—Ä—Å—å–∫–∞ –æ–±–ª.',
    # –î–æ–Ω–µ—Ü—å–∫–∞ –æ–±–ª–∞—Å—Ç—å
    '–ö—Ä–∞–º–∞—Ç–æ—Ä—Å—å–∫': '–î–æ–Ω–µ—Ü—å–∫–∞ –æ–±–ª.',
    # –û–¥–µ—Å—å–∫–∞ –æ–±–ª–∞—Å—Ç—å
    '–î–æ–±—Ä–æ—Å–ª–∞–≤': '–û–¥–µ—Å—å–∫–∞ –æ–±–ª.',
}

# –ö–µ—à –¥–ª—è –≥–µ–æ–∫–æ–¥–∏–Ω–≥—É (—â–æ–± –Ω–µ —Ä–æ–±–∏—Ç–∏ –∑–∞–π–≤–∏—Ö –∑–∞–ø–∏—Ç—ñ–≤)
geo_cache = {}

async def get_region_by_city(city_name):
    """
    –û—Ç—Ä–∏–º—É—î –æ–±–ª–∞—Å—Ç—å –∑–∞ –Ω–∞–∑–≤–æ—é –º—ñ—Å—Ç–∞ —á–µ—Ä–µ–∑ Nominatim API (OpenStreetMap)
    """
    # –°–ø–æ—á–∞—Ç–∫—É –ø–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –ª–æ–∫–∞–ª—å–Ω–∏–π —Å–ª–æ–≤–Ω–∏–∫
    if city_name in CITY_TO_REGION:
        return CITY_TO_REGION[city_name]
    
    # –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –∫–µ—à
    if city_name in geo_cache:
        return geo_cache[city_name]
    
    try:
        url = "https://nominatim.openstreetmap.org/search"
        params = {
            'q': f"{city_name}, –£–∫—Ä–∞—ó–Ω–∞",
            'format': 'json',
            'addressdetails': 1,
            'limit': 1,
            'accept-language': 'uk'
        }
        headers = {
            'User-Agent': 'TelegramForwarder/1.0'
        }
        
        async with aiohttp.ClientSession() as session:
            async with session.get(url, params=params, headers=headers, timeout=5) as response:
                if response.status == 200:
                    data = await response.json()
                    if data and len(data) > 0:
                        address = data[0].get('address', {})
                        # –®—É–∫–∞—î–º–æ –æ–±–ª–∞—Å—Ç—å
                        region = address.get('state', '')
                        if region:
                            # –ü—Ä–∏–≤–æ–¥–∏–º–æ –¥–æ —Ñ–æ—Ä–º–∞—Ç—É "–û–±–ª–∞—Å—Ç—å –æ–±–ª."
                            if '–æ–±–ª–∞—Å—Ç—å' in region.lower():
                                region = region.replace('–æ–±–ª–∞—Å—Ç—å', '–æ–±–ª.').replace('–û–±–ª–∞—Å—Ç—å', '–æ–±–ª.')
                            elif not region.endswith('–æ–±–ª.'):
                                region = region + ' –æ–±–ª.'
                            
                            # –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –≤ –∫–µ—à
                            geo_cache[city_name] = region
                            logger.info(f"üåç –ì–µ–æ–∫–æ–¥–∏–Ω–≥: {city_name} -> {region}")
                            return region
    except asyncio.TimeoutError:
        logger.warning(f"‚ö†Ô∏è –¢–∞–π–º–∞—É—Ç –≥–µ–æ–∫–æ–¥–∏–Ω–≥—É –¥–ª—è {city_name}")
    except Exception as e:
        logger.warning(f"‚ö†Ô∏è –ü–æ–º–∏–ª–∫–∞ –≥–µ–æ–∫–æ–¥–∏–Ω–≥—É –¥–ª—è {city_name}: {e}")
    
    # –ó–±–µ—Ä—ñ–≥–∞—î–º–æ None –≤ –∫–µ—à —â–æ–± –Ω–µ –ø–æ–≤—Ç–æ—Ä—é–≤–∞—Ç–∏ –∑–∞–ø–∏—Ç–∏
    geo_cache[city_name] = None
    return None


def clean_text(text):
    """
    –û—á–∏—â–∞—î —Ç–µ–∫—Å—Ç –≤—ñ–¥ –∑–∞–π–≤–æ—ó —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó —Ç–∞ –ø–æ—Å–∏–ª–∞–Ω—å
    """
    if not text:
        return text
    
    lines = text.split('\n')
    cleaned_lines = []
    
    for line in lines:
        # –ü—Ä–æ–ø—É—Å–∫–∞—î–º–æ –ø–æ—Ä–æ–∂–Ω—ñ —Ä—è–¥–∫–∏ —Ç–∞ —Ä—è–¥–∫–∏ –∑ –ª–∏—à–µ –ø—Ä–æ–±—ñ–ª–∞–º–∏/—Å–ø–µ—Ü—Å–∏–º–≤–æ–ª–∞–º–∏
        if not line.strip() or line.strip() in ['„Ö§', '‚îÄ' * len(line.strip())]:
            continue
        
        # –ü—Ä–æ–ø—É—Å–∫–∞—î–º–æ —Ä—è–¥–∫–∏ –∑ "–ü—ñ–¥–ø–∏—Å–∞—Ç–∏—Å—è", "–ü–ü–û—à–Ω–∏–∫", "Monitorzagroz" —Ç–æ—â–æ
        skip_keywords = ['–ü—ñ–¥–ø–∏—Å–∞—Ç–∏—Å—è', '–ü–ü–û—à–Ω–∏–∫', '–ü—ñ–¥–ø–∏—Å', 'Telegram', 'Channel', '–ú–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥ 24/7', '–ù–∞–ø—Ä—è–º–æ–∫ —Ä–∞–∫–µ—Ç', '–ü—ñ–¥—Ç—Ä–∏–º–∞—Ç–∏ –∫–∞–Ω–∞–ª', '–†–∞–¥–∞—Ä –£–∫—Ä–∞—ó–Ω–∏']
        if any(keyword in line for keyword in skip_keywords):
            continue
        
        # –ü—Ä–æ–ø—É—Å–∫–∞—î–º–æ —Ä—è–¥–∫–∏ —â–æ –º—ñ—Å—Ç—è—Ç—å —Ç—ñ–ª—å–∫–∏ —Å—Ç—Ä—ñ–ª–∫–∏, —Ñ–ª–∞–≥–∏ —Ç–∞ —Å–∏–º–≤–æ–ª–∏
        if re.match(r'^[‚û°Ô∏è‚¨ÖÔ∏è‚ÜóÔ∏è‚ÜòÔ∏è‚ÜñÔ∏è‚ÜôÔ∏è‚¨ÜÔ∏è‚¨áÔ∏èüá∫üá¶\s|]+$', line):
            continue
        
        # –í–∏–¥–∞–ª—è—î–º–æ –ø–æ—Å–∏–ª–∞–Ω–Ω—è (URLs)
        line = re.sub(r'http[s]?://(?:[a-zA-Z]|[0-9]|[$-_@.&+]|[!*\\(\\),]|(?:%[0-9a-fA-F][0-9a-fA-F]))+', '', line)
        
        # –í–∏–¥–∞–ª—è—î–º–æ @username
        line = re.sub(r'@\w+', '', line)
        
        # –í–∏–¥–∞–ª—è—î–º–æ –∑–∞–π–≤—ñ –ø—Ä–æ–±—ñ–ª–∏
        line = ' '.join(line.split())
        
        if line.strip():
            cleaned_lines.append(line)
    
    return '\n'.join(cleaned_lines)


async def split_cities(city_string):
    """
    –†–æ–∑–¥—ñ–ª—è—î —Ä—è–¥–æ–∫ –∑ –∫—ñ–ª—å–∫–æ–º–∞ –º—ñ—Å—Ç–∞–º–∏ (—á–µ—Ä–µ–∑ / –∞–±–æ ,) –Ω–∞ —Å–ø–∏—Å–æ–∫ –æ–∫—Ä–µ–º–∏—Ö –º—ñ—Å—Ç
    –ü–æ–≤–µ—Ä—Ç–∞—î –ø–µ—Ä—à–µ –º—ñ—Å—Ç–æ (–≤–∏–±–∏—Ä–∞—î–º–æ –æ–¥–Ω–µ)
    """
    # –í–∏–¥–∞–ª—è—î–º–æ "–∑ –æ–±–ª–∞—Å—Ç—ñ" —á–∞—Å—Ç–∏–Ω—É (–Ω–∞–ø—Ä. "–î—É–±—Ä–æ–≤–∏—Ü—é –∑ –ñ–∏—Ç–æ–º–∏—Ä—â–∏–Ω–∏" -> "–î—É–±—Ä–æ–≤–∏—Ü—é")
    city_string = re.sub(r'\s+–∑\s+\S+$', '', city_string)
    
    # –†–æ–∑–¥—ñ–ª—è—î–º–æ –ø–æ / –∞–±–æ ,
    if '/' in city_string:
        cities = city_string.split('/')
        city = cities[0].strip()
    elif ',' in city_string and '–æ–±–ª' not in city_string.lower():
        cities = city_string.split(',')
        city = cities[0].strip()
    else:
        city = city_string.strip()
    
    # –í–∏–¥–∞–ª—è—î–º–æ –∫—Ä–∞–ø–∫—É —Ç–∞ —ñ–Ω—à—ñ –∑–∞–π–≤—ñ —Å–∏–º–≤–æ–ª–∏ –≤ –∫—ñ–Ω—Ü—ñ –Ω–∞–∑–≤–∏ –º—ñ—Å—Ç–∞
    city = city.rstrip('.!?,;:')
    
    # –í–∏–ø—Ä–∞–≤–ª—è—î–º–æ –≤—ñ–¥–º—ñ–Ω–æ–∫ (—Ä–æ–¥–æ–≤–∏–π/–∑–Ω–∞—Ö—ñ–¥–Ω–∏–π -> –Ω–∞–∑–∏–≤–Ω–∏–π)
    city = fix_city_case(city)
    
    return city


def fix_city_case(city):
    """
    –í–∏–ø—Ä–∞–≤–ª—è—î –≤—ñ–¥–º—ñ–Ω–æ–∫ –Ω–∞–∑–≤–∏ –º—ñ—Å—Ç–∞ (—Ä–æ–¥–æ–≤–∏–π/–∑–Ω–∞—Ö—ñ–¥–Ω–∏–π -> –Ω–∞–∑–∏–≤–Ω–∏–π)
    """
    if not city:
        return city
    
    # –ó–∞–∫—ñ–Ω—á–µ–Ω–Ω—è —Ä–æ–¥–æ–≤–æ–≥–æ –≤—ñ–¥–º—ñ–Ω–∫–∞ -> –Ω–∞–∑–∏–≤–Ω–∏–π
    # -–∏ -> -–∞ (–®–æ—Å—Ç–∫–∏ -> –®–æ—Å—Ç–∫–∞, –ü–æ–ª—Ç–∞–≤–∏ -> –ü–æ–ª—Ç–∞–≤–∞)
    # -–∫–∏ -> -–∫–∞ (–®–æ—Å—Ç–∫–∏ -> –®–æ—Å—Ç–∫–∞, –û—Ö—Ç–∏—Ä–∫–∏ -> –û—Ö—Ç–∏—Ä–∫–∞)
    # -—ñ–≤ -> -—ñ–≤ (–•–∞—Ä–∫—ñ–≤ -> –•–∞—Ä–∫—ñ–≤ - –±–µ–∑ –∑–º—ñ–Ω)
    # -–∞ -> -–∞ (–±–µ–∑ –∑–º—ñ–Ω –¥–ª—è —á–æ–ª–æ–≤—ñ—á–æ–≥–æ —Ä–æ–¥—É)
    # -—ñ -> -–∞ (–í—ñ–Ω–Ω–∏—Ü—ñ -> –í—ñ–Ω–Ω–∏—Ü—è) - –∞–ª–µ –æ–±–µ—Ä–µ–∂–Ω–æ
    # -—É -> -–∞ (–î–Ω—ñ–ø—Ä—É -> –î–Ω—ñ–ø—Ä–æ, –•–∞—Ä–∫–æ–≤—É -> –•–∞—Ä–∫—ñ–≤)
    # -–æ–≥–æ -> -–µ (–ö—Ä–∏–≤–æ–≥–æ –†–æ–≥—É -> –ö—Ä–∏–≤–∏–π –†—ñ–≥) - —Å–∫–ª–∞–¥–Ω–∏–π –≤–∏–ø–∞–¥–æ–∫
    
    # –°–ª–æ–≤–Ω–∏–∫ –≤—ñ–¥–æ–º–∏—Ö —Ñ–æ—Ä–º (—Ä–æ–¥–æ–≤–∏–π -> –Ω–∞–∑–∏–≤–Ω–∏–π)
    known_forms = {
        '–®–æ—Å—Ç–∫–∏': '–®–æ—Å—Ç–∫–∞',
        '–û—Ö—Ç–∏—Ä–∫–∏': '–û—Ö—Ç–∏—Ä–∫–∞',
        '–ü–æ–ª—Ç–∞–≤–∏': '–ü–æ–ª—Ç–∞–≤–∞',
        '–í—ñ–Ω–Ω–∏—Ü—ñ': '–í—ñ–Ω–Ω–∏—Ü—è',
        '–û–¥–µ—Å–∏': '–û–¥–µ—Å–∞',
        '–£–º–∞–Ω—ñ': '–£–º–∞–Ω—å',
        '–°–º—ñ–ª–∏': '–°–º—ñ–ª–∞',
        '–ö–æ–Ω–æ—Ç–æ–ø—É': '–ö–æ–Ω–æ—Ç–æ–ø',
        '–†–æ–º–µ–Ω': '–†–æ–º–Ω–∏',
        '–ù—ñ–∂–∏–Ω–∞': '–ù—ñ–∂–∏–Ω',
        '–ü—Ä–∏–ª—É–∫': '–ü—Ä–∏–ª—É–∫–∏',
        '–ö—Ä–µ–º–µ–Ω—á—É–∫–∞': '–ö—Ä–µ–º–µ–Ω—á—É–∫',
        '–ü–∞–≤–ª–æ–≥—Ä–∞–¥–∞': '–ü–∞–≤–ª–æ–≥—Ä–∞–¥',
        '–ù—ñ–∫–æ–ø–æ–ª—è': '–ù—ñ–∫–æ–ø–æ–ª—å',
        '–ú–∞—Ä–≥–∞–Ω—Ü—è': '–ú–∞—Ä–≥–∞–Ω–µ—Ü—å',
        '–ë–µ—Ä–¥—è–Ω—Å—å–∫–∞': '–ë–µ—Ä–¥—è–Ω—Å—å–∫',
        '–ú–µ–ª—ñ—Ç–æ–ø–æ–ª—è': '–ú–µ–ª—ñ—Ç–æ–ø–æ–ª—å',
        '–Ü–∑—é–º–∞': '–Ü–∑—é–º',
        '–õ–æ–∑–æ–≤–æ—ó': '–õ–æ–∑–æ–≤–∞',
        '–ë—Ä–æ–≤–∞—Ä': '–ë—Ä–æ–≤–∞—Ä–∏',
        '–ë–æ—Ä–∏—Å–ø–æ–ª—è': '–ë–æ—Ä–∏—Å–ø—ñ–ª—å',
        '–Ü—Ä–ø–µ–Ω—è': '–Ü—Ä–ø—ñ–Ω—å',
        '–§–∞—Å—Ç–æ–≤–∞': '–§–∞—Å—Ç—ñ–≤',
        '–í–∞—Å–∏–ª—å–∫–æ–≤–∞': '–í–∞—Å–∏–ª—å–∫—ñ–≤',
        '–ö–æ—Ä–æ—Å—Ç–µ–Ω—è': '–ö–æ—Ä–æ—Å—Ç–µ–Ω—å',
        '–ë–µ—Ä–¥–∏—á–µ–≤–∞': '–ë–µ—Ä–¥–∏—á—ñ–≤',
        '–ë–æ–≥–æ–¥—É—Ö–æ–≤–∞': '–ë–æ–≥–æ–¥—É—Ö—ñ–≤',
        '–ß—É–≥—É—î–≤–∞': '–ß—É–≥—É—ó–≤',
        '–•–∞—Ä–∫–æ–≤–∞': '–•–∞—Ä–∫—ñ–≤',
        '–ö–∏—î–≤–∞': '–ö–∏—ó–≤',
        '–õ—å–≤–æ–≤–∞': '–õ—å–≤—ñ–≤',
        '–î–Ω—ñ–ø—Ä–∞': '–î–Ω—ñ–ø—Ä–æ',
        '–ó–∞–ø–æ—Ä—ñ–∂–∂—è': '–ó–∞–ø–æ—Ä—ñ–∂–∂—è',
        '–ú–∏–∫–æ–ª–∞—î–≤–∞': '–ú–∏–∫–æ–ª–∞—ó–≤',
        '–•–µ—Ä—Å–æ–Ω–∞': '–•–µ—Ä—Å–æ–Ω',
        '–ß–µ—Ä–Ω—ñ–≥–æ–≤–∞': '–ß–µ—Ä–Ω—ñ–≥—ñ–≤',
        '–ß–µ—Ä–∫–∞—Å': '–ß–µ—Ä–∫–∞—Å–∏',
        '–ñ–∏—Ç–æ–º–∏—Ä–∞': '–ñ–∏—Ç–æ–º–∏—Ä',
        '–°—É–º': '–°—É–º–∏',
        '–•–º–µ–ª—å–Ω–∏—Ü—å–∫–æ–≥–æ': '–•–º–µ–ª—å–Ω–∏—Ü—å–∫–∏–π',
        '–†—ñ–≤–Ω–æ–≥–æ': '–†—ñ–≤–Ω–µ',
        '–¢–µ—Ä–Ω–æ–ø–æ–ª—è': '–¢–µ—Ä–Ω–æ–ø—ñ–ª—å',
        '–õ—É—Ü—å–∫–∞': '–õ—É—Ü—å–∫',
        '–£–∂–≥–æ—Ä–æ–¥–∞': '–£–∂–≥–æ—Ä–æ–¥',
        '–ö—Ä–æ–ø–∏–≤–Ω–∏—Ü—å–∫–æ–≥–æ': '–ö—Ä–æ–ø–∏–≤–Ω–∏—Ü—å–∫–∏–π',
        '–ü—ñ–≤–¥–µ–Ω–Ω–æ—É–∫—Ä–∞—ó–Ω—Å—å–∫–∞': '–ü—ñ–≤–¥–µ–Ω–Ω–æ—É–∫—Ä–∞—ó–Ω—Å—å–∫',
        '–ó–µ–ª–µ–Ω–æ–¥–æ–ª—å—Å—å–∫–∞': '–ó–µ–ª–µ–Ω–æ–¥–æ–ª—å—Å—å–∫',
        '–°–∏–Ω–µ–ª—å–Ω–∏–∫–æ–≤–æ–≥–æ': '–°–∏–Ω–µ–ª—å–Ω–∏–∫–æ–≤–µ',
        "–ü'—è—Ç–∏—Ö–∞—Ç–æ–∫": "–ü'—è—Ç–∏—Ö–∞—Ç–∫–∏",
        '–ü º—è—Ç–∏—Ö–∞—Ç–æ–∫': '–ü º—è—Ç–∏—Ö–∞—Ç–∫–∏',
        '–ë—Ä—É—Å–∏–ª–æ–≤–∞': '–ë—Ä—É—Å–∏–ª—ñ–≤',
        # –ù–æ–≤—ñ –º—ñ—Å—Ç–∞
        '–°–ª–∞–≤–≥–æ—Ä–æ–¥–∞': '–°–ª–∞–≤–≥–æ—Ä–æ–¥',
        '–ù–∞—Ä–æ–¥–∏—á—ñ–≤': '–ù–∞—Ä–æ–¥–∏—á—ñ',
        '–ë–µ—Ä–µ–∑–Ω–∏': '–ë–µ—Ä–µ–∑–Ω–∞',
        '–ë–æ—Ä–∑–Ω–∏': '–ë–æ—Ä–∑–Ω–∞',
        '–°–Ω–æ–≤—Å—å–∫–∞': '–°–Ω–æ–≤—Å—å–∫',
        '–°–µ–¥–Ω–µ–≤–∞': '–°–µ–¥–Ω—ñ–≤',
        '–ù–æ—Å—ñ–≤–∫–∏': '–ù–æ—Å—ñ–≤–∫–∞',
        '–ì–æ—Ä–æ–¥–Ω—ñ': '–ì–æ—Ä–æ–¥–Ω—è',
        '–†—ñ–ø–æ–∫': '–†—ñ–ø–∫–∏',
        '–ö—É–ª–∏–∫—ñ–≤–∫–∏': '–ö—É–ª–∏–∫—ñ–≤–∫–∞',
        '–ö—ñ–ø—Ç—ñ–≤': '–ö—ñ–ø—Ç—ñ',
        '–°–∞–º–∞—Ä–∞': '–°–∞–º–∞—Ä',
        '–ö—Ä–∞–º–∞—Ç–æ—Ä—Å—å–∫–∞': '–ö—Ä–∞–º–∞—Ç–æ—Ä—Å—å–∫',
        '–ë–∞–ª–∞–∫–ª—ñ—ó': '–ë–∞–ª–∞–∫–ª—ñ—è',
        '–ê–Ω–¥—Ä—ñ—ó–≤–∫–∏': '–ê–Ω–¥—Ä—ñ—ó–≤–∫–∞',
        '–ß—É–≥—É—î–≤–∞': '–ß—É–≥—É—ó–≤',
        '–ü–µ—á–µ–Ω—ñ–≥': '–ü–µ—á–µ–Ω—ñ–≥–∏',
        '–û—á–∞–∫–æ–≤–∞': '–û—á–∞–∫—ñ–≤',
        '–°–Ω—ñ–≥—É—Ä—ñ–≤–∫–∏': '–°–Ω—ñ–≥—É—Ä—ñ–≤–∫–∞',
        '–î–æ–±—Ä–æ—Å–ª–∞–≤–∞': '–î–æ–±—Ä–æ—Å–ª–∞–≤',
        # –ö—Ä–∏–≤–∏–π –†—ñ–≥ —É —Ä–æ–¥–æ–≤–æ–º—É
        '–ö—Ä–∏–≤–æ–≥–æ –†–æ–≥—É': '–ö—Ä–∏–≤–∏–π –†—ñ–≥',
        # –ú—ñ—Å—Ç–∞ –∑ –º–Ω–æ–∂–∏–Ω–Ω–æ—é —Ñ–æ—Ä–º–æ—é (–ù–ï –∑–º—ñ–Ω—é–≤–∞—Ç–∏!)
        '–†—ñ–ø–∫–∏': '–†—ñ–ø–∫–∏',
        '–ë–ª–∏–∑–Ω—é–∫–∏': '–ë–ª–∏–∑–Ω—é–∫–∏',
        '–ü–µ—á–µ–Ω—ñ–≥–∏': '–ü–µ—á–µ–Ω—ñ–≥–∏',
        '–ü—Ä–∏–ª—É–∫–∏': '–ü—Ä–∏–ª—É–∫–∏',
        '–ë—Ä–æ–≤–∞—Ä–∏': '–ë—Ä–æ–≤–∞—Ä–∏',
        '–†–æ–º–Ω–∏': '–†–æ–º–Ω–∏',
        '–ß–µ—Ä–∫–∞—Å–∏': '–ß–µ—Ä–∫–∞—Å–∏',
        '–°—É–º–∏': '–°—É–º–∏',
        '–õ—É–±–Ω–∏': '–õ—É–±–Ω–∏',
        '–ì—Ä–µ–±—ñ–Ω–∫–∏': '–ì—Ä–µ–±—ñ–Ω–∫–∏',
        '–ë–∞—Ä–∏—à—ñ–≤–∫–∏': '–ë–∞—Ä–∏—à—ñ–≤–∫–∏',
        # –ó–Ω–∞—Ö—ñ–¥–Ω–∏–π –≤—ñ–¥–º—ñ–Ω–æ–∫
        '–î—É–±—Ä–æ–≤–∏—Ü—é': '–î—É–±—Ä–æ–≤–∏—Ü—è',
        '–®–æ—Å—Ç–∫—É': '–®–æ—Å—Ç–∫–∞',
        '–û—Ö—Ç–∏—Ä–∫—É': '–û—Ö—Ç–∏—Ä–∫–∞',
        '–ü–æ–ª—Ç–∞–≤—É': '–ü–æ–ª—Ç–∞–≤–∞',
        '–í—ñ–Ω–Ω–∏—Ü—é': '–í—ñ–Ω–Ω–∏—Ü—è',
        '–û–¥–µ—Å—É': '–û–¥–µ—Å–∞',
        '–£–º–∞–Ω—å': '–£–º–∞–Ω—å',
        '–°–º—ñ–ª—É': '–°–º—ñ–ª–∞',
        # –ù–æ–≤—ñ –º—ñ—Å—Ç–∞ (–∑–Ω–∞—Ö—ñ–¥–Ω–∏–π –≤—ñ–¥–º—ñ–Ω–æ–∫)
        '–ú–∏—Ä–æ–Ω—ñ–≤–∫—É': '–ú–∏—Ä–æ–Ω—ñ–≤–∫–∞',
        '–ú–∞–ª—É –î—ñ–≤–∏—Ü—é': '–ú–∞–ª–∞ –î—ñ–≤–∏—Ü—è',
        '–ù–æ–≤—É –í–æ–¥–æ–ª–∞–≥—É': '–ù–æ–≤–∞ –í–æ–¥–æ–ª–∞–≥–∞',
        '–í—ñ–Ω—å–∫—ñ–≤—Ü—ñ': '–í—ñ–Ω—å–∫—ñ–≤—Ü—ñ',
        '–î—É–Ω–∞—ó–≤—Ü—ñ': '–î—É–Ω–∞—ó–≤—Ü—ñ',
        '–ß–æ—Ä–Ω—É—Ö–∏': '–ß–æ—Ä–Ω—É—Ö–∏',
        '–ù–∞—Ä–æ–¥–∏—á—ñ': '–ù–∞—Ä–æ–¥–∏—á—ñ',
        # –†–æ–¥–æ–≤–∏–π –≤—ñ–¥–º—ñ–Ω–æ–∫ (–≤ –Ω–∞–ø—Ä—è–º–∫—É)
        '–ü—Ä–æ—Å—è–Ω–æ—ó': '–ü—Ä–æ—Å—è–Ω–∞',
        '–°–∏–Ω–µ–ª—å–Ω–∏–∫–æ–≤–æ–≥–æ': '–°–∏–Ω–µ–ª—å–Ω–∏–∫–æ–≤–µ',
        '–ü–∞–≤–ª–æ–≥—Ä–∞–¥–∞': '–ü–∞–≤–ª–æ–≥—Ä–∞–¥',
        # –ê–±—Ä–µ–≤—ñ–∞—Ç—É—Ä–∏
        '–ß–ó–í': '–ß–æ—Ä–Ω–æ–±–∏–ª—å',
    }
    
    if city in known_forms:
        return known_forms[city]
    
    # –°–ø–∏—Å–æ–∫ –º—ñ—Å—Ç –∑ –º–Ω–æ–∂–∏–Ω–Ω–æ—é —Ñ–æ—Ä–º–æ—é (–Ω–µ –∑–º—ñ–Ω—é–≤–∞—Ç–∏ –∑–∞–∫—ñ–Ω—á–µ–Ω–Ω—è -–∫–∏, -—Ü—ñ)
    plural_cities = ['–†—ñ–ø–∫–∏', '–ë–ª–∏–∑–Ω—é–∫–∏', '–ü–µ—á–µ–Ω—ñ–≥–∏', '–ü—Ä–∏–ª—É–∫–∏', '–ë—Ä–æ–≤–∞—Ä–∏', '–†–æ–º–Ω–∏', 
                     '–ß–µ—Ä–∫–∞—Å–∏', '–°—É–º–∏', '–õ—É–±–Ω–∏', '–ì—Ä–µ–±—ñ–Ω–∫–∏', '–ë–∞—Ä–∏—à—ñ–≤–∫–∏', '–ö—ñ–ø—Ç—ñ',
                     '–ù–∞—Ä–æ–¥–∏—á—ñ', '–ü\'—è—Ç–∏—Ö–∞—Ç–∫–∏', '–ü º—è—Ç–∏—Ö–∞—Ç–∫–∏', '–í—ñ–Ω—å–∫—ñ–≤—Ü—ñ', '–î—É–Ω–∞—ó–≤—Ü—ñ',
                     '–ß–æ—Ä–Ω—É—Ö–∏', '–ü–∏—Ä—è—Ç–∏–Ω', '–ú–∏—Ä–æ–Ω—ñ–≤–∫–∞', '–ñ—É–∫–∏–Ω', '–ù–æ–≤–∞ –í–æ–¥–æ–ª–∞–≥–∞',
                     '–ú–∞–ª–∞ –î—ñ–≤–∏—Ü—è']
    
    # –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ –º—ñ—Å—Ç–æ –≤–∂–µ –≤ –ø—Ä–∞–≤–∏–ª—å–Ω—ñ–π —Ñ–æ—Ä–º—ñ
    if city in plural_cities:
        return city
    
    # –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è –∑–∞–≥–∞–ª—å–Ω–∏—Ö –ø–∞—Ç–µ—Ä–Ω—ñ–≤
    # -–æ–≥–æ -> –ø—Ä–∏–±–∏—Ä–∞—î–º–æ (–°–∏–Ω–µ–ª—å–Ω–∏–∫–æ–≤–æ–≥–æ -> –°–∏–Ω–µ–ª—å–Ω–∏–∫–æ–≤–µ)
    if city.endswith('–æ–≥–æ') and len(city) > 4:
        return city[:-3] + '–µ'
    # -–∫–∏ -> -–∫–∞ (—Ä–æ–¥–æ–≤–∏–π –∂—ñ–Ω–æ—á–æ–≥–æ —Ä–æ–¥—É) - –¢–Ü–õ–¨–ö–ò —è–∫—â–æ —Ü–µ –Ω–µ –º–Ω–æ–∂–∏–Ω–∞
    # –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ —Å—Ö–æ–∂–µ –Ω–∞ —Ä–æ–¥–æ–≤–∏–π –≤—ñ–¥–º—ñ–Ω–æ–∫ (–®–æ—Å—Ç–∫–∏ -> –®–æ—Å—Ç–∫–∞)
    if city.endswith('–∫–∏') and len(city) > 3:
        # –ù–µ –∑–º—ñ–Ω—é—î–º–æ —è–∫—â–æ —Ü–µ –≤—ñ–¥–æ–º—ñ –º–Ω–æ–∂–∏–Ω–Ω—ñ —Ñ–æ—Ä–º–∏
        base = city[:-1] + '–∞'
        if base not in plural_cities and city not in plural_cities:
            # –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ —î —Ç–∞–∫–∞ —Ñ–æ—Ä–º–∞ –≤ CITY_TO_REGION
            return city  # –ö—Ä–∞—â–µ –∑–∞–ª–∏—à–∏—Ç–∏ —è–∫ —î, –Ω—ñ–∂ –∑–ª–∞–º–∞—Ç–∏
    # -–≤–∏ -> -–≤–∞
    if city.endswith('–≤–∏') and len(city) > 3:
        return city[:-1] + '–∞'
    # -—Ü—ñ -> -—Ü—è (–∞–ª–µ –Ω–µ –¥–ª—è –º–Ω–æ–∂–∏–Ω–Ω–∏—Ö —Ñ–æ—Ä–º —è–∫ –í—ñ–Ω—å–∫—ñ–≤—Ü—ñ, –î—É–Ω–∞—ó–≤—Ü—ñ)
    if city.endswith('—Ü—ñ') and len(city) > 3:
        # –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ —Ü–µ –Ω–µ –º–Ω–æ–∂–∏–Ω–Ω–∞ —Ñ–æ—Ä–º–∞
        if city not in plural_cities:
            return city[:-1] + '—è'
    # -–∫—É -> -–∫–∞ (–∑–Ω–∞—Ö—ñ–¥–Ω–∏–π)
    if city.endswith('–∫—É') and len(city) > 3:
        return city[:-1] + '–∞'
    # -—Ü—é -> -—Ü—è (–∑–Ω–∞—Ö—ñ–¥–Ω–∏–π)
    if city.endswith('—Ü—é') and len(city) > 3:
        return city[:-1] + '—è'
    # -–≤—É -> -–≤–∞ (–∑–Ω–∞—Ö—ñ–¥–Ω–∏–π)
    if city.endswith('–≤—É') and len(city) > 3:
        return city[:-1] + '–∞'
    # -–ª—É -> -–ª–∞ (–∑–Ω–∞—Ö—ñ–¥–Ω–∏–π)
    if city.endswith('–ª—É') and len(city) > 3:
        return city[:-1] + '–∞'
    # -–¥–∞ -> -–¥ (—Ä–æ–¥–æ–≤–∏–π: –°–ª–∞–≤–≥–æ—Ä–æ–¥–∞ -> –°–ª–∞–≤–≥–æ—Ä–æ–¥)
    if city.endswith('–¥–∞') and len(city) > 3:
        return city[:-1]
    
    return city


async def parse_and_split_message(text):
    """
    –†–æ–∑–±–∏–≤–∞—î –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –Ω–∞ –æ–∫—Ä–µ–º—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø–æ –Ω–∞—Å–µ–ª–µ–Ω–∏—Ö –ø—É–Ω–∫—Ç–∞—Ö
    """
    if not text:
        return []
    
    # –°–ø–æ—á–∞—Ç–∫—É –æ—á–∏—â–∞—î–º–æ —Ç–µ–∫—Å—Ç
    text = clean_text(text)
    
    messages = []
    lines = text.strip().split('\n')
    current_region = None
    
    # –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –Ω–∞—Å—Ç—É–ø–Ω–∏–π —Ä—è–¥–æ–∫ —è–∫ –æ–ø–∏—Å –∑–∞–≥—Ä–æ–∑–∏
    lines_list = text.strip().split('\n')
    threat_descriptions = {}
    for i, line in enumerate(lines_list):
        if i + 1 < len(lines_list):
            next_line = lines_list[i + 1].strip()
            if next_line and not re.match(r'^[üí•üõ∏üõµ‚ö†Ô∏è‚ùóÔ∏èüî¥üëÅÔ∏è]', next_line):
                threat_descriptions[i] = next_line
    
    for i, line in enumerate(lines):
        line = line.strip()
        if not line:
            continue
        
        # –ü—Ä–æ–ø—É—Å–∫–∞—î–º–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø—Ä–æ –ø–æ–≤—ñ—Ç—Ä—è–Ω—É —Ç—Ä–∏–≤–æ–≥—É —Ç–∞ –≤—ñ–¥–±—ñ–π (–Ω–µ –ë–ü–õ–ê/–ö–ê–ë)
        if re.search(r'–ø–æ–≤—ñ—Ç—Ä—è–Ω–∞\s+—Ç—Ä–∏–≤–æ–≥–∞|–≤—ñ–¥–±—ñ–π\s+—Ç—Ä–∏–≤–æ–≥–∏|–ø—Ä—è–º—É–π—Ç–µ\s+–≤\s+—É–∫—Ä–∏—Ç—Ç—è|–±—É–¥—å—Ç–µ\s+–æ–±–µ—Ä–µ–∂–Ω—ñ', line, re.IGNORECASE):
            continue
        
        # –§–æ—Ä–º–∞—Ç –∑–∞–≥–æ–ª–æ–≤–∫–∞: "4 —à–∞—Ö–µ–¥–∏ –Ω–∞ –ß–µ—Ä–Ω—ñ–≥—ñ–≤—â–∏–Ω—ñ:" –∞–±–æ "1 —à–∞—Ö–µ–¥ –Ω–∞ –ü–æ–ª—Ç–∞–≤—â–∏–Ω—ñ:"
        header_region_match = re.match(r'^\d+\s+(?:—à–∞—Ö–µ–¥[—ñ–∏—ñ–≤]*|–ë–ø–õ–ê|–ë–ü–õ–ê)\s+–Ω–∞\s+(\S+):?\s*$', line, re.IGNORECASE)
        if header_region_match:
            short_region = header_region_match.group(1).strip().rstrip(':')
            region = REGION_MAP.get(short_region, None)
            if region:
                current_region = region
            continue
        
        # –§–æ—Ä–º–∞—Ç: "1 –ø–æ–≤–∑ –°–ª–∞–≤—É—Ç–∏—á –ø—ñ–≤–¥–µ–Ω–Ω–∏–º –∫—É—Ä—Å–æ–º" –∞–±–æ "2 –Ω–∞ –°–Ω–æ–≤—Å—å–∫ –∑—ñ —Å—Ö–æ–¥—É"
        povz_city_match = re.match(r'^\d+\s+(?:–ø–æ–≤–∑|–Ω–∞)\s+(\S+)(?:\s+.+)?$', line, re.IGNORECASE)
        if povz_city_match and current_region:
            city = povz_city_match.group(1).strip()
            city = fix_city_case(city)
            city = city[0].upper() + city[1:] if city else city
            msg = f"–ë–ü–õ–ê {city} ({current_region})"
            messages.append(msg)
            continue
        
        # –§–æ—Ä–º–∞—Ç: "1 –∫—Ä—É–∂–ª—è—î –º—ñ–∂ –ì–∞–¥—è—á–µ–º —Ç–∞ –ó—ñ–Ω—å–∫–æ–≤–æ–º" - –±–µ—Ä–µ–º–æ –ø–µ—Ä—à–µ –º—ñ—Å—Ç–æ
        kruzhlyaye_match = re.match(r'^\d+\s+–∫—Ä—É–∂–ª—è—î\s+(?:–º—ñ–∂|–±—ñ–ª—è|–≤ —Ä–∞–π–æ–Ω—ñ)\s+(\S+)(?:\s+—Ç–∞\s+.+)?$', line, re.IGNORECASE)
        if kruzhlyaye_match and current_region:
            city = kruzhlyaye_match.group(1).strip()
            city = fix_city_case(city)
            city = city[0].upper() + city[1:] if city else city
            msg = f"–ë–ü–õ–ê {city} ({current_region})"
            messages.append(msg)
            continue
        
        # –§–æ—Ä–º–∞—Ç: "1 –º–∞–Ω–µ–≤—Ä—É—î –ø—ñ–≤–Ω—ñ—á–Ω—ñ—à–µ –ö–∞–º'—è–Ω—Å—å–∫–æ–≥–æ"
        manevruje_match = re.match(r'^\d+\s+–º–∞–Ω–µ–≤—Ä—É—î\s+(?:–ø—ñ–≤–Ω—ñ—á–Ω—ñ—à–µ|–ø—ñ–≤–¥–µ–Ω–Ω—ñ—à–µ|–∑–∞—Ö—ñ–¥–Ω—ñ—à–µ|—Å—Ö—ñ–¥–Ω—ñ—à–µ|–±—ñ–ª—è)\s+(\S+)$', line, re.IGNORECASE)
        if manevruje_match and current_region:
            city = manevruje_match.group(1).strip()
            city = fix_city_case(city)
            city = city[0].upper() + city[1:] if city else city
            msg = f"–ë–ü–õ–ê {city} ({current_region})"
            messages.append(msg)
            continue
        
        # –§–æ—Ä–º–∞—Ç –ü–°: "üõµ –ß–µ—Ä–Ω—ñ–≥—ñ–≤—â–∏–Ω–∞: –ë–ø–õ–ê –≤ –Ω–∞–ø—Ä—è–º–∫—É –Ω.–ø. –ë–µ—Ä–µ–∑–Ω–∞, –ù—ñ–∂–∏–Ω, –ë–æ—Ä–∑–Ω–∞."
        # –û–±–ª–∞—Å—Ç—å: –ë–ø–õ–ê –≤ –Ω–∞–ø—Ä—è–º–∫—É –Ω.–ø. –ú—ñ—Å—Ç–æ1, –ú—ñ—Å—Ç–æ2 - –±–µ—Ä–µ–º–æ —Ç—ñ–ª—å–∫–∏ –ü–ï–†–®–ï –º—ñ—Å—Ç–æ
        ps_region_np_match = re.match(r'^[üõµüõ∏\s]*(\S+):\s*–ë–ø–õ–ê\s+–≤\s+–Ω–∞–ø—Ä—è–º–∫—É\s+(?:–Ω\.–ø\.?\s*)?(.+?)(?:\s+–∑[—ñ–∏]?\s+.+)?[\.;]?$', line, re.IGNORECASE)
        if ps_region_np_match:
            short_region = ps_region_np_match.group(1).strip()
            cities_str = ps_region_np_match.group(2).strip()
            region = REGION_MAP.get(short_region, None)
            if region:
                # –†–æ–∑–¥—ñ–ª—è—î–º–æ –º—ñ—Å—Ç–∞ –ø–æ , —Ç–∞ / —ñ –±–µ—Ä–µ–º–æ –¢–Ü–õ–¨–ö–ò –ü–ï–†–®–ï
                cities_str = cities_str.replace('/', ',')
                cities = [c.strip().rstrip('.;') for c in cities_str.split(',') if c.strip()]
                if cities:
                    city = cities[0]  # –ë–µ—Ä–µ–º–æ —Ç—ñ–ª—å–∫–∏ –ø–µ—Ä—à–µ –º—ñ—Å—Ç–æ
                    city = fix_city_case(city)
                    city = city[0].upper() + city[1:] if city else city
                    message = f"–ë–ü–õ–ê {city} ({region})"
                    messages.append(message)
                continue
        
        # –§–æ—Ä–º–∞—Ç –ü–°: "–ñ–∏—Ç–æ–º–∏—Ä—â–∏–Ω–∞: 1 –ë–ø–õ–ê –≤ —Ä–∞–π–æ–Ω—ñ –ú–∞–ª–∏–Ω–∞"
        ps_region_v_rayoni_match = re.match(r'^[üõµüõ∏\s]*(\S+):\s*(\d+)\s*(?:–ë–ø–õ–ê|–ë–ü–õ–ê)\s+–≤\s+—Ä–∞–π–æ–Ω[—ñ—É]\s+(.+?)\.?$', line, re.IGNORECASE)
        if ps_region_v_rayoni_match:
            short_region = ps_region_v_rayoni_match.group(1).strip()
            city = ps_region_v_rayoni_match.group(3).strip().rstrip('.')
            region = REGION_MAP.get(short_region, None)
            if region:
                city = fix_city_case(city)
                city = city[0].upper() + city[1:] if city else city
                msg = f"–ë–ü–õ–ê {city} ({region})"
                messages.append(msg)
                continue
        
        # –§–æ—Ä–º–∞—Ç –ü–°: "üõµ –ñ–∏—Ç–æ–º–∏—Ä—â–∏–Ω–∞: –ë–ø–õ–ê –∫—É—Ä—Å–æ–º –Ω–∞ –ö–æ—Ä–æ—Å—Ç–µ–Ω—å –∑—ñ —Å—Ö–æ–¥—É." (1 –ë–ø–õ–ê)
        ps_region_kursom_match = re.match(r'^[üõµüõ∏\s]*(\S+):\s*–ë–ø–õ–ê\s+–∫—É—Ä—Å–æ–º\s+–Ω–∞\s+(.+?)(?:\s+–∑[—ñ–∏]?\s+.+)?\.?$', line, re.IGNORECASE)
        if ps_region_kursom_match:
            short_region = ps_region_kursom_match.group(1).strip()
            city = ps_region_kursom_match.group(2).strip().rstrip('.')
            region = REGION_MAP.get(short_region, None)
            if region:
                city = fix_city_case(city)
                city = city[0].upper() + city[1:] if city else city
                msg = f"–ë–ü–õ–ê {city} ({region})"
                messages.append(msg)
                continue
        
        # –§–æ—Ä–º–∞—Ç –ü–°: "N—Ö –ë–ø–õ–ê –∫—É—Ä—Å–æ–º –Ω–∞ –ú—ñ—Å—Ç–æ" (–∑ –∫—ñ–ª—å–∫—ñ—Å—Ç—é —ñ current_region)
        bpla_qty_kursom_match = re.match(r'^[üõµüõ∏\s]*(\d+)\s*—Ö?\s*–ë–ø–õ–ê\s+–∫—É—Ä—Å–æ–º\s+–Ω–∞\s+(.+?)(?:\s+–∑[—ñ–∏]?\s+.+)?\.?\s*$', line, re.IGNORECASE)
        if bpla_qty_kursom_match and current_region:
            city = bpla_qty_kursom_match.group(2).strip().rstrip('.')
            city = fix_city_case(city)
            city = city[0].upper() + city[1:] if city else city
            msg = f"–ë–ü–õ–ê {city} ({current_region})"
            messages.append(msg)
            continue
        
        # –§–æ—Ä–º–∞—Ç –ü–°: "–ë–ø–õ–ê –∫—É—Ä—Å–æ–º –Ω–∞ –ú—ñ—Å—Ç–æ" (–±–µ–∑ –∫—ñ–ª—å–∫–æ—Å—Ç—ñ, –∑ current_region)
        bpla_kursom_current_region_match = re.match(r'^[üõµüõ∏\s]*–ë–ø–õ–ê\s+–∫—É—Ä—Å–æ–º\s+–Ω–∞\s+(.+?)(?:\s+–∑[—ñ–∏]?\s+.+)?\.?\s*$', line, re.IGNORECASE)
        if bpla_kursom_current_region_match and current_region:
            city = bpla_kursom_current_region_match.group(1).strip().rstrip('.')
            city = fix_city_case(city)
            city = city[0].upper() + city[1:] if city else city
            msg = f"–ë–ü–õ–ê {city} ({current_region})"
            messages.append(msg)
            continue
        
        # –§–æ—Ä–º–∞—Ç –ü–°: "üõµ –ë–ø–õ–ê –Ω–∞ —Å—Ö–æ–¥—ñ –î–Ω—ñ–ø—Ä–æ–ø–µ—Ç—Ä–æ–≤—â–∏–Ω–∏ –ø–æ–≤–∑ –®–∞—Ö—Ç–∞—Ä—Å—å–∫–µ –∫—É—Ä—Å–æ–º –Ω–∞ –∑–∞—Ö—ñ–¥."
        ps_na_storoni_povz_match = re.match(r'^[üõµüõ∏\s]*–ë–ø–õ–ê\s+–Ω–∞\s+(?:—Å—Ö–æ–¥—ñ|–∑–∞—Ö–æ–¥—ñ|–ø—ñ–≤–Ω–æ—á—ñ|–ø—ñ–≤–¥–Ω—ñ)\s+(\S+)\s+–ø–æ–≤–∑\s+(\S+)\s+–∫—É—Ä—Å–æ–º.*$', line, re.IGNORECASE)
        if ps_na_storoni_povz_match:
            short_region = ps_na_storoni_povz_match.group(1).strip()
            city = ps_na_storoni_povz_match.group(2).strip().rstrip('.,;')
            region = REGION_MAP.get(short_region, None)
            if region:
                city = fix_city_case(city)
                city = city[0].upper() + city[1:] if city else city
                msg = f"–ë–ü–õ–ê {city} ({region})"
                messages.append(msg)
                continue
        
        # –§–æ—Ä–º–∞—Ç –ü–°: "üõµ –ë–ø–õ–ê –∫—É—Ä—Å–æ–º –Ω–∞/–ø–æ–≤–∑ –ú–∏–∫–æ–ª–∞—ó–≤ –∑ –ø—ñ–≤–¥–µ–Ω–Ω–æ–≥–æ –∑–∞—Ö–æ–¥—É."
        ps_kursom_na_match = re.match(r'^[üõµüõ∏\s]*–ë–ø–õ–ê\s+–∫—É—Ä—Å–æ–º\s+(?:–Ω–∞/–ø–æ–≤–∑|–Ω–∞|–ø–æ–≤–∑)\s+(.+?)(?:\s+–∑[—ñ–∏]?\s+.+)?\.?$', line, re.IGNORECASE)
        if ps_kursom_na_match:
            city = ps_kursom_na_match.group(1).strip().rstrip('.')
            city = fix_city_case(city)
            city = city[0].upper() + city[1:] if city else city
            region = CITY_TO_REGION.get(city, None)
            if not region:
                region = await get_region_by_city(city)
            if region:
                msg = f"–ë–ü–õ–ê {city} ({region})"
                messages.append(msg)
                continue
        
        # –§–æ—Ä–º–∞—Ç –ü–°: "üõµ –ë–ø–õ–ê –∑ –ø—ñ–≤–Ω–æ—á—ñ –∫—É—Ä—Å–æ–º –Ω–∞ –•–∞—Ä–∫—ñ–≤."
        ps_z_kursom_match = re.match(r'^[üõµüõ∏\s]*–ë–ø–õ–ê\s+–∑\s+\S+\s+–∫—É—Ä—Å–æ–º\s+–Ω–∞\s+(.+?)\.?$', line, re.IGNORECASE)
        if ps_z_kursom_match:
            city = ps_z_kursom_match.group(1).strip().rstrip('.')
            city = fix_city_case(city)
            city = city[0].upper() + city[1:] if city else city
            region = CITY_TO_REGION.get(city, None)
            if not region:
                region = await get_region_by_city(city)
            if region:
                msg = f"–ë–ü–õ–ê {city} ({region})"
                messages.append(msg)
                continue
        
        # –§–æ—Ä–º–∞—Ç –ü–°: "üõµ –ë–ø–õ–ê –Ω–∞ –î–æ–Ω–µ—á—á–∏–Ω—ñ –∫—É—Ä—Å–æ–º –Ω–∞ –•–∞—Ä–∫—ñ–≤—â–∏–Ω—É (–õ–æ–∑—ñ–≤—Å—å–∫–∏–π —Ä–∞–π–æ–Ω)."
        ps_na_oblast_rayon_match = re.match(r'^[üõµüõ∏\s]*–ë–ø–õ–ê\s+–Ω–∞\s+\S+\s+–∫—É—Ä—Å–æ–º\s+–Ω–∞\s+(\S+)\s*\((.+?)\s*—Ä–∞–π–æ–Ω\)', line, re.IGNORECASE)
        if ps_na_oblast_rayon_match:
            short_region = ps_na_oblast_rayon_match.group(1).strip()
            rayon = ps_na_oblast_rayon_match.group(2).strip()
            region = REGION_MAP.get(short_region, None)
            if region:
                msg = f"–ë–ü–õ–ê {rayon} ({region})"
                messages.append(msg)
                continue
        
        # –§–æ—Ä–º–∞—Ç –ü–°: "üõµ –ë–ø–õ–ê –Ω–∞ –ø—ñ–≤–Ω–æ—á—ñ –ß–µ—Ä–Ω—ñ–≥—ñ–≤—â–∏–Ω–∏ –∫—É—Ä—Å–æ–º –Ω–∞ –°–Ω–æ–≤—Å—å–∫."
        ps_na_pivnochi_match = re.match(r'^[üõµüõ∏\s]*–ë–ø–õ–ê\s+–Ω–∞\s+(?:–ø—ñ–≤–Ω–æ—á—ñ|–ø—ñ–≤–¥–Ω—ñ|–∑–∞—Ö–æ–¥—ñ|—Å—Ö–æ–¥—ñ)\s+(\S+)\s+–∫—É—Ä—Å–æ–º\s+–Ω–∞\s+(.+?)\.?$', line, re.IGNORECASE)
        if ps_na_pivnochi_match:
            short_region = ps_na_pivnochi_match.group(1).strip()
            city = ps_na_pivnochi_match.group(2).strip().rstrip('.')
            region = REGION_MAP.get(short_region, None)
            if region:
                city = fix_city_case(city)
                city = city[0].upper() + city[1:] if city else city
                msg = f"–ë–ü–õ–ê {city} ({region})"
                messages.append(msg)
                continue
        
        # –§–æ—Ä–º–∞—Ç –ü–°: "üõµ –ë–ø–õ–ê –ø–æ–≤–∑ –°–µ–¥–Ω—ñ–≤ –∫—É—Ä—Å–æ–º –Ω–∞ –ß–µ—Ä–Ω—ñ–≥—ñ–≤."
        ps_povz_kursom_match = re.match(r'^[üõµüõ∏\s]*–ë–ø–õ–ê\s+–ø–æ–≤–∑\s+\S+\s+–∫—É—Ä—Å–æ–º\s+–Ω–∞\s+(.+?)\.?$', line, re.IGNORECASE)
        if ps_povz_kursom_match:
            city = ps_povz_kursom_match.group(1).strip().rstrip('.')
            city = fix_city_case(city)
            city = city[0].upper() + city[1:] if city else city
            region = CITY_TO_REGION.get(city, None)
            if not region:
                region = await get_region_by_city(city)
            if region:
                msg = f"–ë–ü–õ–ê {city} ({region})"
                messages.append(msg)
                continue
        
        # –§–æ—Ä–º–∞—Ç –ü–°: "üõµ–•–∞—Ä–∫—ñ–≤—â–∏–Ω–∞: –ë–ø–õ–ê –ø–æ–≤–∑ –Ü–∑—é–º –Ω–∞ —Å—Ö–æ–¥—ñ –ø—ñ–≤–¥–µ–Ω–Ω–æ-–∑–∞—Ö—ñ–¥–Ω–∏–º –∫—É—Ä—Å–æ–º."
        ps_region_povz_match = re.match(r'^[üõµüõ∏\s]*(\S+):\s*–ë–ø–õ–ê\s+–ø–æ–≤–∑\s+(\S+).*$', line, re.IGNORECASE)
        if ps_region_povz_match:
            short_region = ps_region_povz_match.group(1).strip()
            city = ps_region_povz_match.group(2).strip().rstrip('.,;')
            region = REGION_MAP.get(short_region, None)
            if region:
                city = fix_city_case(city)
                city = city[0].upper() + city[1:] if city else city
                msg = f"–ë–ü–õ–ê {city} ({region})"
                messages.append(msg)
                continue
        
        # –§–æ—Ä–º–∞—Ç –ü–°: "üõµ –î–Ω—ñ–ø—Ä–æ–ø–µ—Ç—Ä–æ–≤—â–∏–Ω–∞: –ë–ø–õ–ê –Ω–∞ –ø—ñ–≤–Ω–æ—á—ñ –ü–∞–≤–ª–æ–≥—Ä–∞–¥–∞, –∫—É—Ä—Å - –∑–∞—Ö—ñ–¥–Ω–∏–π"
        ps_region_na_pivnochi_match = re.match(r'^[üõµüõ∏\s]*(\S+):\s*–ë–ø–õ–ê\s+–Ω–∞\s+(?:–ø—ñ–≤–Ω–æ—á—ñ|–ø—ñ–≤–¥–Ω—ñ|–∑–∞—Ö–æ–¥—ñ|—Å—Ö–æ–¥—ñ)\s+(\S+?)(?:,|\s+–∫—É—Ä—Å).*$', line, re.IGNORECASE)
        if ps_region_na_pivnochi_match:
            short_region = ps_region_na_pivnochi_match.group(1).strip()
            city = ps_region_na_pivnochi_match.group(2).strip().rstrip('.,;')
            region = REGION_MAP.get(short_region, None)
            if region:
                city = fix_city_case(city)
                city = city[0].upper() + city[1:] if city else city
                msg = f"–ë–ü–õ–ê {city} ({region})"
                messages.append(msg)
                continue
        
        # –§–æ—Ä–º–∞—Ç –ü–°: "üõµ –ë–ø–õ–ê –Ω–∞/–ø–æ–≤–∑ –û—á–∞–∫—ñ–≤ –Ω–∞ –ú–∏–∫–æ–ª–∞—ó–≤—â–∏–Ω—É"
        ps_na_povz_na_oblast_match = re.match(r'^[üõµüõ∏\s]*–ë–ø–õ–ê\s+(?:–Ω–∞/–ø–æ–≤–∑|–Ω–∞|–ø–æ–≤–∑)\s+(\S+)\s+–Ω–∞\s+(\S+)(?:\s+–∑.+)?\.?$', line, re.IGNORECASE)
        if ps_na_povz_na_oblast_match:
            city = ps_na_povz_na_oblast_match.group(1).strip().rstrip('.,;')
            short_region = ps_na_povz_na_oblast_match.group(2).strip()
            region = REGION_MAP.get(short_region, None)
            if region:
                city = fix_city_case(city)
                city = city[0].upper() + city[1:] if city else city
                msg = f"–ë–ü–õ–ê {city} ({region})"
                messages.append(msg)
                continue
        
        # –§–æ—Ä–º–∞—Ç –ü–°: "üõµ –ë–ø–õ–ê –Ω–∞ –•–∞—Ä–∫—ñ–≤—â–∏–Ω—ñ –≤ –Ω–∞–ø—Ä—è–º–∫—É –Ω.–ø.–í–µ–ª–∏–∫–∏–π –ë—É—Ä–ª—É–∫" –∞–±–æ "üõµ –ë–ø–õ–ê –Ω–∞ –ú–∏–∫–æ–ª–∞—ó–≤—â–∏–Ω—ñ –≤ –Ω–∞–ø—Ä—è–º–∫—É –°–Ω—ñ–≥—É—Ä—ñ–≤–∫–∏"
        ps_na_oblasti_v_napryamku_match = re.match(r'^[üõµüõ∏\s]*–ë–ø–õ–ê\s+–Ω–∞\s+(\S+)\s+–≤\s+–Ω–∞–ø—Ä—è–º–∫—É\s+(?:–Ω\.–ø\.?\s*)?(.+?)(?:\s+–∑[—ñ–∏]?\s+.+)?\.?$', line, re.IGNORECASE)
        if ps_na_oblasti_v_napryamku_match:
            short_region = ps_na_oblasti_v_napryamku_match.group(1).strip()
            city = ps_na_oblasti_v_napryamku_match.group(2).strip().rstrip('.')
            region = REGION_MAP.get(short_region, None)
            if region:
                city = fix_city_case(city)
                city = city[0].upper() + city[1:] if city else city
                message = f"–ë–ü–õ–ê {city} ({region})"
                messages.append(message)
                continue
        
        # –§–æ—Ä–º–∞—Ç: "üß®–ó–∞–≥—Ä–æ–∑–∞ –∑–∞—Å—Ç–æ—Å—É–≤–∞–Ω–Ω—è –±–∞–ª—ñ—Å—Ç–∏—á–Ω–æ–≥–æ –æ–∑–±—Ä–æ—î–Ω–Ω—è" - –±–∞–ª—ñ—Å—Ç–∏—á–Ω–∞ –∑–∞–≥—Ä–æ–∑–∞
        balistyka_match = re.search(r'–∑–∞–≥—Ä–æ–∑–∞\s+(?:–∑–∞—Å—Ç–æ—Å—É–≤–∞–Ω–Ω—è\s+)?–±–∞–ª—ñ—Å—Ç–∏—á', line, re.IGNORECASE)
        if balistyka_match:
            msg = "–ë–∞–ª—ñ—Å—Ç–∏–∫–∞ (–£–∫—Ä–∞—ó–Ω–∞)"
            messages.append(msg)
            continue
        
        # –§–æ—Ä–º–∞—Ç: "‚ö™Ô∏è–í—ñ–¥–±—ñ–π –∑–∞–≥—Ä–æ–∑–∏ –∑–∞—Å—Ç–æ—Å—É–≤–∞–Ω–Ω—è –±–∞–ª—ñ—Å—Ç–∏—á–Ω–æ–≥–æ –æ–∑–±—Ä–æ—î–Ω–Ω—è" - –≤—ñ–¥–±—ñ–π –±–∞–ª—ñ—Å—Ç–∏—á–Ω–æ—ó –∑–∞–≥—Ä–æ–∑–∏ (–ø—Ä–æ–ø—É—Å–∫–∞—î–º–æ)
        vidbiy_balistyka_match = re.search(r'–≤—ñ–¥–±—ñ–π\s+–∑–∞–≥—Ä–æ–∑[–∏—ñ]\s+(?:–∑–∞—Å—Ç–æ—Å—É–≤–∞–Ω–Ω—è\s+)?–±–∞–ª—ñ—Å—Ç–∏—á', line, re.IGNORECASE)
        if vidbiy_balistyka_match:
            continue
        
        # –§–æ—Ä–º–∞—Ç: "ÔøΩ –†–∞–∫–µ—Ç–∞ –∫—É—Ä—Å–æ–º –Ω–∞ –ö–∏—ó–≤" –∞–±–æ "–ö—Ä–∏–ª–∞—Ç–∞ —Ä–∞–∫–µ—Ç–∞ –Ω–∞ –•–∞—Ä–∫—ñ–≤"
        raketa_match = re.match(r'^[üöÄüî¥‚ö†Ô∏è‚ùóÔ∏è\s]*(?:–∫—Ä–∏–ª–∞—Ç[–∞—ñ]?\s+)?—Ä–∞–∫–µ—Ç[–∞–∏]?\s+(?:–∫—É—Ä—Å–æ–º\s+)?(?:–Ω–∞|–≤ –Ω–∞–ø—Ä—è–º–∫—É)\s+(.+?)(?:\s+–∑.+)?[!\.]*$', line, re.IGNORECASE)
        if raketa_match:
            city = raketa_match.group(1).strip().rstrip('.')
            city = fix_city_case(city)
            city = city[0].upper() + city[1:] if city else city
            region = CITY_TO_REGION.get(city, None)
            if not region:
                region = await get_region_by_city(city)
            if region:
                msg = f"–†–∞–∫–µ—Ç–∞ {city} ({region})"
                messages.append(msg)
                continue
        
        # –§–æ—Ä–º–∞—Ç: "ÔøΩüí£ –ö—Ä–∞–º–∞—Ç–æ—Ä—Å—å–∫–∏–π —Ä–∞–π–æ–Ω (–î–æ–Ω–µ—Ü—å–∫–∞ –æ–±–ª.)" - –ö–ê–ë–∏ –ø–æ —Ä–∞–π–æ–Ω—É (—Ç—ñ–ª—å–∫–∏ –∑ emoji üí£)
        if 'üí£' in line:
            kab_rayon_match = re.match(r'^[üí£\s]*(.+?)\s+—Ä–∞–π–æ–Ω\s*\((.+?–æ–±–ª\.?)\)', line, re.IGNORECASE)
            if kab_rayon_match:
                rayon = kab_rayon_match.group(1).strip()
                region = kab_rayon_match.group(2).strip()
                rayon = rayon[0].upper() + rayon[1:] if rayon else rayon
                region = region[0].upper() + region[1:] if region else region
                if not region.endswith('.'):
                    region = region + '.'
                msg = f"–ö–ê–ë {rayon} ({region})"
                messages.append(msg)
                continue
        
        # –§–æ—Ä–º–∞—Ç: "‚ö†Ô∏è2—Ö –®–∞—Ö–µ–¥–∏ –Ω–∞ –ó–∞–ø–æ—Ä—ñ–∂–∂—è!" - –®–∞—Ö–µ–¥–∏/—à–∞—Ö–µ–¥ –Ω–∞ –º—ñ—Å—Ç–æ
        shahedy_na_match = re.match(r'^[‚ö†Ô∏è‚ùóÔ∏èüî¥\s]*(\d+)\s*—Ö?\s*(?:–®–∞—Ö–µ–¥[–∏—ñ]?|—à–∞—Ö–µ–¥[–∏—ñ]?)\s+–Ω–∞\s+(.+?)[!\.]*$', line, re.IGNORECASE)
        if shahedy_na_match:
            city = shahedy_na_match.group(2).strip()
            city = fix_city_case(city)
            city = city[0].upper() + city[1:] if city else city
            region = CITY_TO_REGION.get(city, None)
            if not region:
                region = await get_region_by_city(city)
            if region:
                msg = f"–ë–ü–õ–ê {city} ({region})"
                messages.append(msg)
                continue
        
        # –§–æ—Ä–º–∞—Ç –ü–°: "üõµ –ë–ø–õ–ê –∑ –ú–∏–∫–æ–ª–∞—ó–≤—â–∏–Ω–∏ –∫—É—Ä—Å–æ–º –Ω–∞ –û–¥–µ—â–∏–Ω—É (–≤–µ–∫—Ç–æ—Ä - –î–æ–±—Ä–æ—Å–ª–∞–≤)"
        ps_z_oblasti_vektor_match = re.match(r'^[üõµüõ∏\s]*(?:–ì—Ä—É–ø–∞\s+)?–ë–ø–õ–ê\s+(?:–∑\s+\S+\s+)?–∫—É—Ä—Å–æ–º\s+–Ω–∞\s+(\S+)(?:\s+–∑.+?)?\s*\(–≤–µ–∫—Ç–æ—Ä\s*[-‚Äì‚Äî]\s*(.+?)\)', line, re.IGNORECASE)
        if ps_z_oblasti_vektor_match:
            short_region = ps_z_oblasti_vektor_match.group(1).strip()
            city = ps_z_oblasti_vektor_match.group(2).strip().rstrip('.')
            region = REGION_MAP.get(short_region, None)
            if region:
                city = fix_city_case(city)
                city = city[0].upper() + city[1:] if city else city
                msg = f"–ë–ü–õ–ê {city} ({region})"
                messages.append(msg)
                continue
        
        # –§–æ—Ä–º–∞—Ç –ü–°: "üõµ–ë–ø–õ–ê –Ω–∞ –ù—ñ–∫–æ–ø–æ–ª—å—Å—å–∫–∏–π —Ä-–Ω –î–Ω—ñ–ø—Ä–æ–ø–µ—Ç—Ä–æ–≤—â–∏–Ω–∏"
        ps_na_rayon_oblasti_match = re.match(r'^[üõµüõ∏\s]*–ë–ø–õ–ê\s+–Ω–∞\s+(\S+)\s+—Ä-–Ω\s+(\S+)(?:\s+–∑.+)?\.?$', line, re.IGNORECASE)
        if ps_na_rayon_oblasti_match:
            rayon = ps_na_rayon_oblasti_match.group(1).strip()
            short_region = ps_na_rayon_oblasti_match.group(2).strip()
            region = REGION_MAP.get(short_region, None)
            if region:
                # –í–∏–ø—Ä–∞–≤–ª—è—î–º–æ –≤—ñ–¥–º—ñ–Ω–æ–∫ —Ä–∞–π–æ–Ω—É (–ù—ñ–∫–æ–ø–æ–ª—å—Å—å–∫–∏–π -> –ù—ñ–∫–æ–ø–æ–ª—å—Å—å–∫–∏–π)
                msg = f"–ë–ü–õ–ê {rayon} ({region})"
                messages.append(msg)
                continue
        
        # –§–æ—Ä–º–∞—Ç –ü–°: "üõµ –î–Ω—ñ–ø—Ä–æ–ø–µ—Ç—Ä–æ–≤—â–∏–Ω–∞: –ë–ø–õ–ê –≤ –Ω–∞–ø—Ä—è–º–∫—É –ó–µ–ª–µ–Ω–æ–¥–æ–ª—å—Å—å–∫–∞ —Ç–∞ –ö—Ä–∏–≤–æ–≥–æ –†–æ–≥—É"
        ps_region_ta_match = re.match(r'^[üõµüõ∏\s]*(\S+):\s*–ë–ø–õ–ê\s+–≤\s+–Ω–∞–ø—Ä—è–º–∫—É\s+(.+?)\s+—Ç–∞\s+(.+?)(?:\s+–∑[—ñ–∏]?\s+.+)?\.?$', line, re.IGNORECASE)
        if ps_region_ta_match:
            short_region = ps_region_ta_match.group(1).strip()
            city1 = ps_region_ta_match.group(2).strip().rstrip('.,;')
            city2 = ps_region_ta_match.group(3).strip().rstrip('.,;')
            region = REGION_MAP.get(short_region, None)
            if region:
                for city in [city1, city2]:
                    city = fix_city_case(city)
                    city = city[0].upper() + city[1:] if city else city
                    msg = f"–ë–ü–õ–ê {city} ({region})"
                    messages.append(msg)
                continue
        
        # –§–æ—Ä–º–∞—Ç –ü–°: "üõµ–ó–º—ñ–Ω–∏–≤ –∫—É—Ä—Å –Ω–∞ –†—ñ–ø–∫–∏." - –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ current_region
        ps_zminiv_kurs_match = re.match(r'^[üõµüõ∏\s]*–ó–º—ñ–Ω–∏–≤\s+–∫—É—Ä—Å\s+–Ω–∞\s+(.+?)\.?$', line, re.IGNORECASE)
        if ps_zminiv_kurs_match:
            city = ps_zminiv_kurs_match.group(1).strip().rstrip('.')
            city = fix_city_case(city)
            city = city[0].upper() + city[1:] if city else city
            region = current_region
            if not region:
                region = CITY_TO_REGION.get(city, None)
            if not region:
                region = await get_region_by_city(city)
            if region:
                msg = f"–ë–ü–õ–ê {city} ({region})"
                messages.append(msg)
                continue
        
        # –§–æ—Ä–º–∞—Ç 0: "–±–ø–ª–∞ –º—ñ—Å—Ç–æ –ø–æ –º–µ–∂—ñ (–æ–±–ª–∞—Å—Ç—å) –∑–∞–≥—Ä–æ–∑–∞..." - –∑ "–ø–æ –º–µ–∂—ñ" –∞–±–æ –ø–æ–¥—ñ–±–Ω–∏–º–∏ —Ñ—Ä–∞–∑–∞–º–∏
        # –ù–∞–ø—Ä–∏–∫–ª–∞–¥: "–±–ø–ª–∞ –±—Ä—É—Å–∏–ª—ñ–≤ –ø–æ –º–µ–∂—ñ (–∂–∏—Ç–æ–º–∏—Ä—Å—å–∫–∞ –æ–±–ª.) –∑–∞–≥—Ä–æ–∑–∞ –∑–∞—Å—Ç–æ—Å—É–≤–∞–Ω–Ω—è –±–ø–ª–∞."
        po_mezhi_match = re.match(r'^[üí•üõ∏üõµ‚ö†Ô∏è‚ùóÔ∏èüî¥üëÅÔ∏è\s]*(–±–ø–ª–∞|–ë–ø–õ–ê|–ë–ü–õ–ê)?\s*(\d*—Ö?\s*)?(.+?)\s+(?:–ø–æ –º–µ–∂—ñ|–Ω–∞ –º–µ–∂—ñ|–±—ñ–ª—è –º–µ–∂—ñ|–≤ –Ω–∞–ø—Ä—è–º–∫—É|–≤ —Ä–∞–π–æ–Ω—ñ)\s*\((.+?–æ–±–ª\.?)\)', line, re.IGNORECASE)
        if po_mezhi_match:
            quantity = po_mezhi_match.group(2) or ''
            quantity = quantity.strip()
            if quantity and not quantity.endswith('—Ö'):
                quantity = quantity + '—Ö'
            if quantity:
                quantity = quantity + ' '
            city = po_mezhi_match.group(3).strip()
            # –í–∏–¥–∞–ª—è—î–º–æ "–±–ø–ª–∞" –∑ –Ω–∞–∑–≤–∏ –º—ñ—Å—Ç–∞ —è–∫—â–æ –∑–∞–ª–∏—à–∏–ª–æ—Å—å
            city = re.sub(r'^(–±–ø–ª–∞|–ë–ø–õ–ê|–ë–ü–õ–ê)\s*', '', city, flags=re.IGNORECASE).strip()
            # –í–∏–¥–∞–ª—è—î–º–æ "–Ω–∞" —è–∫—â–æ –∑–∞–ª–∏—à–∏–ª–æ—Å—å
            city = re.sub(r'^–Ω–∞\s*$', '', city, flags=re.IGNORECASE).strip()
            # –ü—Ä–æ–ø—É—Å–∫–∞—î–º–æ —è–∫—â–æ –º—ñ—Å—Ç–æ –ø–æ—Ä–æ–∂–Ω—î –∞–±–æ –∑–∞–Ω–∞–¥—Ç–æ –∫–æ—Ä–æ—Ç–∫–µ
            if not city or len(city) < 2:
                continue
            # –í–∏–ø—Ä–∞–≤–ª—è—î–º–æ –≤—ñ–¥–º—ñ–Ω–æ–∫
            city = fix_city_case(city)
            # Capitalize –ø–µ—Ä—à—É –ª—ñ—Ç–µ—Ä—É –º—ñ—Å—Ç–∞
            city = city[0].upper() + city[1:] if city else city
            region = po_mezhi_match.group(4).strip()
            # Capitalize –æ–±–ª–∞—Å—Ç—å
            region = region[0].upper() + region[1:] if region else region
            if not region.endswith('.'):
                region = region + '.'
            
            msg = f"–ë–ü–õ–ê {city} ({region})"
            messages.append(msg)
            continue
        
        # –§–æ—Ä–º–∞—Ç 0.5: "–ë–ü–õ–ê –∑ –û–±–ª–∞—Å—Ç—ñ –∫—É—Ä—Å–æ–º –Ω–∞ –û–±–ª–∞—Å—Ç—å (–†–∞–π–æ–Ω —Ä–∞–π–æ–Ω –æ–±–ª.)" 
        # –ù–∞–ø—Ä–∏–∫–ª–∞–¥: "–ë–ü–õ–ê –∑ –ß–µ—Ä–Ω—ñ–≥—ñ–≤—â–∏–Ω–∏ –∫—É—Ä—Å–æ–º –Ω–∞ –ö–∏—ó–≤—â–∏–Ω—É (–í–∏—à–≥–æ—Ä–æ–¥—Å—å–∫–∏–π —Ä–∞–π–æ–Ω –æ–±–ª.)"
        # –ê–±–æ: "–ë–ü–õ–ê –î–æ–Ω–µ—á—á–∏–Ω—ñ –∫—É—Ä—Å–æ–º –Ω–∞ –•–∞—Ä–∫—ñ–≤—â–∏–Ω—É (–õ–æ–∑—ñ–≤—Å—å–∫–∏–π —Ä–∞–π–æ–Ω –æ–±–ª.)"
        z_oblasti_rayon_match = re.match(r'^[üí•üõ∏üõµ‚ö†Ô∏è‚ùóÔ∏èüî¥üëÅÔ∏è\s]*(\d*—Ö?\s*)?(–±–ø–ª–∞|–ë–ø–õ–ê|–ë–ü–õ–ê)\s+(?:–∑\s+)?\S+\s+–∫—É—Ä—Å–æ–º\s+–Ω–∞\s+(\S+)\s*\((.+?)\s+—Ä–∞–π–æ–Ω\s*–æ–±–ª\.?\)', line, re.IGNORECASE)
        if z_oblasti_rayon_match:
            quantity = z_oblasti_rayon_match.group(1) or ''
            quantity = quantity.strip()
            if quantity and not quantity.endswith('—Ö'):
                quantity = quantity + '—Ö'
            if quantity:
                quantity = quantity + ' '
            short_region = z_oblasti_rayon_match.group(3).strip()
            rayon = z_oblasti_rayon_match.group(4).strip()
            # –ö–æ–Ω–≤–µ—Ä—Ç—É—î–º–æ —Å–∫–æ—Ä–æ—á–µ–Ω—É –Ω–∞–∑–≤—É –æ–±–ª–∞—Å—Ç—ñ –≤ –ø–æ–≤–Ω—É
            region = REGION_MAP.get(short_region, None)
            # –Ø–∫—â–æ –Ω–µ –∑–Ω–∞–π—à–ª–∏, –ø—Ä–æ–±—É—î–º–æ –±–µ–∑ –∑–∞–∫—ñ–Ω—á–µ–Ω–Ω—è (–ö–∏—ó–≤—â–∏–Ω—É -> –ö–∏—ó–≤—â–∏–Ω–∞)
            if not region:
                short_region_fixed = fix_city_case(short_region)
                region = REGION_MAP.get(short_region_fixed, short_region_fixed + ' –æ–±–ª.')
            
            message = f"{quantity}–ë–ü–õ–ê {rayon} —Ä–∞–π–æ–Ω ({region})"
            messages.append(message)
            continue
        
        # –§–æ—Ä–º–∞—Ç: "7—Ö –ë–ø–õ–ê –≤ –ü–æ–∫—Ä–æ–≤—Å—å–∫–æ–º—É —Ä–∞–π–æ–Ω—ñ (–ö–∏—ó–≤—Å—å–∫–∞ –æ–±–ª.)" - –∫—ñ–ª—å–∫—ñ—Å—Ç—å + —Ä–∞–π–æ–Ω + –æ–±–ª–∞—Å—Ç—å
        v_rayoni_match = re.match(r'^[üí•üõ∏üõµ‚ö†Ô∏è‚ùóÔ∏èüî¥üëÅÔ∏è\s]*(\d+)\s*—Ö?\s*(?:–ë–ø–õ–ê|–ë–ü–õ–ê)?\s*(?:–≤|—É)\s+(.+?)\s+—Ä–∞–π–æ–Ω[—ñ—É]?\s*\((.+?–æ–±–ª\.?)\)', line, re.IGNORECASE)
        if v_rayoni_match:
            rayon = v_rayoni_match.group(2).strip()
            region = v_rayoni_match.group(3).strip()
            # Capitalize
            rayon = rayon[0].upper() + rayon[1:] if rayon else rayon
            region = region[0].upper() + region[1:] if region else region
            if not region.endswith('.'):
                region = region + '.'
            msg = f"–ë–ü–õ–ê {rayon} ({region})"
            messages.append(msg)
            continue
        
        # –§–æ—Ä–º–∞—Ç: "–ë–ø–õ–ê –≤ –ü–æ–∫—Ä–æ–≤—Å—å–∫–æ–º—É —Ä–∞–π–æ–Ω—ñ (–ö–∏—ó–≤—Å—å–∫–∞ –æ–±–ª.)" - –±–µ–∑ –∫—ñ–ª—å–∫–æ—Å—Ç—ñ
        v_rayoni_no_qty_match = re.match(r'^[üí•üõ∏üõµ‚ö†Ô∏è‚ùóÔ∏èüî¥üëÅÔ∏è\s]*(?:–ë–ø–õ–ê|–ë–ü–õ–ê)\s+(?:–≤|—É)\s+(.+?)\s+—Ä–∞–π–æ–Ω[—ñ—É]?\s*\((.+?–æ–±–ª\.?)\)', line, re.IGNORECASE)
        if v_rayoni_no_qty_match:
            rayon = v_rayoni_no_qty_match.group(1).strip()
            region = v_rayoni_no_qty_match.group(2).strip()
            # Capitalize
            rayon = rayon[0].upper() + rayon[1:] if rayon else rayon
            region = region[0].upper() + region[1:] if region else region
            if not region.endswith('.'):
                region = region + '.'
            msg = f"–ë–ü–õ–ê {rayon} ({region})"
            messages.append(msg)
            continue
        
        # –§–æ—Ä–º–∞—Ç 1: "üí• –ú–∞—Ä–≥–∞–Ω–µ—Ü—å (–î–Ω—ñ–ø—Ä–æ–ø–µ—Ç—Ä–æ–≤—Å—å–∫–∞ –æ–±–ª.)" –∞–±–æ "üõ∏ –ß–µ—Ä–Ω—ñ–≥—ñ–≤ (–ß–µ—Ä–Ω—ñ–≥—ñ–≤—Å—å–∫–∞ –æ–±–ª.)"
        # –ì–æ—Ç–æ–≤—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∑ –º—ñ—Å—Ç–æ–º —Ç–∞ –æ–±–ª–∞—Å—Ç—é (–º–æ–∂–µ –±—É—Ç–∏ —Ç–µ–∫—Å—Ç –ø—ñ—Å–ª—è –æ–±–ª–∞—Å—Ç—ñ)
        ready_match = re.match(r'^[üí•üõ∏üõµ‚ö†Ô∏è‚ùóÔ∏èüî¥üëÅÔ∏è\s]*(.+?)\s*\((.+?–æ–±–ª\.?)\)', line, re.IGNORECASE)
        if ready_match:
            city = ready_match.group(1).strip()
            # –ü—Ä–æ–ø—É—Å–∫–∞—î–º–æ —è–∫—â–æ —Ü–µ —Ñ–æ—Ä–º–∞—Ç –∑ —Ä–∞–π–æ–Ω–æ–º (–≤–∂–µ –æ–±—Ä–æ–±–ª–µ–Ω–æ –≤–∏—â–µ)
            if re.search(r'—Ä–∞–π–æ–Ω[—ñ—É]?\s*$', city, re.IGNORECASE):
                continue
            # –í–∏–¥–∞–ª—è—î–º–æ emoji –∑ –Ω–∞–∑–≤–∏ –º—ñ—Å—Ç–∞
            city = re.sub(r'^[üí•üõ∏üõµ‚ö†Ô∏è‚ùóÔ∏èüî¥üëÅÔ∏è\*\s]+', '', city).strip()
            city = re.sub(r'[\*]+', '', city).strip()
            # –í–∏–¥–∞–ª—è—î–º–æ "–±–ø–ª–∞" –∑ –Ω–∞–∑–≤–∏ –º—ñ—Å—Ç–∞
            city = re.sub(r'^(–±–ø–ª–∞|–ë–ø–õ–ê|–ë–ü–õ–ê)\s*', '', city, flags=re.IGNORECASE).strip()
            # –í–∏–¥–∞–ª—è—î–º–æ –∫—ñ–ª—å–∫—ñ—Å—Ç—å –Ω–∞ –ø–æ—á–∞—Ç–∫—É (7—Ö, 3—Ö —Ç–æ—â–æ)
            city = re.sub(r'^\d+\s*—Ö?\s*', '', city).strip()
            # –í–∏–¥–∞–ª—è—î–º–æ –ø–æ–≤—Ç–æ—Ä–Ω–µ "–±–ø–ª–∞" –ø—ñ—Å–ª—è –∫—ñ–ª—å–∫–æ—Å—Ç—ñ
            city = re.sub(r'^(–±–ø–ª–∞|–ë–ø–õ–ê|–ë–ü–õ–ê)\s*', '', city, flags=re.IGNORECASE).strip()
            # –í–∏–¥–∞–ª—è—î–º–æ "–≤ —Ä–∞–π–æ–Ω—ñ", "–ø–æ –º–µ–∂—ñ", "—É –Ω–∞–ø—Ä—è–º–∫—É", "–≤ –Ω–∞–ø—Ä—è–º–∫—É" —Ç–æ—â–æ –Ω–∞ –ø–æ—á–∞—Ç–∫—É
            city = re.sub(r'^(\d*—Ö?\s*)?(–≤ —Ä–∞–π–æ–Ω—ñ|–ø–æ –º–µ–∂—ñ|–Ω–∞ –º–µ–∂—ñ|–±—ñ–ª—è –º–µ–∂—ñ|[—É—ñ–≤]\s+–Ω–∞–ø—Ä—è–º–∫—É|–Ω–∞)\s+', '', city, flags=re.IGNORECASE).strip()
            # –í–∏–¥–∞–ª—è—î–º–æ "–∑ –º–æ—Ä—è", "–∑ –æ–±–ª–∞—Å—Ç—ñ", "–∑—ñ —Å—Ö–æ–¥—É" —Ç–æ—â–æ –≤ –∫—ñ–Ω—Ü—ñ
            city = re.sub(r'\s+–∑[—ñ–∏]?\s+\S+$', '', city, flags=re.IGNORECASE).strip()
            # –í–∏–¥–∞–ª—è—î–º–æ "‚û°Ô∏è –∫—É—Ä—Å–æ–º –Ω–∞ ...", "–∫—É—Ä—Å–æ–º –Ω–∞ ..." –≤ –∫—ñ–Ω—Ü—ñ
            city = re.sub(r'\s*‚û°Ô∏è?\s*–∫—É—Ä—Å–æ–º\s+–Ω–∞\s+.+$', '', city, flags=re.IGNORECASE).strip()
            # –ü—Ä–æ–ø—É—Å–∫–∞—î–º–æ —è–∫—â–æ "–º—ñ—Å—Ç–æ" –Ω–∞—Å–ø—Ä–∞–≤–¥—ñ —î –Ω–∞–∑–≤–æ—é –æ–±–ª–∞—Å—Ç—ñ
            is_region_name = False
            for region_key in REGION_MAP.keys():
                if city.lower() == region_key.lower() or city.lower().rstrip('–∞–∏—É—ñ—ó–µ—é') == region_key.lower().rstrip('–∞–∏—É—ñ—ó–µ—é'):
                    is_region_name = True
                    break
            if is_region_name:
                continue
            # –ü—Ä–æ–ø—É—Å–∫–∞—î–º–æ —è–∫—â–æ –º—ñ—Å—Ç–æ –º—ñ—Å—Ç–∏—Ç—å –¥—ñ—î—Å–ª–æ–≤–∞ –∞–±–æ —Ñ—Ä–∞–∑–∏ (–Ω–µ –Ω–∞–∑–≤–∞ –º—ñ—Å—Ç–∞)
            skip_words = ['–∫—Ä—É–∂–ª—è—é—Ç—å', '–∫—Ä—É–∂–ª—è—î', '–ª–µ—Ç–∏—Ç—å', '–ª–µ—Ç—è—Ç—å', '—Ä—É—Ö–∞—î—Ç—å—Å—è', '—Ä—É—Ö–∞—é—Ç—å—Å—è', 
                         '–∫—É—Ä—Å–æ–º', '–Ω–∞ –º–µ–∂—ñ', '–ø–æ –º–µ–∂—ñ', '–≤ –Ω–∞–ø—Ä—è–º–∫—É', '—É –Ω–∞–ø—Ä—è–º–∫—É', '–ø–æ–≤–∑',
                         '–∑–º—ñ–Ω–∏–≤', '–∑–º—ñ–Ω—é—î', '–∑–∞–π—à–æ–≤', '–∑–∞–π—à–ª–∏', '–≤–∏–π—à–æ–≤', '–≤–∏–π—à–ª–∏']
            should_skip = False
            for skip_word in skip_words:
                if skip_word.lower() in city.lower():
                    should_skip = True
                    break
            if should_skip or len(city) < 2:
                continue
            # –í–∏–ø—Ä–∞–≤–ª—è—î–º–æ –≤—ñ–¥–º—ñ–Ω–æ–∫
            city = fix_city_case(city)
            # Capitalize –ø–µ—Ä—à—É –ª—ñ—Ç–µ—Ä—É –º—ñ—Å—Ç–∞
            city = city[0].upper() + city[1:] if city else city
            region = ready_match.group(2).strip()
            # –í–∏–¥–∞–ª—è—î–º–æ "–Ω.–ø." –∑ –æ–±–ª–∞—Å—Ç—ñ
            region = re.sub(r'^–Ω\.–ø\.?\s*', '', region, flags=re.IGNORECASE).strip()
            # Capitalize –æ–±–ª–∞—Å—Ç—å
            region = region[0].upper() + region[1:] if region else region
            if not region.endswith('.'):
                region = region + '.'
            
            msg = f"–ë–ü–õ–ê {city} ({region})"
            messages.append(msg)
            continue
        
        # –§–æ—Ä–º–∞—Ç 2: "üõ∏ –®–∞—Ö–µ–¥ –∫—É—Ä—Å–æ–º –Ω–∞ –ü—ñ–≤–¥–µ–Ω–Ω–æ—É–∫—Ä–∞—ó–Ω—Å—å–∫ (–ú–∏–∫–æ–ª–∞—ó–≤—â–∏–Ω–∞)" –∞–±–æ "üõ∏ 3 –®–∞—Ö–µ–¥–∞ –∫—É—Ä—Å–æ–º –Ω–∞ –ó–∞–ø–æ—Ä—ñ–∂–∂—è (–î–Ω—ñ–ø—Ä–æ–ø–µ—Ç—Ä–æ–≤—â–∏–Ω–∞)"
        course_match = re.match(r'^[üí•üõ∏üõµ‚ö†Ô∏è‚ùóÔ∏èüî¥üëÅÔ∏è\s]*(\d*)\s*[–®—à]–∞—Ö–µ–¥[—ñ–∏—ñ–≤–∞]*\s+–∫—É—Ä—Å–æ–º\s+–Ω–∞\s+(.+?)\s*\((.+?)\)', line, re.IGNORECASE)
        if course_match:
            city = course_match.group(2).strip()
            short_region = course_match.group(3).strip()
            
            # –ö–æ–Ω–≤–µ—Ä—Ç—É—î–º–æ —Å–∫–æ—Ä–æ—á–µ–Ω—É –Ω–∞–∑–≤—É –æ–±–ª–∞—Å—Ç—ñ –≤ –ø–æ–≤–Ω—É
            region = REGION_MAP.get(short_region, short_region + ' –æ–±–ª.')
            
            msg = f"–ë–ü–õ–ê {city} ({region})"
            messages.append(msg)
            continue
        
        # –§–æ—Ä–º–∞—Ç 3: "‚ö†Ô∏è2—Ö –ë–ø–õ–ê –Ω–∞ –®–æ—Å—Ç–∫—É (–°—É–º—â–∏–Ω–∞)" - –º—ñ—Å—Ç–æ —ñ —Å–∫–æ—Ä–æ—á–µ–Ω–∞ –æ–±–ª–∞—Å—Ç—å –≤ –¥—É–∂–∫–∞—Ö
        short_region_match = re.match(r'^[üí•üõ∏üõµ‚ö†Ô∏è‚ùóÔ∏èüî¥üëÅÔ∏è\s]*(\d*—Ö?\s*)?(–ë–ø–õ–ê|–ë–ü–õ–ê|—à–∞—Ö–µ–¥[—ñ–∏—ñ–≤]*)\s+(?:–Ω–∞\s+)?(.+?)\s*\((.+?)\)', line, re.IGNORECASE)
        if short_region_match:
            city = short_region_match.group(3).strip()
            short_region = short_region_match.group(4).strip()
            
            # –ö–æ–Ω–≤–µ—Ä—Ç—É—î–º–æ —Å–∫–æ—Ä–æ—á–µ–Ω—É –Ω–∞–∑–≤—É –æ–±–ª–∞—Å—Ç—ñ –≤ –ø–æ–≤–Ω—É
            region = REGION_MAP.get(short_region, short_region + ' –æ–±–ª.')
            
            msg = f"–ë–ü–õ–ê {city} ({region})"
            messages.append(msg)
            continue
        
        # –§–æ—Ä–º–∞—Ç 3: "‚ö†Ô∏è8—Ö –ë–ø–õ–ê –ø–æ–≤–∑ –ö—Ä–∏–≤–∏–π —Ä—ñ–≥ –Ω–∞ –ö—ñ—Ä–æ–≤–æ–≥—Ä–∞–¥—â–∏–Ω—É" - –º—ñ—Å—Ç–æ —ñ –æ–±–ª–∞—Å—Ç—å –≤ —Ç–µ–∫—Å—Ç—ñ
        direction_match = re.match(r'^[üí•üõ∏üõµ‚ö†Ô∏è‚ùóÔ∏èüî¥üëÅÔ∏è\s]*(\d*—Ö?\s*)?(–ë–ø–õ–ê|–ë–ü–õ–ê|—à–∞—Ö–µ–¥[—ñ–∏—ñ–≤]*)\s+(?:–ø–æ–≤–∑|–Ω–∞|–∫—É—Ä—Å–æ–º –Ω–∞)\s+(.+?)\s+(?:–Ω–∞|–≤|–¥–æ)\s+(.+?)$', line, re.IGNORECASE)
        if direction_match:
            city = direction_match.group(3).strip()
            short_region = direction_match.group(4).strip()
            
            # –ö–æ–Ω–≤–µ—Ä—Ç—É—î–º–æ —Å–∫–æ—Ä–æ—á–µ–Ω—É –Ω–∞–∑–≤—É –æ–±–ª–∞—Å—Ç—ñ –≤ –ø–æ–≤–Ω—É
            region = REGION_MAP.get(short_region, None)
            if not region and city in CITY_TO_REGION:
                region = CITY_TO_REGION[city]
            
            if region:
                msg = f"–ë–ü–õ–ê {city} ({region})"
                messages.append(msg)
            continue
        
        # –§–æ—Ä–º–∞—Ç: üõµ5—Ö –®–∞—Ö–µ–¥—ñ–≤ –Ω–∞ –ö—Ä–∏–≤–∏–π –†—ñ–≥! –∞–±–æ üõµ–í–∂–µ 5—Ö –®–∞—Ö–µ–¥—ñ–≤ –Ω–∞ –º—ñ—Å—Ç–æ!
        shahedy_na_match = re.match(r'^[üõµüõ∏üí•‚ö†Ô∏è‚ùóÔ∏è\s]*(?:–í–∂–µ\s+)?(\d+)—Ö?\s*[–®—à]–∞—Ö–µ–¥[—ñ–∏—ñ–≤–∞]*\s+–Ω–∞\s+(.+?)!?$', line, re.IGNORECASE)
        if shahedy_na_match:
            city = await split_cities(shahedy_na_match.group(2).strip().rstrip('!'))
            region = current_region
            if not region:
                region = await get_region_by_city(city)
            if region:
                msg = f"–ë–ü–õ–ê {city} ({region})"
                messages.append(msg)
            continue
        
        # –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ —Ü–µ —Ä–µ–≥—ñ–æ–Ω (üì°–•–∞—Ä–∫—ñ–≤—â–∏–Ω–∞: –∞–±–æ –ø—Ä–æ—Å—Ç–æ –•–∞—Ä–∫—ñ–≤—â–∏–Ω–∞: –∞–±–æ ‚úàÔ∏è–î–Ω—ñ–ø—Ä–æ–ø–µ—Ç—Ä–æ–≤—â–∏–Ω–∞:)
        is_region = False
        region_header_match = re.match(r'^[üì°‚ö†Ô∏èüî¥‚úàÔ∏è\s]*([^:]+):', line)
        if region_header_match:
            potential_region = region_header_match.group(1).strip()
            for region_key in REGION_MAP.keys():
                if region_key in potential_region:
                    current_region = REGION_MAP[region_key]
                    is_region = True
                    break
            # –°–ø–µ—Ü—ñ–∞–ª—å–Ω–∏–π –≤–∏–ø–∞–¥–æ–∫ –¥–ª—è "–ó–∞–ø–æ—Ä—ñ–∑—å–∫–∞ –æ–±–ª–∞—Å—Ç—å"
            if '–ó–∞–ø–æ—Ä—ñ–∑—å–∫' in potential_region:
                current_region = '–ó–∞–ø–æ—Ä—ñ–∑—å–∫–∞ –æ–±–ª.'
                is_region = True
        
        if is_region:
            continue
        
        # –§–æ—Ä–º–∞—Ç: ‚úàÔ∏è –ë–ü–õA "–ú–æ–ª–Ω—ñ—è"‚Üí–ú–∏–∫–æ–ª–∞—ó–≤/—Ä-–Ω –∞–±–æ ‚úàÔ∏è –ë–ü–õ–ê "–ì–µ—Ä–∞–Ω—å"‚Üí–ö–∏—ó–≤
        bpla_type_match = re.match(r'^[‚úàÔ∏èüõ∏üõµ\s]*(–ë–ü–õ–ê?|–ë–ø–õ–ê)\s*["\¬´]?([^"¬ª\‚Üí]+)["\¬ª]?\s*[‚Üí‚û°Ô∏è]\s*(.+?)(?:/(?:—Ä-–Ω|—Ä–∞–π–æ–Ω|–æ–∫–æ–ª–∏—Ü[—ñ–∏]))?\s*$', line, re.IGNORECASE)
        if bpla_type_match:
            bpla_type = bpla_type_match.group(2).strip()
            city = bpla_type_match.group(3).strip()
            city = city.rstrip('.')
            city = fix_city_case(city)
            city = city[0].upper() + city[1:] if city else city
            region = current_region
            if not region:
                region = CITY_TO_REGION.get(city, None)
            if not region:
                region = await get_region_by_city(city)
            if region:
                message = f"–ë–ü–õ–ê \"{bpla_type}\" {city} ({region})"
                messages.append(message)
            continue
        
        # –§–æ—Ä–º–∞—Ç: ‚Üí–ú—ñ—Å—Ç–æ1/–ú—ñ—Å—Ç–æ2 –∞–±–æ ‚Üí–ú—ñ—Å—Ç–æ1/–ú—ñ—Å—Ç–æ2(N—Ö) –∞–±–æ ‚Üí–ú—ñ—Å—Ç–æ/—Ä-–Ω
        # –ü—Ä–∏–∫–ª–∞–¥–∏: ‚Üí–î–Ω—ñ–ø—Ä–æ/–ö–∞–º º—è–Ω—Å—å–∫–µ ‚Üí "–ë–ü–õ–ê –î–Ω—ñ–ø—Ä–æ –∫—É—Ä—Å–æ–º –Ω–∞ –ö–∞–º º—è–Ω—Å—å–∫–µ"
        #           ‚Üí–ö—Ä–æ–ª–µ–≤–µ—Ü—å/–ß–µ—Ä–Ω—ñ–≥—ñ–≤—â–∏–Ω–∞(2—Ö) ‚Üí "2—Ö –ë–ü–õ–ê –ö—Ä–æ–ª–µ–≤–µ—Ü—å –∫—É—Ä—Å–æ–º –Ω–∞ –ß–µ—Ä–Ω—ñ–≥—ñ–≤—â–∏–Ω—É"
        #           ‚Üí–•–º–µ–ª—å–Ω–∏—Ü—å–∫–∏–π/—Ä-–Ω ‚Üí "–ë–ü–õ–ê –•–º–µ–ª—å–Ω–∏—Ü—å–∫–∏–π —Ä–∞–π–æ–Ω"
        arrow_match = re.match(r'^[‚Üí‚û°Ô∏è]\s*(.+?)\s*[\.;]?$', line)
        if arrow_match and current_region:
            content = arrow_match.group(1).strip()
            
            # –í–∏—Ç—è–≥—É—î–º–æ –∫—ñ–ª—å–∫—ñ—Å—Ç—å –∑ –¥—É–∂–æ–∫ (7—Ö), (3—Ö) —Ç–æ—â–æ
            quantity = ''
            quantity_match = re.search(r'\((\d+)—Ö?\)', content)
            if quantity_match:
                quantity = quantity_match.group(1) + '—Ö '
                content = re.sub(r'\s*\(\d+—Ö?\)', '', content)
            
            # –í–∏–¥–∞–ª—è—î–º–æ –∫—Ä–∞–ø–∫–∏ —Ç–∞ –∫—Ä–∞–ø–∫–∏ –∑ –∫–æ–º–æ—é –≤ –∫—ñ–Ω—Ü—ñ
            content = content.rstrip('.;')
            
            # –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ —î / –≤ —Ä—è–¥–∫—É
            if '/' in content:
                parts = content.split('/')
                city1 = parts[0].strip()
                city2 = parts[1].strip() if len(parts) > 1 else ''
                
                # –í–∏–ø—Ä–∞–≤–ª—è—î–º–æ –≤—ñ–¥–º—ñ–Ω–∫–∏
                city1 = fix_city_case(city1)
                city1 = city1[0].upper() + city1[1:] if city1 else city1
                
                # –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —â–æ —Ç–∞–∫–µ city2
                if city2.lower() in ['—Ä-–Ω', '—Ä–∞–π–æ–Ω', '–æ–∫–æ–ª–∏—Ü—ñ', '–æ–∫–æ–ª–∏—Ü']:
                    # ‚Üí–•–º–µ–ª—å–Ω–∏—Ü—å–∫–∏–π/—Ä-–Ω ‚Üí "–ë–ü–õ–ê –•–º–µ–ª—å–Ω–∏—Ü—å–∫–∏–π —Ä–∞–π–æ–Ω"
                    message = f"{quantity}–ë–ü–õ–ê {city1} —Ä–∞–π–æ–Ω ({current_region})"
                    messages.append(message)
                elif city2 in REGION_MAP or any(rk.lower() in city2.lower() for rk in REGION_MAP.keys()):
                    # ‚Üí–ö—Ä–æ–ª–µ–≤–µ—Ü—å/–ß–µ—Ä–Ω—ñ–≥—ñ–≤—â–∏–Ω–∞ ‚Üí –∫—É—Ä—Å–æ–º –Ω–∞ —ñ–Ω—à—É –æ–±–ª–∞—Å—Ç—å (–ë–ï–ó –ø–æ—Ç–æ—á–Ω–æ—ó –æ–±–ª–∞—Å—Ç—ñ –≤ –¥—É–∂–∫–∞—Ö)
                    message = f"{quantity}–ë–ü–õ–ê {city1} –∫—É—Ä—Å–æ–º –Ω–∞ {city2}."
                    messages.append(message)
                else:
                    # ‚Üí–î–Ω—ñ–ø—Ä–æ/–ö–∞–º º—è–Ω—Å—å–∫–µ ‚Üí –¥–≤–∞ –º—ñ—Å—Ç–∞, –ú—ñ—Å—Ç–æ1 –∫—É—Ä—Å–æ–º –Ω–∞ –ú—ñ—Å—Ç–æ2
                    city2 = fix_city_case(city2)
                    city2 = city2[0].upper() + city2[1:] if city2 else city2
                    message = f"{quantity}–ë–ü–õ–ê {city1} –∫—É—Ä—Å–æ–º –Ω–∞ {city2} ({current_region})"
                    messages.append(message)
            else:
                # –ü—Ä–æ—Å—Ç–æ –æ–¥–Ω–µ –º—ñ—Å—Ç–æ: ‚Üí–í–∞—Å–∏–ª—å–∫—ñ–≤–∫–∞
                city = fix_city_case(content)
                city = city[0].upper() + city[1:] if city else city
                message = f"{quantity}–ë–ü–õ–ê {city} ({current_region})"
                messages.append(message)
            continue
        
        # –§–æ—Ä–º–∞—Ç: üí• –ü–∞–≤–ª–æ–≥—Ä–∞–¥/–æ–∫–æ–ª–∏—Ü—ñ - —â–µ –≤–∏–±—É—Ö–∏. –∞–±–æ üí•–ö–æ—Ä–æ—Å—Ç–µ–Ω—å/—Ä-–Ω (–ñ–∏—Ç–æ–º–∏—Ä—â–∏–Ωa) - –≤–∏–±—É—Ö–∏.
        explosion_match = re.match(r'^[üí•üî•]\s*(.+?)(?:/(?:–æ–∫–æ–ª–∏—Ü[—ñ–∏]|—Ä-–Ω|—Ä–∞–π–æ–Ω))?\s*(?:\((.+?)\))?\s*[-‚Äì‚Äî]\s*(.+)$', line)
        if explosion_match:
            city = explosion_match.group(1).strip()
            region_in_parens = explosion_match.group(2)
            
            # –í–∏–¥–∞–ª—è—î–º–æ –∑–∞–π–≤–µ –∑ –Ω–∞–∑–≤–∏ –º—ñ—Å—Ç–∞
            city = city.rstrip('/')
            city = fix_city_case(city)
            city = city[0].upper() + city[1:] if city else city
            
            # –í–∏–∑–Ω–∞—á–∞—î–º–æ –æ–±–ª–∞—Å—Ç—å
            if region_in_parens:
                # –ù–æ—Ä–º–∞–ª—ñ–∑—É—î–º–æ (–ñ–∏—Ç–æ–º–∏—Ä—â–∏–Ωa -> –ñ–∏—Ç–æ–º–∏—Ä—â–∏–Ω–∞)
                region_in_parens = region_in_parens.strip()
                region = REGION_MAP.get(region_in_parens, None)
                if not region:
                    # –ü—Ä–æ–±—É—î–º–æ –∑–Ω–∞–π—Ç–∏ —Å—Ö–æ–∂—É –Ω–∞–∑–≤—É
                    for region_key in REGION_MAP.keys():
                        if region_key.lower()[:5] in region_in_parens.lower():
                            region = REGION_MAP[region_key]
                            break
                if not region:
                    region = current_region
            else:
                region = current_region
                if not region:
                    region = await get_region_by_city(city)
            
            if region:
                msg = f"–ë–ü–õ–ê {city} ({region})"
                messages.append(msg)
            continue
        
        # –§–æ—Ä–º–∞—Ç: ‚ö†Ô∏è–ë–ø–õ–ê –∫—É—Ä—Å–æ–º –Ω–∞ –•–∞—Ä–∫—ñ–≤ –∞–±–æ ‚ö†Ô∏è2—Ö –ë–ø–õ–ê –∫—É—Ä—Å–æ–º –Ω–∞ –ö—Ä–∏–≤–∏–π –†—ñ–≥ –∞–±–æ –ë–ø–õ–ê –∫—É—Ä—Å–æ–º –Ω–∞ –ü º—è—Ç–∏—Ö–∞—Ç–∫–∏
        bpla_kursom_match = re.match(r'^[‚ö†Ô∏è‚ùóÔ∏èüî¥\s]*(\d*—Ö?\s*)?(–ë–ø–õ–ê|–ë–ü–õ–ê)\s+–∫—É—Ä—Å–æ–º\s+–Ω–∞\s+(.+?)\s*$', line, re.IGNORECASE)
        if bpla_kursom_match:
            city = await split_cities(bpla_kursom_match.group(3).strip())
            # –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ current_region –∞–±–æ –≥–µ–æ–∫–æ–¥–∏–Ω–≥
            region = current_region
            if not region:
                region = await get_region_by_city(city)
            if region:
                msg = f"–ë–ü–õ–ê {city} ({region})"
                messages.append(msg)
            continue
        
        # –§–æ—Ä–º–∞—Ç: 3—Ö –ë–ø–õ–ê –º–∞–Ω–µ–≤—Ä—É—é—Ç—å –ø—ñ–≤–¥–µ–Ω–Ω—ñ—à–µ –ó–µ–ª–µ–Ω–æ–¥–æ–ª—å—Å—å–∫–∞
        manevruyut_match = re.match(r'^[‚ö†Ô∏è‚ùóÔ∏èüî¥\s]*(\d*—Ö?\s*)?(–ë–ø–õ–ê|–ë–ü–õ–ê)\s+–º–∞–Ω–µ–≤—Ä—É—é—Ç—å\s+(?:–ø—ñ–≤–¥–µ–Ω–Ω—ñ—à–µ|–ø—ñ–≤–Ω—ñ—á–Ω—ñ—à–µ|–∑–∞—Ö—ñ–¥–Ω—ñ—à–µ|—Å—Ö—ñ–¥–Ω—ñ—à–µ|–±—ñ–ª—è|–≤ —Ä–∞–π–æ–Ω—ñ)\s+(.+?)\s*$', line, re.IGNORECASE)
        if manevruyut_match:
            city = await split_cities(manevruyut_match.group(3).strip())
            region = current_region
            if not region:
                region = await get_region_by_city(city)
            if region:
                msg = f"–ë–ü–õ–ê {city} ({region})"
                messages.append(msg)
            continue
        
        # –ü–∞—Ä—Å–∏–º–æ —Ä—è–¥–∫–∏ –∑ –ë–ø–õ–ê/—à–∞—Ö–µ–¥–∞–º–∏
        if any(keyword in line.lower() for keyword in ['–±–ø–ª–∞', '—à–∞—Ö–µ–¥', '—à–∞—Ö—ñ–¥']):
            # –í–∏—Ç—è–≥—É—î–º–æ –∫—ñ–ª—å–∫—ñ—Å—Ç—å —Ç–∞ —Ç–µ–∫—Å—Ç
            # –§–æ—Ä–º–∞—Ç–∏: "2 —à–∞—Ö–µ–¥–∏ –Ω–∞ –ß–µ—Ä–Ω—ñ–≥—ñ–≤", "2—Ö –ë–ø–õ–ê –∫—É—Ä—Å–æ–º –Ω–∞ –ö–∏—ó–≤", "–ë–ø–õ–ê –Ω–∞ –•–∞—Ä–∫—ñ–≤", "4 —à–∞—Ö–µ–¥–∏ —á–µ—Ä–µ–∑ –ö–∞–∑–∞–Ω–∫—É –≤ –±—ñ–∫ –ö—ñ—Ä–æ–≤–æ–≥—Ä–∞–¥—â–∏–Ω–∏"
            
            # –°–ø—Ä–æ–±–∞ 1: "—á–∏—Å–ª–æ + —à–∞—Ö–µ–¥/—à–∞—Ö–µ–¥—ñ–≤/—à–∞—Ö–µ–¥–∏ + —á–µ—Ä–µ–∑ + –º—ñ—Å—Ç–æ + –≤ –±—ñ–∫ + –æ–±–ª–∞—Å—Ç—å"
            match = re.match(r'(\d+)\s*(—à–∞—Ö–µ–¥[—ñ–∏—ñ–≤]*|–ë–ø–õ–ê|–ë–ü–õ–ê)\s+—á–µ—Ä–µ–∑\s+(.+?)\s+–≤\s+–±—ñ–∫\s+(.+)$', line, re.IGNORECASE)
            if match:
                city = match.group(3).strip()
                short_region = match.group(4).strip()
                region = REGION_MAP.get(short_region, current_region)
                if region:
                    msg = f"–ë–ü–õ–ê {city} ({region})"
                    messages.append(msg)
                continue
            
            # –°–ø—Ä–æ–±–∞ 2: "—á–∏—Å–ª–æ + —à–∞—Ö–µ–¥ + –∫—Ä—É–∂–ª—è—î –±—ñ–ª—è/–≤ —Ä–∞–π–æ–Ω—ñ + –º—ñ—Å—Ç–æ" (1 —à–∞—Ö–µ–¥ –∫—Ä—É–∂–ª—è—î –±—ñ–ª—è –ü—ñ–≤–¥–µ–Ω–Ω–æ—É–∫—Ä–∞—ó–Ω—Å—å–∫–∞)
            match = re.match(r'(\d+)\s*(—à–∞—Ö–µ–¥[—ñ–∏—ñ–≤]*|–ë–ø–õ–ê|–ë–ü–õ–ê)\s+–∫—Ä—É–∂–ª—è—î\s+(?:–±—ñ–ª—è|–≤ —Ä–∞–π–æ–Ω—ñ)\s+(.+)$', line, re.IGNORECASE)
            if match:
                city = await split_cities(match.group(3).strip())
                region = current_region
                if not region:
                    region = await get_region_by_city(city)
                if region:
                    msg = f"–ë–ü–õ–ê {city} ({region})"
                    messages.append(msg)
                continue
            
            # –°–ø—Ä–æ–±–∞ 3: "—á–∏—Å–ª–æ + —à–∞—Ö–µ–¥ + –∑ + –æ–±–ª–∞—Å—Ç—å + –Ω–∞ + –º—ñ—Å—Ç–æ" (1 —à–∞—Ö–µ–¥ –∑ –°—É–º—â–∏–Ω–∏ –Ω–∞ –¢–∞–ª–∞–ª–∞—ó–≤–∫—É)
            match = re.match(r'(\d+)\s*(—à–∞—Ö–µ–¥[—ñ–∏—ñ–≤]*|–ë–ø–õ–ê|–ë–ü–õ–ê)\s+–∑\s+\S+\s+–Ω–∞\s+(.+)$', line, re.IGNORECASE)
            if match:
                city = await split_cities(match.group(3).strip())
                region = current_region
                if not region:
                    region = await get_region_by_city(city)
                if region:
                    msg = f"–ë–ü–õ–ê {city} ({region})"
                    messages.append(msg)
                continue
            
            # –°–ø—Ä–æ–±–∞ 4: "—á–∏—Å–ª–æ + —à–∞—Ö–µ–¥/—à–∞—Ö–µ–¥—ñ–≤/—à–∞—Ö–µ–¥–∏ + –Ω–∞ + –º—ñ—Å—Ç–æ" (1 —à–∞—Ö–µ–¥ –Ω–∞ –ë–µ—Ä–µ–∑–Ω–µ–≥—É–≤–∞—Ç–µ)
            match = re.match(r'(\d+)\s*(—à–∞—Ö–µ–¥[—ñ–∏—ñ–≤]*|–ë–ø–õ–ê|–ë–ü–õ–ê)\s+(?:–∫—É—Ä—Å–æ–º\s+)?–Ω–∞\s+(.+)$', line, re.IGNORECASE)
            if match:
                city = match.group(3).strip()
                # –í–∏–¥–∞–ª—è—î–º–æ "—Å." –Ω–∞ –ø–æ—á–∞—Ç–∫—É (—Å.–†—ñ–≤–Ω–µ -> –†—ñ–≤–Ω–µ)
                city = re.sub(r'^—Å\.', '', city).strip()
                city = await split_cities(city)
                region = current_region
                if not region:
                    region = await get_region_by_city(city)
                if region:
                    msg = f"–ë–ü–õ–ê {city} ({region})"
                    messages.append(msg)
                continue
            
            # –°–ø—Ä–æ–±–∞ 4: "—á–∏—Å–ª–æ—Ö –ë–ø–õ–ê –Ω–∞ –º—ñ—Å—Ç–æ"
            match = re.match(r'(\d+)—Ö?\s*(–ë–ø–õ–ê|–ë–ü–õ–ê)\s*(?:–∫—É—Ä—Å–æ–º\s+)?(?:–Ω–∞\s+)?(.+)$', line, re.IGNORECASE)
            if match:
                city = match.group(3).strip()
                city = re.sub(r'\s*–∫—É—Ä—Å–æ–º.*$', '', city)
                city = re.sub(r'\s*–∑\s+.*$', '', city)
                city = await split_cities(city.strip())
                region = current_region
                if not region:
                    region = await get_region_by_city(city)
                if city and region:
                    msg = f"–ë–ü–õ–ê {city} ({region})"
                    messages.append(msg)
                continue
            
            # –°–ø—Ä–æ–±–∞ 5: "–ë–ø–õ–ê –Ω–∞ –º—ñ—Å—Ç–æ" (–±–µ–∑ —á–∏—Å–ª–∞)
            match = re.match(r'(–ë–ø–õ–ê|–ë–ü–õ–ê)\s*(?:–∫—É—Ä—Å–æ–º\s+)?(?:–Ω–∞\s+)?(.+)$', line, re.IGNORECASE)
            if match:
                city = match.group(2).strip()
                city = re.sub(r'\s*–∫—É—Ä—Å–æ–º.*$', '', city)
                city = re.sub(r'\s*–∑\s+.*$', '', city)
                city = await split_cities(city.strip())
                region = current_region
                if not region:
                    region = await get_region_by_city(city)
                if city and region:
                    msg = f"–ë–ü–õ–ê {city} ({region})"
                    messages.append(msg)
                continue
    
    # –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ –∑–Ω–∞–π–¥–µ–Ω—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
    return messages


async def ensure_connected():
    """–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Ç–∞ –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è –∑'—î–¥–Ω–∞–Ω–Ω—è"""
    if not client.is_connected():
        logger.info("üîÑ –ü–µ—Ä–µ–ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ Telegram...")
        try:
            await client.connect()
            if await client.is_user_authorized():
                logger.info("‚úÖ –ü–µ—Ä–µ–ø—ñ–¥–∫–ª—é—á–µ–Ω–æ —É—Å–ø—ñ—à–Ω–æ")
                return True
            else:
                logger.error("‚ùå –°–µ—Å—ñ—è –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–∞")
                return False
        except Exception as e:
            logger.error(f"‚ùå –ü–æ–º–∏–ª–∫–∞ –ø–µ—Ä–µ–ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è: {e}")
            return False
    return True


async def check_and_forward():
    """–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–æ–≤–∏—Ö –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å —Ç–∞ –ø–µ—Ä–µ—Å–∏–ª–∞–Ω–Ω—è"""
    
    # –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –∑'—î–¥–Ω–∞–Ω–Ω—è –ø–µ—Ä–µ–¥ –∫–æ–∂–Ω–æ—é –ø–µ—Ä–µ–≤—ñ—Ä–∫–æ—é
    if not await ensure_connected():
        return
    forwarded_count = 0
    
    for channel in SOURCE_CHANNELS:
        channel = channel.strip()
        if not channel:
            continue
            
        try:
            entity = await client.get_entity(channel)
            
            # –û—Ç—Ä–∏–º—É—î–º–æ –æ—Å—Ç–∞–Ω–Ω—î –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
            async for message in client.iter_messages(entity, limit=1):
                # –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ –≤–∂–µ –ø–µ—Ä–µ—Å–∏–ª–∞–ª–∏ —Ü–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
                if channel not in last_message_ids:
                    # –ü–µ—Ä—à–∏–π –∑–∞–ø—É—Å–∫ - –∑–±–µ—Ä—ñ–≥–∞—î–º–æ ID —ñ –ø—Ä–æ–ø—É—Å–∫–∞—î–º–æ
                    last_message_ids[channel] = message.id
                    logger.info(f"üìå {channel}: –∑–±–µ—Ä–µ–∂–µ–Ω–æ –ø–æ—á–∞—Ç–∫–æ–≤–∏–π ID {message.id}")
                    continue
                
                if message.id > last_message_ids[channel]:
                    # –ù–æ–≤–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è!
                    logger.info(f"üÜï –ù–æ–≤–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤ @{channel}: ID {message.id}")
                    
                    # –†–æ–∑–±–∏–≤–∞—î–º–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –Ω–∞ –æ–∫—Ä–µ–º—ñ
                    split_messages = await parse_and_split_message(message.text)
                    
                    # –ü—Ä–æ–ø—É—Å–∫–∞—î–º–æ —è–∫—â–æ –Ω–µ–º–∞—î –≤–∞–ª—ñ–¥–Ω–∏—Ö –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å
                    if not split_messages or (len(split_messages) == 1 and not split_messages[0]):
                        logger.info(f"‚è≠Ô∏è –ü—Ä–æ–ø—É—â–µ–Ω–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –±–µ–∑ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∏—Ö –ª–æ–∫–∞—Ü—ñ–π")
                        last_message_ids[channel] = message.id
                        continue
                    
                    # –ü–µ—Ä–µ—Å–∏–ª–∞—î–º–æ –∫–æ–∂–Ω–µ –æ–∫—Ä–µ–º–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
                    try:
                        sent_count = 0
                        for split_msg in split_messages:
                            if not split_msg or not split_msg.strip():
                                continue
                            
                            # –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –Ω–∞ –¥—É–±–ª—ñ–∫–∞—Ç
                            if is_duplicate(split_msg):
                                continue
                                
                            if message.media:
                                # –Ø–∫—â–æ —î –º–µ–¥—ñ–∞, –≤—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ —Ç—ñ–ª—å–∫–∏ –∑ –ø–µ—Ä—à–∏–º –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è–º
                                if split_msg == split_messages[0]:
                                    await client.send_message(
                                        TARGET_CHANNEL,
                                        split_msg,
                                        file=message.media
                                    )
                                else:
                                    await client.send_message(
                                        TARGET_CHANNEL,
                                        split_msg
                                    )
                            else:
                                await client.send_message(
                                    TARGET_CHANNEL,
                                    split_msg
                                )
                            
                            # –ü–æ–∑–Ω–∞—á–∞—î–º–æ —è–∫ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–µ
                            mark_as_sent(split_msg)
                            sent_count += 1
                            
                            # –ù–µ–≤–µ–ª–∏–∫–∞ –∑–∞—Ç—Ä–∏–º–∫–∞ –º—ñ–∂ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è–º–∏
                            await asyncio.sleep(0.5)
                        
                        # –û–Ω–æ–≤–ª—é—î–º–æ ID
                        last_message_ids[channel] = message.id
                        if sent_count > 0:
                            forwarded_count += 1
                            logger.info(f"‚úÖ –ü–µ—Ä–µ—Å–ª–∞–Ω–æ {sent_count} –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å –∑ @{channel} –≤ @{TARGET_CHANNEL}")
                        
                    except Exception as e:
                        logger.error(f"‚ùå –ü–æ–º–∏–ª–∫–∞ –ø–µ—Ä–µ—Å–∏–ª–∞–Ω–Ω—è –∑ @{channel}: {e}")
                
        except Exception as e:
            logger.error(f"‚ùå –ü–æ–º–∏–ª–∫–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ @{channel}: {e}")
    
    if forwarded_count > 0:
        logger.info(f"üìä –ü–µ—Ä–µ—Å–ª–∞–Ω–æ {forwarded_count} –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å")


async def main():
    """–ì–æ–ª–æ–≤–Ω–∞ —Ñ—É–Ω–∫—Ü—ñ—è"""
    global last_kharkiv_message_id
    
    logger.info("üöÄ –ó–∞–ø—É—Å–∫ Channel Forwarder (Polling mode)...")
    
    # –ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –∑ session string (–±–µ–∑ phone)
    await client.connect()
    
    if not await client.is_user_authorized():
        logger.error("‚ùå –°–µ—Å—ñ—è –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–∞! –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ TELEGRAM_SESSION")
        return
    
    me = await client.get_me()
    logger.info(f"‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–æ: {me.first_name} ({me.phone})")
    
    # –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Ü—ñ–ª—å–æ–≤–æ–≥–æ –∫–∞–Ω–∞–ª—É
    try:
        target = await client.get_entity(TARGET_CHANNEL)
        logger.info(f"‚úÖ –¶—ñ–ª—å–æ–≤–∏–π –∫–∞–Ω–∞–ª: {target.title} (@{TARGET_CHANNEL})")
    except Exception as e:
        logger.error(f"‚ùå –ù–µ –≤–¥–∞–ª–æ—Å—è –∑–Ω–∞–π—Ç–∏ @{TARGET_CHANNEL}: {e}")
        return
    
    # –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –≤–∏—Ö—ñ–¥–Ω–∏—Ö –∫–∞–Ω–∞–ª—ñ–≤
    valid_sources = []
    for channel in SOURCE_CHANNELS:
        channel = channel.strip()
        if not channel:
            continue
        try:
            entity = await client.get_entity(channel)
            valid_sources.append(channel)
            logger.info(f"‚úÖ –í–∏—Ö—ñ–¥–Ω–∏–π –∫–∞–Ω–∞–ª: {entity.title} (@{channel})")
        except Exception as e:
            logger.warning(f"‚ö†Ô∏è –ù–µ –≤–¥–∞–ª–æ—Å—è –∑–Ω–∞–π—Ç–∏ @{channel}: {e}")
    
    # –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∫–∞–Ω–∞–ª—É –•–∞—Ä–∫—ñ–≤—â–∏–Ω–∏
    kharkiv_enabled = False
    try:
        kharkiv_entity = await client.get_entity(KHARKIV_CHANNEL)
        # –û—Ç—Ä–∏–º—É—î–º–æ ID –æ—Å—Ç–∞–Ω–Ω—å–æ–≥–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
        kharkiv_messages = await client.get_messages(kharkiv_entity, limit=1)
        if kharkiv_messages:
            last_kharkiv_message_id = kharkiv_messages[0].id
        kharkiv_enabled = True
        logger.info(f"‚úÖ –ö–∞–Ω–∞–ª –•–∞—Ä–∫—ñ–≤—â–∏–Ω–∏: {kharkiv_entity.title} (@{KHARKIV_CHANNEL})")
    except Exception as e:
        logger.warning(f"‚ö†Ô∏è –ù–µ –≤–¥–∞–ª–æ—Å—è –∑–Ω–∞–π—Ç–∏ @{KHARKIV_CHANNEL}: {e}")
    
    if not valid_sources and not kharkiv_enabled:
        logger.error("‚ùå –ñ–æ–¥–Ω–æ–≥–æ –∫–∞–Ω–∞–ª—É –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ!")
        return
    
    total_channels = len(valid_sources) + (1 if kharkiv_enabled else 0)
    logger.info(f"\nüìä –ú–æ–Ω—ñ—Ç–æ—Ä—é {total_channels} –∫–∞–Ω–∞–ª—ñ–≤")
    logger.info(f"‚è±Ô∏è  –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∫–æ–∂–Ω—ñ {POLL_INTERVAL} —Å–µ–∫—É–Ω–¥")
    logger.info(f"üéØ –ü–µ—Ä–µ—Å–∏–ª–∞–Ω–Ω—è –≤ @{TARGET_CHANNEL}\n")
    
    # –ì–æ–ª–æ–≤–Ω–∏–π —Ü–∏–∫–ª –æ–ø–∏—Ç—É–≤–∞–Ω–Ω—è
    while True:
        try:
            await check_and_forward()
            # –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –∫–∞–Ω–∞–ª –•–∞—Ä–∫—ñ–≤—â–∏–Ω–∏ –ø–∞—Ä–∞–ª–µ–ª—å–Ω–æ
            if kharkiv_enabled:
                await check_kharkiv_channel(target)
            await asyncio.sleep(POLL_INTERVAL)
        except KeyboardInterrupt:
            break
        except Exception as e:
            logger.error(f"‚ùå –ü–æ–º–∏–ª–∫–∞ –≤ —Ü–∏–∫–ª—ñ: {e}")
            await asyncio.sleep(POLL_INTERVAL)


if __name__ == '__main__':
    try:
        asyncio.run(main())
    except KeyboardInterrupt:
        logger.info("\n\n‚èπÔ∏è –ë–æ—Ç –∑—É–ø–∏–Ω–µ–Ω–æ")
    except Exception as e:
        logger.error(f"\n\n‚ùå –ö—Ä–∏—Ç–∏—á–Ω–∞ –ø–æ–º–∏–ª–∫–∞: {e}")
        raise
