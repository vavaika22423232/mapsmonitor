"""
Centralized precompiled regex patterns.
All patterns compiled ONCE at import time for performance.
"""
import re
from typing import Pattern, Dict, Optional

# Compile flags
_FLAGS = re.IGNORECASE | re.UNICODE


def _compile(pattern: str, flags: int = _FLAGS) -> Pattern:
    """Compile regex with standard flags."""
    return re.compile(pattern, flags)


class PatternGroup:
    """Group of related patterns for a threat type."""
    
    def __init__(self, patterns: Dict[str, Pattern]):
        self._patterns = patterns
    
    def match_any(self, text: str) -> Optional[re.Match]:
        """Try all patterns, return first match."""
        for pattern in self._patterns.values():
            m = pattern.search(text)
            if m:
                return m
        return None
    
    def match_all(self, text: str) -> list:
        """Return all matches from all patterns."""
        matches = []
        for name, pattern in self._patterns.items():
            for m in pattern.finditer(text):
                matches.append((name, m))
        return matches
    
    def __getitem__(self, key: str) -> Pattern:
        return self._patterns[key]
    
    def __contains__(self, key: str) -> bool:
        return key in self._patterns


# ============================================================================
# CLEANING PATTERNS
# ============================================================================
CLEAN = PatternGroup({
    'markdown': _compile(r'\*\*|__|~~'),
    'urls': _compile(r'https?://[^\s]+'),
    'usernames': _compile(r'@\w+'),
    'emoji_only_line': _compile(r'^[‚û°Ô∏è‚¨ÖÔ∏è‚ÜóÔ∏è‚ÜòÔ∏è‚ÜñÔ∏è‚ÜôÔ∏è‚¨ÜÔ∏è‚¨áÔ∏èüá∫üá¶\s|]+$'),
    'skip_keywords': _compile(r'–ü—ñ–¥–ø–∏—Å–∞—Ç–∏—Å—è|–ü–ü–û—à–Ω–∏–∫|–ú–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥ 24/7|–†–∞–¥–∞—Ä –£–∫—Ä–∞—ó–Ω–∏'),
})


# ============================================================================
# THREAT TYPE DETECTION
# ============================================================================
THREAT_TYPE = PatternGroup({
    'bpla': _compile(r'(?:–ë–ø–õ–ê|–ë–ü–õ–ê|—à–∞—Ö–µ–¥|–≥–µ—Ä–∞–Ω—å|–º–æ–ø–µ–¥|–±–∞–ª–∞–ª–∞–π–∫|drone)', _FLAGS),
    'rocket': _compile(r'(?:—Ä–∞–∫–µ—Ç|–∫–∞–ª—ñ–±—Ä|–∫—Ä–∏–ª–∞—Ç)', _FLAGS),
    'kab': _compile(r'(?:–ö–ê–ë|–∫–∞–±—ñ–≤|–±–æ–º–±)', _FLAGS),
    'ballistic': _compile(r'(?:–±–∞–ª—ñ—Å—Ç|iskander)', _FLAGS),
    'explosion': _compile(r'(?:–≤–∏–±—É—Ö|üí•)', _FLAGS),
})


# ==========================================================================
# LAUNCH DETECTION (BPLA LAUNCHES)
# ==========================================================================
LAUNCH = PatternGroup({
    'keywords': _compile(
        r'(?:–ø—É—Å–∫|–ø—É—Å–∫–∏|–∑–∞—Ñ—ñ–∫—Å–æ–≤–∞–Ω–æ\s+–ø—É—Å–∫–∏|—Ñ—ñ–∫—Å—É—é—Ç—å—Å—è\s+–ø—É—Å–∫–∏|–ø–æ–ø–µ—Ä–µ–¥–Ω—å–æ\s+—Ñ—ñ–∫—Å—É—é—Ç—å—Å—è\s+–ø—É—Å–∫–∏)',
        _FLAGS
    ),
    'source_location': _compile(
        r'(?:–∑|—ñ–∑)\s+(?:–∞–µ|–∞/–µ|–∞–µ—Ä–æ–¥—Ä–æ–º–∞|–∞–µ—Ä–æ–¥—Ä–æ–º—É)?\s*'
        r'([–ê-–Ø–Ü–á–Ñ“ê–∞-—è—ñ—ó—î“ë\'\-\s]+)',
        _FLAGS
    ),
    'plus_location': _compile(
        r'^[+‚Ä¢‚ñ™Ô∏è]\s*([–ê-–Ø–Ü–á–Ñ“ê–∞-—è—ñ—ó—î“ë\'\-\s]+)\s*$',
        _FLAGS
    )
})


# ============================================================================
# CITY + REGION EXTRACTION (UNIFIED)
# ============================================================================
LOCATION = PatternGroup({
    # Format: "City (Region –æ–±–ª.)" - most common, highest priority
    'city_region_parens': _compile(
        r'^[üí•üõ∏üõµ‚ö†Ô∏è‚ùóÔ∏èüî¥üöÄ‚úàÔ∏è\s]*'
        r'(?:–ë–ü–õ–ê\s+)?'
        r'(.+?)\s*'
        r'\(([^)]+–æ–±–ª\.?)\)'
    ),

    # Format: "City (Region alias)" without –æ–±–ª. keyword
    'city_region_alias_parens': _compile(
        r'^[üí•üõ∏üõµ‚ö†Ô∏è‚ùóÔ∏èüî¥üöÄ‚úàÔ∏è\s]*'
        r'(?:–ë–ü–õ–ê\s+)?'
        r'(.+?)\s*'
        r'\(([^)]+(?:—â–∏–Ω–∞|—á—á–∏–Ω–∞|–æ–±–ª–∞—Å—Ç—å|–æ–±–ª\.?))\)'
    ),
    
    # Format: "Region: city info" (e.g., "–•–∞—Ä–∫—ñ–≤—â–∏–Ω–∞: 2 –Ω–∞ –ë–æ–≥–æ–¥—É—Ö—ñ–≤")
    'region_colon_cities': _compile(
        r'^[üõµüõ∏‚úàÔ∏èüì°\s]*'
        r'(\S+(?:\s+–æ–±–ª–∞—Å—Ç—å)?):\s*'
        r'(.+)$'
    ),
    
    # Format: "N —à–∞—Ö–µ–¥—ñ–≤/–ë–ø–õ–ê –Ω–∞ City" 
    'count_threat_na_city': _compile(
        r'[‚Ä¢‚ñ™Ô∏è\s]*'
        r'(\d+)\s*—Ö?\s*'
        r'(?:—à–∞—Ö–µ–¥[—ñ–∏—ñ–≤]*|–ë–ø–õ–ê|–ë–ü–õ–ê)\s+'
        r'(?:–∫—É—Ä—Å–æ–º\s+)?–Ω–∞\s+'
        r'([–ê-–Ø–Ü–á–Ñ“ê–∞-—è—ñ—ó—î“ë0-9\'\-\s/,]+)'
    ),

    # Format: "N –Ω–∞ City" (when region context is known)
    'count_na_city': _compile(
        r'[‚Ä¢‚ñ™Ô∏è\s]*'
        r'(\d+)\s*—Ö?\s*'
        r'(?:–∫—É—Ä—Å–æ–º\s+)?–Ω–∞\s+'
        r'([–ê-–Ø–Ü–á–Ñ“ê–∞-—è—ñ—ó—î“ë0-9\'\-\s/,]+)'
    ),

    # Format: "N City" (short form under region header)
    'count_city': _compile(
        r'[‚Ä¢‚ñ™Ô∏è\s]*'
        r'(\d+)\s*—Ö?\s*'
        r'([–ê-–Ø–Ü–á–Ñ“ê–∞-—è—ñ—ó—î“ë0-9\'\-\s/,]+)'
    ),

    # Format: "(–§—ñ–∫—Å—É—î—Ç—å—Å—è) –∫—É—Ä—Å–æ–º –Ω–∞ City"
    'kursom_na_city': _compile(
        r'(?:—Ñ—ñ–∫—Å—É—î—Ç—å—Å—è\s+)?–∫—É—Ä—Å(?:–æ–º)?\s+–Ω–∞\s+'
        r'([–ê-–Ø–Ü–á–Ñ“ê–∞-—è—ñ—ó—î“ë\'\-\s]+)'
    ),

    # Format: "—Ä—É—Ö–∞—î—Ç—å—Å—è/–ø—Ä—è–º—É—î/–ª–µ—Ç–∏—Ç—å –Ω–∞ City"
    'moves_to_city': _compile(
        r'(?:—Ä—É—Ö–∞—î(?:—Ç—å—Å—è|—é—Ç—å—Å—è)|–ø—Ä—è–º—É—î|–ø—Ä—è–º—É—é—Ç—å|–ª–µ—Ç–∏—Ç—å|–ª–µ—Ç—è—Ç—å|–π–¥–µ|–π–¥—É—Ç—å)\s+–Ω–∞\s+'
        r'([–ê-–Ø–Ü–á–Ñ“ê–∞-—è—ñ—ó—î“ë\'\-\s]+)'
    ),
    
    # Format: "–ë–ø–õ–ê –∫—É—Ä—Å–æ–º –Ω–∞ City"
    'bpla_kursom_na': _compile(
        r'(?:–ë–ø–õ–ê|–ë–ü–õ–ê|—à–∞—Ö–µ–¥[—ñ–∏—ñ–≤]*|–º–æ–ø–µ–¥|–±–∞–ª–∞–ª–∞–π–∫[–∞–∏]?|–ú–æ–ª–Ω—ñ—è)'
        r'(?:\s+—Ç–∏–ø—É\s+[^\n]+?)?\s+–∫—É—Ä—Å–æ–º\s+–Ω–∞\s+'
        r'([–ê-–Ø–Ü–á–Ñ“ê–∞-—è—ñ—ó—î“ë\'\-\s]+)'
    ),
    
    # Format: "N –≤ —Ä–∞–π–æ–Ω—ñ City"
    'n_v_rayoni': _compile(
        r'(\d+)\s+–≤\s+—Ä–∞–π–æ–Ω[—ñ—É]?\s+'
        r'([–ê-–Ø–Ü–á–Ñ“ê–∞-—è—ñ—ó—î“ë\'\-]+)'
    ),
    
    # Format: "‚ÜíCity" or "‚ÜíCity/—Ä-–Ω"
    'arrow_city': _compile(
        r'^[‚Üí‚û°Ô∏è]\s*'
        r'([–ê-–Ø–Ü–á–Ñ“ê–∞-—è—ñ—ó—î“ë\'\-\s/]+?)'
        r'(?:/(?:—Ä-–Ω|—Ä–∞–π–æ–Ω|–æ–∫–æ–ª–∏—Ü[—ñ–∏]))?\s*'
        r'(?:\(\d+—Ö?\))?\s*[.!?‚Ä¶]*\s*$'
    ),
    
    # Format: Explosion "City - –≤–∏–±—É—Ö–∏"
    'city_explosion': _compile(
        r'^[üí•‚ö†Ô∏è\s]*'
        r'([–ê-–Ø–Ü–á–Ñ“ê–∞-—è—ñ—ó—î“ë\'\-\s]+?)\s*'
        r'[-‚Äì‚Äî]\s*'
        r'(?:—á—É–ª–∏\s+)?–≤–∏–±—É—Ö'
    ),

    # Format: "–∫—Ä—É—Ç–∏—Ç—å—Å—è –±—ñ–ª—è City" / "–∫—Ä—É–∂–ª—è—î –ø–æ–±–ª–∏–∑—É City"
    'threat_bilya_city': _compile(
        r'(?:[‚Ä¢‚ñ™Ô∏è\s]*\d+\s*—Ö?\s*)?'
        r'(?:—à–∞—Ö–µ–¥[—ñ–∏—ñ–≤]*|–ë–ø–õ–ê|–ë–ü–õ–ê)?\s*'
        r'(?:–∫—Ä—É—Ç–∏—Ç—å—Å—è|–∫—Ä—É–∂–ª—è—î|–∫—Ä—É–∂–ª—è—é—Ç—å|–º–∞–Ω–µ–≤—Ä—É—î|–º–∞–Ω–µ–≤—Ä—É—é—Ç—å)\s+'
        r'(?:–±—ñ–ª—è|–ø–æ–±–ª–∏–∑—É)\s+'
        r'([–ê-–Ø–Ü–á–Ñ“ê–∞-—è—ñ—ó—î“ë\'\-\s]+)'
    ),

    # Format: "–≤ –±—ñ–∫ City" / "—É –±—ñ–∫ City"
    'v_bik_city': _compile(
        r'(?:–≤|—É)\s+–±—ñ–∫\s+'
        r'([–ê-–Ø–Ü–á–Ñ“ê–∞-—è—ñ—ó—î“ë\'\-\s]+)'
    ),

    # Format: "—à–∞—Ö–µ–¥ –Ω–∞–¥ City" / "–Ω–∞–¥ City"
    'threat_nad_city': _compile(
        r'(?:[‚Ä¢‚ñ™Ô∏è\s]*\d+\s*—Ö?\s*)?'
        r'(?:—à–∞—Ö–µ–¥[—ñ–∏—ñ–≤]*|–ë–ø–õ–ê|–ë–ü–õ–ê)?\s*'
        r'(?:–Ω–∞–¥|–Ω–∞–¥\s+–º—ñ—Å—Ç–æ–º)\s+'
        r'([–ê-–Ø–Ü–á–Ñ“ê–∞-—è—ñ—ó—î“ë\'\-\s]+)'
    ),

    # Format: "City - –¥–æ –≤–∞—Å —à–∞—Ö–µ–¥" / "City - –¥–æ –≤–∞—Å"
    'city_to_you': _compile(
        r'^([–ê-–Ø–Ü–á–Ñ“ê–∞-—è—ñ—ó—î“ë\'\-\s]+?)\s*'
        r'[-‚Äì‚Äî]\s*'
        r'(?:–¥–æ\s+–≤–∞—Å\s+)?(?:—à–∞—Ö–µ–¥|–ë–ø–õ–ê|–ë–ü–õ–ê)'
    ),

    # Format: "–ø–æ —à–∞—Ö–µ–¥—É –Ω–∞ City"
    'po_shahedu_na': _compile(
        r'(?:–ø–æ\s+)?—à–∞—Ö–µ–¥[—É—ã—É–∞—ñ–∏—ñ–≤]*\s+–Ω–∞\s+'
        r'([–ê-–Ø–Ü–á–Ñ“ê–∞-—è—ñ—ó—î“ë\'\-\s]+)'
    ),
    
    # Format: "–±–∞–ª–∞–ª–∞–π–∫–∞ –Ω–∞ City (Region)"
    'balalayka_na_city': _compile(
        r'\d+\s*(?:–Ω–æ–≤–∞?\s+)?–±–∞–ª–∞–ª–∞–π–∫[–∞–∏]?\s+'
        r'(?:–Ω–∞\s+|–ø—ñ–¥—Ö–æ–¥–∏—Ç—å\s+–¥–æ\s+)'
        r'([–ê-–Ø–Ü–á–Ñ“ê–∞-—è—ñ—ó—î“ë\'\-\s]+?)\s*'
        r'\(([^)]+)\)'
    ),
    
    # Format: Single city name (for context-aware parsing)
    'single_city': _compile(
        r'^([–ê-–Ø–Ü–á–Ñ“ê–∞-—è—ñ—ó—î“ë][–∞-—è—ñ—ó—î“ë\'\-]+)\.?\s*$'
    ),
})


# ============================================================================
# KAB-SPECIFIC PATTERNS
# ============================================================================
KAB = PatternGroup({
    # "–ó–∞–≥—Ä–æ–∑–∞ –∑–∞—Å—Ç–æ—Å—É–≤–∞–Ω–Ω—è –ö–ê–ë—ñ–≤"
    'zagroza_kab': _compile(
        r'(.+?)\s*\((.+?–æ–±–ª\.?)\)\s*'
        r'–ó–∞–≥—Ä–æ–∑–∞\s+–∑–∞—Å—Ç–æ—Å—É–≤–∞–Ω–Ω—è\s+–ö–ê–ë—ñ–≤'
    ),
    
    # "–ê–≤—ñ–∞—Ü—ñ—è –∑–∞—Ö–æ–¥–∏—Ç—å –Ω–∞ –ø—É—Å–∫–∏ –ö–ê–ë –Ω–∞ City"
    'aviatsiya_kab': _compile(
        r'[–ê–∞]–≤—ñ–∞—Ü—ñ—è\s+–∑–∞—Ö–æ–¥–∏—Ç—å\s+–Ω–∞\s+'
        r'(?:–ø–æ–≤—Ç–æ—Ä–Ω—ñ\s+)?–ø—É—Å–∫–∏\s+–ö–ê–ë\s+'
        r'(?:–Ω–∞|–≤\s+–Ω–∞–ø—Ä—è–º–∫—É)\s+'
        r'([–ê-–Ø–Ü–á–Ñ“ê–∞-—è—ñ—ó—î“ë\'\-\s/]+)'
    ),
    
    # "üí£ District —Ä–∞–π–æ–Ω (Region)"
    'kab_rayon': _compile(
        r'üí£\s*(.+?)\s+—Ä–∞–π–æ–Ω\s*\((.+?–æ–±–ª\.?)\)'
    ),
})


# ============================================================================
# ROCKET/BALLISTIC PATTERNS
# ============================================================================
ROCKET = PatternGroup({
    # "–†–∞–∫–µ—Ç–∞ –∫—É—Ä—Å–æ–º –Ω–∞ City"
    'raketa_kursom': _compile(
        r'(?:–∫—Ä–∏–ª–∞—Ç[–∞—ñ]?\s+)?—Ä–∞–∫–µ—Ç[–∞–∏]?\s+'
        r'(?:–∫—É—Ä—Å–æ–º\s+)?(?:–Ω–∞|–≤\s+–Ω–∞–ø—Ä—è–º–∫—É)\s+'
        r'([–ê-–Ø–Ü–á–Ñ“ê–∞-—è—ñ—ó—î“ë\'\-\s]+)'
    ),
    
    # "–±–∞–ª–ª–∏—Å—Ç–∏–∫–∞ –Ω–∞ City"
    'ballistika_na': _compile(
        r'–±–∞–ª–ª?—ñ—Å—Ç–∏–∫–∞\s+–Ω–∞\s+'
        r'([–ê-–Ø–Ü–á–Ñ“ê–∞-—è—ñ—ó—î“ë\'\-\s]+)'
    ),
    
    # "–ó–∞–≥—Ä–æ–∑–∞ –∑–∞—Å—Ç–æ—Å—É–≤–∞–Ω–Ω—è –±–∞–ª—ñ—Å—Ç–∏—á–Ω–æ–≥–æ –æ–∑–±—Ä–æ—î–Ω–Ω—è"
    'zagroza_ballistyka': _compile(
        r'–∑–∞–≥—Ä–æ–∑–∞\s+(?:–∑–∞—Å—Ç–æ—Å—É–≤–∞–Ω–Ω—è\s+)?–±–∞–ª—ñ—Å—Ç–∏—á'
    ),
    
    # "–í—ñ–¥–±—ñ–π –∑–∞–≥—Ä–æ–∑–∏ –±–∞–ª—ñ—Å—Ç–∏–∫–∏"
    'vidbiy_ballistyka': _compile(
        r'–≤—ñ–¥–±—ñ–π\s+–∑–∞–≥—Ä–æ–∑[–∏—ñ]\s+(?:–∑–∞—Å—Ç–æ—Å—É–≤–∞–Ω–Ω—è\s+)?–±–∞–ª—ñ—Å—Ç–∏—á'
    ),
    
    # "–ó–∞–≥—Ä–æ–∑–∞ –≤–∏—Å–æ–∫–æ—à–≤–∏–¥–∫—ñ—Å–Ω–∏—Ö —Ü—ñ–ª–µ–π"
    'vysokoshvydkisni': _compile(
        r'(.+?)\s*\((.+?–æ–±–ª\.?)\)[\s\n]*'
        r'–ó–∞–≥—Ä–æ–∑–∞\s+–∑–∞—Å—Ç–æ—Å—É–≤–∞–Ω–Ω—è\s+–≤–∏—Å–æ–∫–æ—à–≤–∏–¥–∫—ñ—Å–Ω–∏—Ö\s+—Ü—ñ–ª–µ–π'
    ),
})


# ============================================================================
# REGION HEADER PATTERNS
# ============================================================================
REGION_HEADER = PatternGroup({
    # "–•–∞—Ä–∫—ñ–≤—â–∏–Ω–∞:" or "‚úàÔ∏è–î–Ω—ñ–ø—Ä–æ–ø–µ—Ç—Ä–æ–≤—â–∏–Ω–∞:"
    'region_header': _compile(
        r'^[‚úàÔ∏èüõµüõ∏‚ö†Ô∏è‚ùóÔ∏èüî¥üì°\s]*'
        r'(\S+(?:\s+–æ–±–ª–∞—Å—Ç—å)?):?\s*$'
    ),
    
    # "4 —à–∞—Ö–µ–¥–∏ –Ω–∞ –ß–µ—Ä–Ω—ñ–≥—ñ–≤—â–∏–Ω—ñ:"
    'count_na_region': _compile(
        r'^\d+\s+(?:—à–∞—Ö–µ–¥[—ñ–∏—ñ–≤]*|–ë–ø–õ–ê)\s+–Ω–∞\s+(\S+):?\s*$'
    ),
})


# ============================================================================
# QUANTITY EXTRACTION
# ============================================================================
QUANTITY = PatternGroup({
    'prefix_count': _compile(r'^(\d+)\s*—Ö?\s*'),
    'parens_count': _compile(r'\((\d+)—Ö?\)'),
})


# ============================================================================
# SKIP PATTERNS (messages to ignore)
# ============================================================================
SKIP = PatternGroup({
    'alerts': _compile(r'–ø–æ–≤—ñ—Ç—Ä—è–Ω–∞\s+—Ç—Ä–∏–≤–æ–≥–∞|–≤—ñ–¥–±—ñ–π\s+—Ç—Ä–∏–≤–æ–≥–∏'),
    'shelter': _compile(r'–ø—Ä—è–º—É–π—Ç–µ\s+–≤\s+—É–∫—Ä–∏—Ç—Ç—è|–ø–µ—Ä–µ–π–¥—ñ—Ç—å\s+–≤\s+—É–∫—Ä–∏—Ç—Ç—è'),
    'info_only': _compile(r'–ù–∞ –¥–∞–Ω–∏–π —á–∞—Å \d+ –ë–ü–õ–ê|–ê–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å —Ç–∞–∫—Ç–∏—á–Ω–æ—ó –∞–≤—ñ–∞—Ü—ñ—ó'),
})


# ============================================================================
# DIRECTION WORDS (to filter out from city names)
# ============================================================================
DIRECTION_WORDS = _compile(
    r'^(?:–∑–∞—Ö—ñ–¥–Ω|—Å—Ö—ñ–¥–Ω|–ø—ñ–≤–Ω—ñ—á–Ω|–ø—ñ–≤–¥–µ–Ω–Ω|–∑–∞—Ö—ñ–¥|—Å—Ö—ñ–¥|–ø—ñ–≤–Ω—ñ—á|–ø—ñ–≤–¥–µ–Ω—å)',
    _FLAGS
)


# ============================================================================
# AGGREGATED ACCESS
# ============================================================================
class Patterns:
    """Central access point for all pattern groups."""
    clean = CLEAN
    threat_type = THREAT_TYPE
    launch = LAUNCH
    location = LOCATION
    kab = KAB
    rocket = ROCKET
    region_header = REGION_HEADER
    quantity = QUANTITY
    skip = SKIP
    direction_words = DIRECTION_WORDS


PATTERNS = Patterns()
